(()=>{"use strict";var e={58794:(e,t,r)=>{r(23792),r(3362),r(69085),r(9391),r(44114),r(26099);var n=r(22856),s=r(74927),a=r.n(s),o=function(){var e=this,t=e._self._c;return t("div",{attrs:{id:"app"}},[e.isAuthenticated?t("el-header",{staticClass:"header"},[t("div",{staticClass:"header-left"},[t("h1",[e._v("Gnftato 防火墙管理系统")])]),t("div",{staticClass:"header-right"},[t("el-dropdown",{attrs:{trigger:"click"},on:{command:e.handleCommand}},[t("span",{staticClass:"user-dropdown"},[e._v(" "+e._s(e.currentUser.username)+" "),t("i",{staticClass:"el-icon-arrow-down el-icon--right"})]),t("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},[t("el-dropdown-item",{attrs:{command:"profile"}},[e._v("个人资料")]),t("el-dropdown-item",{attrs:{command:"logout"}},[e._v("退出登录")])],1)],1)],1)]):e._e(),t("router-view")],1)},c=[],i=r(7180),u=r(1910),l=r(42332),d=r.n(l);const p={name:"App",computed:(0,i.A)({},(0,u.L8)(["isAuthenticated","currentUser"])),methods:(0,i.A)((0,i.A)({},(0,u.i0)(["logout","getCurrentUser"])),{},{handleCommand:function(e){"logout"===e?this.handleLogout():"profile"===e&&this.$router.push("/profile")},handleLogout:function(){this.logout(),this.$router.push("/login"),this.$message.success("已退出登录")}}),created:function(){var e=localStorage.getItem("token");e&&(d().defaults.headers.common["Authorization"]="Bearer ".concat(e),this.getCurrentUser())}},v=p;var h=r(81656),m=(0,h.A)(v,o,c,!1,null,null,null);const f=m.exports;r(15086),r(18111),r(13579);var g=r(1594),b=function(){var e=this,t=e._self._c;return t("div",{staticClass:"home"},[t("div",{staticClass:"dashboard"},[t("el-card",{staticClass:"welcome-card"},[t("div",{attrs:{slot:"header"},slot:"header"},[t("h2",[e._v("欢迎使用Nftato防火墙管理面板")])]),t("div",{staticClass:"dashboard-content"},[t("p",[e._v("通过这个面板，您可以轻松管理多台服务器的nftables防火墙规则。")]),t("ul",[t("li",[e._v("封禁/解封垃圾邮件端口")]),t("li",[e._v("自定义封禁/解封出网端口")]),t("li",[e._v("管理入网端口白名单")]),t("li",[e._v("管理入网IP白名单")]),t("li",[e._v("管理DDOS防护规则")])]),t("el-button",{attrs:{type:"primary"},on:{click:function(t){return e.$router.push("/servers")}}},[e._v("开始管理服务器")])],1)])],1)])},x=[];const k={name:"HomeView"},I=k;var w=(0,h.A)(I,b,x,!1,null,"482b8d4c",null);const A=w.exports;r(74423),r(21699);var S=function(){var e=this,t=e._self._c;return t("div",{staticClass:"servers-container"},[t("div",{staticClass:"page-header"},[t("h1",[e._v("服务器管理")]),t("el-button",{attrs:{type:"primary"},on:{click:e.showAddServerDialog}},[e._v("添加服务器")])],1),e.isServerRestarted?t("el-alert",{staticStyle:{"margin-bottom":"15px"},attrs:{title:"检测到系统重启！",type:"warning",closable:!0,"show-icon":""}},[t("template",{slot:"title"},[t("span",{staticStyle:{"font-weight":"bold"}},[e._v("检测到系统重启！")])]),t("div",[e._v(" 服务器状态已重置，某些连接可能已断开。已自动同步所有状态为最新。 "),t("el-button",{staticStyle:{"margin-left":"10px"},attrs:{size:"mini",type:"primary",disabled:!e.hasOfflineServers},on:{click:e.batchConnect}},[e._v("重新连接所有服务器")])],1)],2):e._e(),0!==e.servers.length||e.loading?t("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticStyle:{width:"100%"},attrs:{data:e.servers,border:""}},[t("el-table-column",{attrs:{prop:"name",label:"服务器名称",width:"180"}}),t("el-table-column",{attrs:{prop:"host",label:"主机地址",width:"180"}}),t("el-table-column",{attrs:{prop:"port",label:"SSH端口",width:"100"}}),t("el-table-column",{attrs:{prop:"username",label:"用户名",width:"120"}}),t("el-table-column",{attrs:{prop:"status",label:"状态",width:"160"},scopedSlots:e._u([{key:"default",fn:function(r){return[t("div",{staticClass:"status-container"},[t("el-tag",{attrs:{type:e.getStatusTagType(r.row.status)}},[e._v(" "+e._s(e.statusText[r.row.status])+" ")]),t("el-button",{staticClass:"refresh-button",attrs:{type:"text",icon:"el-icon-refresh",circle:"",size:"mini",loading:e.checkingServers[r.row._id]},on:{click:function(t){return e.checkServerStatus(r.row)}}}),e.errorReasons[r.row._id]?t("el-popover",{attrs:{placement:"top-start",title:"错误详情",width:"300",trigger:"hover"}},[t("div",[t("p",[t("i",{staticClass:"el-icon-warning",staticStyle:{color:"#E6A23C"}}),e._v(" "+e._s(e.errorReasons[r.row._id]))]),t("el-divider"),t("p",[e._v("建议操作：")]),t("el-button",{attrs:{size:"mini",type:"primary"},on:{click:function(t){return e.handleReconnect(r.row)}}},[e._v("尝试重连")]),t("el-button",{attrs:{size:"mini"},on:{click:function(t){return e.checkServerStatus(r.row)}}},[e._v("刷新状态")]),t("el-button",{attrs:{size:"mini",type:"success"},on:{click:function(t){return e.handleConnectionRetry(r.row)}}},[e._v("强制同步状态")])],1),t("el-badge",{attrs:{slot:"reference","is-dot":"",type:"danger"},slot:"reference"})],1):e._e()],1),r.row.lastChecked?t("div",{staticClass:"status-time"},[e._v(" 上次检查: "+e._s(e.formatTime(r.row.lastChecked))+" ")]):e._e(),"error"===r.row.status&&e.errorReasons[r.row._id]&&e.errorReasons[r.row._id].includes("检查服务器日志")?t("div",{staticClass:"sync-warning"},[t("el-link",{attrs:{type:"warning"},on:{click:function(t){return e.handleConnectionRetry(r.row)}}},[t("i",{staticClass:"el-icon-warning-outline"}),e._v(" 前后端状态可能不同步，点击修复 ")])],1):e._e()]}}])}),t("el-table-column",{attrs:{label:"操作"},scopedSlots:e._u([{key:"default",fn:function(r){return[t("div",{staticClass:"operation-buttons"},[t("el-button",{attrs:{size:"mini",icon:"el-icon-edit"},on:{click:function(t){return e.handleEdit(r.row)}}},[e._v("编辑")]),"online"!==r.row.status&&"connecting"!==r.row.status&&"disconnecting"!==r.row.status?t("el-button",{attrs:{size:"mini",type:"success",loading:e.connectingServers[r.row._id],icon:"el-icon-connection"},on:{click:function(t){return e.handleConnect(r.row)}}},[e._v("连接")]):"online"===r.row.status?t("el-button",{attrs:{size:"mini",type:"warning",loading:e.disconnectingServers[r.row._id],icon:"el-icon-close"},on:{click:function(t){return e.handleDisconnect(r.row)}}},[e._v("断开")]):t("el-button",{attrs:{size:"mini",disabled:""}},[e._v(e._s(e.statusText[r.row.status]))]),"online"===r.row.status?t("el-button",{attrs:{size:"mini",type:"primary",icon:"el-icon-setting"},on:{click:function(t){return e.handleManageRules(r.row)}}},[e._v("管理规则")]):e._e(),t("el-button",{attrs:{size:"mini",type:"danger",icon:"el-icon-delete"},on:{click:function(t){return e.handleDelete(r.row)}}},[e._v("删除")])],1)]}}])})],1):t("div",{staticClass:"empty-state"},[t("el-empty",{attrs:{description:"暂无服务器","image-size":200}},[t("el-button",{attrs:{type:"primary"},on:{click:e.showAddServerDialog}},[e._v("添加您的第一台服务器")])],1)],1),e.servers.length>0?t("div",{staticClass:"batch-actions"},[t("el-card",{attrs:{shadow:"hover"}},[t("div",{staticClass:"clearfix",attrs:{slot:"header"},slot:"header"},[t("span",[t("i",{staticClass:"el-icon-s-operation"}),e._v(" 批量操作")])]),t("div",{staticClass:"batch-buttons"},[t("el-button",{attrs:{size:"small",type:"success",disabled:!e.hasOfflineServers,icon:"el-icon-connection"},on:{click:e.batchConnect}},[e._v("批量连接 "),e.hasOfflineServers?t("span",{staticClass:"count-badge"},[e._v("("+e._s(e.getOfflineCount())+")")]):e._e()]),t("el-button",{attrs:{size:"small",type:"warning",disabled:!e.hasOnlineServers,icon:"el-icon-close"},on:{click:e.batchDisconnect}},[e._v("批量断开 "),e.hasOnlineServers?t("span",{staticClass:"count-badge"},[e._v("("+e._s(e.getOnlineCount())+")")]):e._e()]),t("el-button",{attrs:{size:"small",type:"info",icon:"el-icon-refresh"},on:{click:e.checkAllServersStatus}},[e._v("刷新所有状态")])],1)])],1):e._e(),t("el-dialog",{attrs:{title:e.isEdit?"编辑服务器":"添加服务器",visible:e.dialogVisible,width:"50%"},on:{"update:visible":function(t){e.dialogVisible=t}}},[t("server-form",{ref:"serverForm",attrs:{"is-edit":e.isEdit,"server-data":e.currentServer},on:{submit:e.handleFormSubmit}}),t("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.dialogVisible=!1}}},[e._v("取消")]),e.isEdit?e._e():t("el-button",{attrs:{type:"primary"},on:{click:e.handleTestConnection}},[e._v("测试连接")]),t("el-button",{attrs:{type:"primary"},on:{click:function(t){return e.$refs.serverForm.submitForm()}}},[e._v("确定")])],1)],1)],1)},P=[],C=r(27262),$=r(47546),y=r(24634),_=(r(28706),r(2008),r(50113),r(48980),r(51629),r(62062),r(59089),r(60739),r(23288),r(62010),r(22489),r(20116),r(7588),r(61701),r(33110),r(79432),r(16034),r(47764),r(23500),r(62953),r(76031),function(){var e=this,t=e._self._c;return t("div",{staticClass:"server-form"},[t("el-form",{ref:"serverForm",attrs:{model:e.form,rules:e.rules,"label-width":"100px"}},[t("el-form-item",{attrs:{label:"服务器名称",prop:"name"}},[t("el-input",{attrs:{placeholder:"请输入服务器名称"},model:{value:e.form.name,callback:function(t){e.$set(e.form,"name",t)},expression:"form.name"}})],1),t("el-form-item",{attrs:{label:"主机地址",prop:"host"}},[t("el-input",{attrs:{placeholder:"请输入主机IP或域名"},model:{value:e.form.host,callback:function(t){e.$set(e.form,"host",t)},expression:"form.host"}})],1),t("el-form-item",{attrs:{label:"SSH端口",prop:"port"}},[t("el-input-number",{attrs:{min:1,max:65535,step:1},model:{value:e.form.port,callback:function(t){e.$set(e.form,"port",t)},expression:"form.port"}})],1),t("el-form-item",{attrs:{label:"用户名",prop:"username"}},[t("el-input",{attrs:{placeholder:"请输入用户名"},model:{value:e.form.username,callback:function(t){e.$set(e.form,"username",t)},expression:"form.username"}})],1),t("el-form-item",{attrs:{label:"认证方式",prop:"authType"}},[t("el-radio-group",{model:{value:e.form.authType,callback:function(t){e.$set(e.form,"authType",t)},expression:"form.authType"}},[t("el-radio",{attrs:{label:"password"}},[e._v("密码")]),t("el-radio",{attrs:{label:"privateKey"}},[e._v("密钥")])],1)],1),"password"===e.form.authType?t("el-form-item",{attrs:{label:"密码",prop:"password"}},[t("el-input",{attrs:{type:"password",placeholder:"请输入密码"},model:{value:e.form.password,callback:function(t){e.$set(e.form,"password",t)},expression:"form.password"}})],1):e._e(),"privateKey"===e.form.authType?t("el-form-item",{attrs:{label:"私钥",prop:"privateKey"}},[t("el-input",{attrs:{type:"textarea",rows:8,placeholder:"请输入私钥内容"},model:{value:e.form.privateKey,callback:function(t){e.$set(e.form,"privateKey",t)},expression:"form.privateKey"}})],1):e._e(),t("el-form-item",[t("el-button",{attrs:{type:"primary"},on:{click:e.submitForm}},[e._v(e._s(e.isEdit?"更新":"添加"))]),t("el-button",{on:{click:e.resetForm}},[e._v("重置")])],1)],1)],1)}),D=[];const T={name:"ServerForm",props:{isEdit:{type:Boolean,default:!1},serverData:{type:Object,default:function(){return{}}}},data:function(){return{form:{name:"",host:"",port:22,username:"",authType:"password",password:"",privateKey:""},rules:{name:[{required:!0,message:"请输入服务器名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],host:[{required:!0,message:"请输入主机地址",trigger:"blur"}],port:[{required:!0,message:"请输入SSH端口",trigger:"blur"},{type:"number",message:"端口必须为数字值",trigger:"blur"}],username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}],privateKey:[{required:!0,message:"请输入私钥",trigger:"blur"}]}}},created:function(){this.isEdit&&this.serverData&&(this.form=(0,i.A)((0,i.A)({},this.form),this.serverData))},methods:{submitForm:function(){var e=this;this.$refs.serverForm.validate((function(t){if(!t)return!1;e.$emit("submit",e.form)}))},resetForm:function(){this.$refs.serverForm.resetFields()}}},L=T;var O=(0,h.A)(L,_,D,!1,null,"65912c88",null);const E=O.exports,R={name:"ServersView",components:{ServerForm:E},data:function(){return{loading:!1,servers:[],dialogVisible:!1,isEdit:!1,currentServer:null,statusText:{online:"在线",offline:"离线",error:"错误",connecting:"连接中",disconnecting:"断开中",restarting:"重启中"},disconnectingServers:{},connectingServers:{},checkingServers:{},statusCheckInterval:null,heartbeatIntervals:{},lastStateTime:{},errorReasons:{},reconnectCounters:{},sessionId:"",isServerRestarted:!1,isRetrying:!1}},computed:{hasOnlineServers:function(){return this.servers.some((function(e){return"online"===e.status}))},hasOfflineServers:function(){return this.servers.some((function(e){return"offline"===e.status||"error"===e.status}))}},created:function(){var e=this;this.checkPanelRestart(),this.fetchServers(),this.loadCachedStates(),this.statusCheckInterval=setInterval((function(){e.checkAllServersStatus()}),3e4)},mounted:function(){var e=this;setTimeout((0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.isServerRestarted){t.next=3;break}return t.next=3,e.verifyOnlineServersStatus();case 3:e.autoFixInconsistentStatus();case 4:case"end":return t.stop()}}),t)}))),1e3)},beforeDestroy:function(){var e=this;this.statusCheckInterval&&clearInterval(this.statusCheckInterval),Object.keys(this.heartbeatIntervals).forEach((function(t){clearInterval(e.heartbeatIntervals[t])}))},methods:(0,i.A)((0,i.A)({},(0,u.i0)("servers",["getAllServers","createServer","updateServer","deleteServer","connectServer","disconnectServer","checkStatus","testConnection","sendHeartbeat","getPanelStatus","getServerLogs"])),{},{fetchServers:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.loading=!0,t.prev=1,t.next=4,e.getAllServers();case 4:return r=t.sent,e.servers=r.data,t.next=8,e.verifyOnlineServersStatus();case 8:e.saveStatesToCache(),t.next=15;break;case 11:t.prev=11,t.t0=t["catch"](1),e.$message.error("获取服务器列表失败: "+t.t0.message),localStorage.removeItem("serverStates");case 15:return t.prev=15,e.loading=!1,t.finish(15);case 18:case"end":return t.stop()}}),t,null,[[1,11,15,18]])})))()},verifyOnlineServersStatus:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(r=e.servers.filter((function(e){return"online"===e.status})),0!==r.length){t.next=3;break}return t.abrupt("return");case 3:return e.loading=!0,t.prev=4,n=r.map(function(){var t=(0,y.A)((0,$.A)().mark((function t(r){var n,s,a;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.verifyServerStatus(r);case 3:n=t.sent,"online"!==n&&"online"===r.status&&(e.isServerRestarted=!0,s=e.servers.findIndex((function(e){return e._id===r._id})),-1!==s&&(e.$set(e.servers[s],"statusChanged",!0),e.$set(e.servers[s],"status",n),e.$set(e.servers[s],"lastChecked",Date.now()),setTimeout((function(){e.$set(e.servers[s],"statusChanged",!1)}),2e3))),t.next=12;break;case 7:t.prev=7,t.t0=t["catch"](0),console.error("验证服务器 ".concat(r.name," 状态失败:"),t.t0),a=e.servers.findIndex((function(e){return e._id===r._id})),-1!==a&&(e.$set(e.servers[a],"status","error"),e.$set(e.servers[a],"statusChanged",!0),e.$set(e.errorReasons,r._id,"连接验证失败，可能因为服务重启"),e.$set(e.servers[a],"lastChecked",Date.now()),setTimeout((function(){e.$set(e.servers[a],"statusChanged",!1)}),2e3));case 12:case"end":return t.stop()}}),t,null,[[0,7]])})));return function(e){return t.apply(this,arguments)}}()),t.next=8,Promise.all(n);case 8:return t.prev=8,e.loading=!1,t.finish(8);case 11:e.isServerRestarted;case 12:case"end":return t.stop()}}),t,null,[[4,,8,11]])})))()},checkPanelRestart:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,r=localStorage.getItem("panelSessionId"),t.next=4,e.getPanelStatus();case 4:if(n=t.sent,!(n&&n.data&&n.data.sessionId)){t.next=13;break}if(s=n.data.sessionId,e.sessionId=s,localStorage.setItem("panelSessionId",s),!r||r===s){t.next=13;break}return e.isServerRestarted=!0,e.handlePanelRestart(),t.abrupt("return",!0);case 13:return t.abrupt("return",!1);case 16:return t.prev=16,t.t0=t["catch"](0),console.error("检查面板状态失败:",t.t0),e.isServerRestarted=!0,e.handlePanelRestart(),t.abrupt("return",!0);case 22:case"end":return t.stop()}}),t,null,[[0,16]])})))()},handlePanelRestart:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.$notify({title:"系统提示",message:"检测到管理面板已重启，正在恢复连接状态...",type:"warning",duration:0,showClose:!0}),localStorage.removeItem("serverStates"),setTimeout((0,y.A)((0,$.A)().mark((function t(){var r,n,s,a;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(r=e.servers.filter((function(e){return"online"===e.status})),!(r.length>0)){t.next=39;break}return t.prev=2,e.loading=!0,t.prev=4,t.next=7,e.$confirm("检测到管理面板重启，共有 ".concat(r.length," 台服务器可能需要重新连接。是否立即尝试重新连接？"),"连接状态恢复",{confirmButtonText:"立即重连",cancelButtonText:"稍后手动处理",type:"warning",closeOnClickModal:!1});case 7:n=(0,C.A)(r),t.prev=8,n.s();case 10:if((s=n.n()).done){t.next=22;break}return a=s.value,t.prev=12,t.next=15,e.handleReconnect(a);case 15:t.next=20;break;case 17:t.prev=17,t.t0=t["catch"](12),console.error("重连服务器失败:",t.t0);case 20:t.next=10;break;case 22:t.next=27;break;case 24:t.prev=24,t.t1=t["catch"](8),n.e(t.t1);case 27:return t.prev=27,n.f(),t.finish(27);case 30:e.$message.success("连接状态恢复完成"),t.next=36;break;case 33:t.prev=33,t.t2=t["catch"](4),"cancel"===t.t2&&(e.$message.info("您可以稍后手动重连服务器"),r.forEach((function(t){var r=e.servers.findIndex((function(e){return e._id===t._id}));-1!==r&&(e.$set(e.servers[r],"status","error"),e.$set(e.errorReasons,t._id,"面板重启后连接状态未恢复"))})));case 36:return t.prev=36,e.loading=!1,t.finish(36);case 39:case"end":return t.stop()}}),t,null,[[2,,36,39],[4,33],[8,24,27,30],[12,17]])}))),500);case 3:case"end":return t.stop()}}),t)})))()},saveStatesToCache:function(){var e=this,t={};this.servers.forEach((function(r){t[r._id]={status:r.status,timestamp:Date.now(),sessionId:e.sessionId}})),localStorage.setItem("serverStates",JSON.stringify(t))},loadCachedStates:function(){var e=localStorage.getItem("serverStates");if(e)try{var t=JSON.parse(e),r=Object.values(t)[0];if(r&&r.sessionId&&r.sessionId!==this.sessionId)return void(this.isServerRestarted=!0);var n=Date.now(),s=Object.values(t).some((function(e){return n-e.timestamp>6e5}));if(s)return void console.log("缓存状态已过期，不加载");this.lastStateTime=t}catch(a){console.error("解析缓存状态失败:",a)}},showAddServerDialog:function(){this.isEdit=!1,this.currentServer=null,this.dialogVisible=!0},handleEdit:function(e){this.isEdit=!0,this.currentServer=(0,i.A)({},e),this.dialogVisible=!0},handleTestConnection:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(r=e.$refs.serverForm.getFormData(),r){t.next=3;break}return t.abrupt("return");case 3:return t.prev=3,t.next=6,e.testConnection(r);case 6:e.$message.success("连接测试成功"),t.next=12;break;case 9:t.prev=9,t.t0=t["catch"](3),e.$message.error("连接测试失败: "+t.t0.message);case 12:case"end":return t.stop()}}),t,null,[[3,9]])})))()},handleFormSubmit:function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(r.prev=0,!t.isEdit){r.next=7;break}return r.next=4,t.updateServer({id:t.currentServer._id,data:e});case 4:t.$message.success("服务器更新成功"),r.next=10;break;case 7:return r.next=9,t.createServer(e);case 9:t.$message.success("服务器添加成功");case 10:t.dialogVisible=!1,t.fetchServers(),r.next=17;break;case 14:r.prev=14,r.t0=r["catch"](0),t.$message.error(r.t0.message);case 17:case"end":return r.stop()}}),r,null,[[0,14]])})))()},handleDelete:function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,t.$confirm("此操作将永久删除该服务器, 是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});case 3:return r.next=5,t.deleteServer(e._id);case 5:t.$message.success("服务器删除成功"),t.fetchServers(),r.next=12;break;case 9:r.prev=9,r.t0=r["catch"](0),"cancel"!==r.t0&&t.$message.error("删除服务器失败: "+r.t0.message);case 12:case"end":return r.stop()}}),r,null,[[0,9]])})))()},verifyServerStatus:function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o,c,i,u,l,d;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,t.$set(t.checkingServers,e._id,!0),n=null,r.prev=3,r.next=6,t.getServerLogs(e._id);case 6:s=r.sent,s&&s.data&&(a=s.data,(a.includes("SSH连接建立成功")||a.includes("服务器已连接且连接有效")||a.includes("连接套接字正常"))&&(console.log("状态验证：日志显示服务器实际已连接"),n="online")),r.next=13;break;case 10:r.prev=10,r.t0=r["catch"](3),console.error("获取日志失败:",r.t0);case 13:if("online"!==n){r.next=17;break}return o=t.servers.findIndex((function(t){return t._id===e._id})),-1!==o&&"online"!==t.servers[o].status&&(t.$set(t.servers[o],"status","online"),t.$set(t.servers[o],"lastChecked",Date.now()),t.$delete(t.errorReasons,e._id)),r.abrupt("return","online");case 17:return r.next=19,t.checkStatus(e._id);case 19:if(c=r.sent,i=c.data.data.status,u=c.data.data.backendConnected||!1,"online"!==i&&!u){r.next=26;break}return l=t.servers.findIndex((function(t){return t._id===e._id})),-1!==l&&"online"!==t.servers[l].status&&(t.$set(t.servers[l],"status","online"),t.$set(t.servers[l],"lastChecked",Date.now()),t.$delete(t.errorReasons,e._id)),r.abrupt("return","online");case 26:return d=t.servers.findIndex((function(t){return t._id===e._id})),-1!==d&&t.servers[d].status!==i&&(t.$set(t.servers[d],"status",i),t.$message.warning("服务器".concat(e.name,"状态已更新为").concat(t.statusText[i]))),r.abrupt("return",i);case 31:return r.prev=31,r.t1=r["catch"](0),console.error("验证服务器状态失败:",r.t1),r.abrupt("return","error");case 35:return r.prev=35,t.$set(t.checkingServers,e._id,!1),r.finish(35);case 38:case"end":return r.stop()}}),r,null,[[0,31,35,38],[3,10]])})))()},handleConnect:function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o,c,i,u,l,d,p,v,h,m,f,g,b;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,t.$set(t.connectingServers,e._id,!0),n=t.servers.findIndex((function(t){return t._id===e._id})),-1!==n&&t.$set(t.servers[n],"status","connecting"),s=t.$notify({title:"连接中",message:"正在连接到服务器 ".concat(e.name,"..."),duration:0,type:"info"}),r.next=7,t.connectServer(e._id);case 7:if(a=r.sent,console.log("连接操作结果:",a),s.close(),o=(null===a||void 0===a?void 0:a.serverStatus)||"unknown","online"!==o){r.next=17;break}-1!==n&&(t.$set(t.servers[n],"status","online"),t.$set(t.servers[n],"lastChecked",Date.now()),t.$set(t.servers[n],"statusChanged",!0),t.$delete(t.errorReasons,e._id),setTimeout((function(){t.$set(t.servers[n],"statusChanged",!1)}),2e3)),t.$message.success("服务器连接成功"),t.startHeartbeat(e),r.next=54;break;case 17:return console.log("连接状态不明确，进行二次检查..."),r.next=20,new Promise((function(e){return setTimeout(e,1e3)}));case 20:return r.prev=20,r.next=23,t.checkStatus(e._id);case 23:if(u=r.sent,console.log("状态检查结果:",u),l=(null===u||void 0===u||null===(c=u.data)||void 0===c||null===(c=c.data)||void 0===c?void 0:c.status)||"error",d=(null===u||void 0===u||null===(i=u.data)||void 0===i||null===(i=i.data)||void 0===i?void 0:i.backendConnected)||!1,"online"!==l&&!d){r.next=33;break}-1!==n&&(t.$set(t.servers[n],"status","online"),t.$set(t.servers[n],"lastChecked",Date.now()),t.$set(t.servers[n],"statusChanged",!0),t.$delete(t.errorReasons,e._id),setTimeout((function(){t.$set(t.servers[n],"statusChanged",!1)}),2e3)),t.$message.success("服务器连接成功"),t.startHeartbeat(e),r.next=48;break;case 33:return t.$message.error("服务器连接可能存在问题，请检查服务器状态"),r.prev=34,r.next=37,t.getServerLogs(e._id);case 37:h=r.sent,console.log("服务器日志:",h),m=(null===h||void 0===h||null===(p=h.data)||void 0===p?void 0:p.data)||"",f=(null===h||void 0===h||null===(v=h.data)||void 0===v?void 0:v.connectionStatus)||{},m.includes("服务器已连接且连接有效")||f.connectionValid?(-1!==n&&(t.$set(t.servers[n],"status","online"),t.$set(t.servers[n],"lastChecked",Date.now()),t.$set(t.servers[n],"statusChanged",!0),t.$delete(t.errorReasons,e._id)),t.$message.success("服务器实际已连接成功，已修复状态显示"),t.startHeartbeat(e)):-1!==n&&(t.$set(t.servers[n],"status","error"),t.$set(t.errorReasons,e._id,"连接失败，请查看服务器日志")),r.next=48;break;case 44:r.prev=44,r.t0=r["catch"](34),console.error("获取服务器日志失败:",r.t0),-1!==n&&(t.$set(t.servers[n],"status","error"),t.$set(t.errorReasons,e._id,"连接状态确认失败"));case 48:r.next=54;break;case 50:r.prev=50,r.t1=r["catch"](20),console.error("获取状态失败:",r.t1),-1!==n&&(t.$set(t.servers[n],"status","error"),t.$set(t.errorReasons,e._id,"连接后状态确认失败"));case 54:r.next=63;break;case 56:r.prev=56,r.t2=r["catch"](0),g=t.parseErrorMessage(r.t2),t.$set(t.errorReasons,e._id,g),t.$message.error("连接服务器失败: "+g),b=t.servers.findIndex((function(t){return t._id===e._id})),-1!==b&&(t.$set(t.servers[b],"status","error"),t.$set(t.servers[b],"lastChecked",Date.now()));case 63:return r.prev=63,t.$set(t.connectingServers,e._id,!1),t.saveStatesToCache(),r.finish(63);case 67:case"end":return r.stop()}}),r,null,[[0,56,63,67],[20,50],[34,44]])})))()},handleDisconnect:function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,t.$set(t.disconnectingServers,e._id,!0),n=t.servers.findIndex((function(t){return t._id===e._id})),-1!==n&&t.$set(t.servers[n],"status","disconnecting"),t.stopHeartbeat(e._id),s=t.$notify({title:"断开连接中",message:"正在断开服务器 ".concat(e.name," 的连接..."),duration:0,type:"warning"}),r.next=8,t.disconnectServer(e._id);case 8:return s.close(),t.$message.success("服务器断开连接成功"),-1!==n&&t.$set(t.servers[n],"status","offline"),r.next=13,t.fetchServers();case 13:r.next=20;break;case 15:return r.prev=15,r.t0=r["catch"](0),t.$message.error("断开服务器连接失败: "+r.t0.message),r.next=20,t.checkServerStatus(e);case 20:return r.prev=20,t.$set(t.disconnectingServers,e._id,!1),t.saveStatesToCache(),r.finish(20);case 24:case"end":return r.stop()}}),r,null,[[0,15,20,24]])})))()},handleManageRules:function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o,c,i,u,l,d,p,v;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if("online"!==e.status){r.next=3;break}return t.$router.push({name:"rules",params:{serverId:e._id}}),r.abrupt("return");case 3:return r.prev=3,t.$set(t.checkingServers,e._id,!0),a=!1,r.prev=6,r.next=9,t.getServerLogs(e._id);case 9:if(o=r.sent,!o||!o.data){r.next=23;break}if(c=o.data,!(c.includes("SSH连接建立成功")||c.includes("服务器已连接且连接有效")||c.includes("连接套接字正常"))){r.next=23;break}if(console.log("管理规则前检查：日志显示服务器实际已连接"),a=!0,i=t.servers.findIndex((function(t){return t._id===e._id})),-1===i||"online"===t.servers[i].status){r.next=23;break}return t.$set(t.servers[i],"status","online"),t.$set(t.servers[i],"lastChecked",Date.now()),t.$delete(t.errorReasons,e._id),t.$message.info("服务器 ".concat(e.name," 实际已连接，状态已修复")),setTimeout((function(){t.$router.push({name:"rules",params:{serverId:e._id}})}),500),r.abrupt("return");case 23:r.next=28;break;case 25:r.prev=25,r.t0=r["catch"](6),console.error("管理规则前获取日志失败:",r.t0);case 28:if(!a){r.next=31;break}return t.$router.push({name:"rules",params:{serverId:e._id}}),r.abrupt("return");case 31:return r.next=33,t.checkStatus(e._id);case 33:if(u=r.sent,l=(null===u||void 0===u||null===(n=u.data)||void 0===n||null===(n=n.data)||void 0===n?void 0:n.status)||"error",d=(null===u||void 0===u||null===(s=u.data)||void 0===s||null===(s=s.data)||void 0===s?void 0:s.backendConnected)||!1,"online"!==l&&!d){r.next=41;break}return p=t.servers.findIndex((function(t){return t._id===e._id})),-1!==p&&(t.$set(t.servers[p],"status","online"),t.$set(t.servers[p],"lastChecked",Date.now())),t.$router.push({name:"rules",params:{serverId:e._id}}),r.abrupt("return");case 41:v=t.errorReasons[e._id]||"服务器当前不在线",t.$confirm("".concat(v,"，需要先连接服务器吗?"),"提示",{confirmButtonText:"连接并管理",cancelButtonText:"取消",type:"warning"}).then((function(){t.handleConnect(e).then((function(){t.$router.push({name:"rules",params:{serverId:e._id}})}))}))["catch"]((function(){})),r.next=49;break;case 45:r.prev=45,r.t1=r["catch"](3),console.error("检查服务器状态失败:",r.t1),t.$confirm("无法确认服务器状态，是否尝试连接后再管理?","提示",{confirmButtonText:"连接并管理",cancelButtonText:"取消",type:"warning"}).then((function(){t.handleConnect(e).then((function(){t.$router.push({name:"rules",params:{serverId:e._id}})}))}))["catch"]((function(){}));case 49:return r.prev=49,t.$set(t.checkingServers,e._id,!1),r.finish(49);case 52:case"end":return r.stop()}}),r,null,[[3,45,49,52],[6,25]])})))()},checkServerStatus:function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,t.$set(t.checkingServers,e._id,!0),r.next=4,t.checkStatus(e._id);case 4:n=r.sent,s=t.servers.findIndex((function(t){return t._id===e._id})),-1!==s&&(t.$set(t.servers[s],"status",n.data.data.status),t.$set(t.servers[s],"lastChecked",Date.now())),t.saveStatesToCache(),r.next=13;break;case 10:r.prev=10,r.t0=r["catch"](0),console.error("检查服务器状态失败:",r.t0);case 13:return r.prev=13,t.$set(t.checkingServers,e._id,!1),r.finish(13);case 16:case"end":return r.stop()}}),r,null,[[0,10,13,16]])})))()},checkAllServersStatus:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:r=(0,C.A)(e.servers),t.prev=1,r.s();case 3:if((n=r.n()).done){t.next=9;break}return s=n.value,t.next=7,e.checkServerStatus(s);case 7:t.next=3;break;case 9:t.next=14;break;case 11:t.prev=11,t.t0=t["catch"](1),r.e(t.t0);case 14:return t.prev=14,r.f(),t.finish(14);case 17:case"end":return t.stop()}}),t,null,[[1,11,14,17]])})))()},getStatusTagType:function(e){switch(e){case"online":return"success";case"error":return"danger";case"connecting":return"info";case"disconnecting":return"warning";default:return""}},batchConnect:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(r=e.servers.filter((function(e){return"offline"===e.status||"error"===e.status})),0!==r.length){t.next=3;break}return t.abrupt("return");case 3:return t.prev=3,t.next=6,e.$confirm("确定要连接全部".concat(r.length,"台离线服务器吗?"),"批量连接",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"});case 6:n=(0,C.A)(r),t.prev=7,n.s();case 9:if((s=n.n()).done){t.next=15;break}return a=s.value,t.next=13,e.handleConnect(a);case 13:t.next=9;break;case 15:t.next=20;break;case 17:t.prev=17,t.t0=t["catch"](7),n.e(t.t0);case 20:return t.prev=20,n.f(),t.finish(20);case 23:e.$message.success("批量连接操作已完成"),t.next=29;break;case 26:t.prev=26,t.t1=t["catch"](3),"cancel"!==t.t1&&e.$message.error("批量连接失败: "+t.t1.message);case 29:case"end":return t.stop()}}),t,null,[[3,26],[7,17,20,23]])})))()},batchDisconnect:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(r=e.servers.filter((function(e){return"online"===e.status})),0!==r.length){t.next=3;break}return t.abrupt("return");case 3:return t.prev=3,t.next=6,e.$confirm("确定要断开全部".concat(r.length,"台在线服务器吗?"),"批量断开",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});case 6:n=(0,C.A)(r),t.prev=7,n.s();case 9:if((s=n.n()).done){t.next=15;break}return a=s.value,t.next=13,e.handleDisconnect(a);case 13:t.next=9;break;case 15:t.next=20;break;case 17:t.prev=17,t.t0=t["catch"](7),n.e(t.t0);case 20:return t.prev=20,n.f(),t.finish(20);case 23:e.$message.success("批量断开操作已完成"),t.next=29;break;case 26:t.prev=26,t.t1=t["catch"](3),"cancel"!==t.t1&&e.$message.error("批量断开失败: "+t.t1.message);case 29:case"end":return t.stop()}}),t,null,[[3,26],[7,17,20,23]])})))()},startHeartbeat:function(e){var t=this;this.heartbeatIntervals[e._id]&&clearInterval(this.heartbeatIntervals[e._id]),setTimeout((0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,t.checkStatus(e._id);case 3:n=r.sent,n&&n.data&&"error"===n.data.status&&n.logs&&(n.logs.includes("连接套接字正常")||n.logs.includes("SSH连接已就绪")||n.logs.includes("SSH连接建立成功"))&&(console.log("心跳初始检查：连接实际有效，修复状态"),s=t.servers.findIndex((function(t){return t._id===e._id})),-1!==s&&t.$set(t.servers[s],"status","online")),r.next=10;break;case 7:r.prev=7,r.t0=r["catch"](0),console.error("初始心跳检查失败:",r.t0);case 10:case"end":return r.stop()}}),r,null,[[0,7]])}))),2e3),this.heartbeatIntervals[e._id]=setInterval((0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(e&&"online"===e.status){r.next=3;break}return t.stopHeartbeat(e._id),r.abrupt("return");case 3:return r.prev=3,r.next=6,t.sendHeartbeat(e._id);case 6:if(n=r.sent,!n||!n.data||"success"!==n.data.status){r.next=11;break}t.reconnectCounters[e._id]&&(t.reconnectCounters[e._id]=0),r.next=13;break;case 11:return r.next=13,t.handleHeartbeatFailure(e);case 13:r.next=31;break;case 15:return r.prev=15,r.t0=r["catch"](3),r.prev=17,r.next=20,t.checkStatus(e._id);case 20:if(s=r.sent,!s||!s.data||"online"!==s.data.status&&!s.data.backendConnected){r.next=24;break}return console.log("心跳失败但状态检查显示连接有效，跳过失败处理"),r.abrupt("return");case 24:r.next=29;break;case 26:r.prev=26,r.t1=r["catch"](17),console.error("心跳失败后状态检查失败:",r.t1);case 29:return r.next=31,t.handleHeartbeatFailure(e);case 31:case"end":return r.stop()}}),r,null,[[3,15],[17,26]])}))),1e4)},stopHeartbeat:function(e){this.heartbeatIntervals[e]&&(clearInterval(this.heartbeatIntervals[e]),delete this.heartbeatIntervals[e])},handleHeartbeatFailure:function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(n=t.servers.findIndex((function(t){return t._id===e._id})),-1!==n){r.next=3;break}return r.abrupt("return");case 3:return r.prev=3,r.next=6,t.getServerLogs(e._id);case 6:if(s=r.sent,!s||!s.data){r.next=13;break}if(a=s.data,!(a.includes("SSH连接建立成功")||a.includes("服务器已连接且连接有效")||a.includes("连接套接字正常"))){r.next=13;break}return console.log("日志显示连接实际有效，保持在线状态"),"online"!==t.servers[n].status&&(t.$set(t.servers[n],"status","online"),t.$set(t.servers[n],"lastChecked",Date.now()),t.$delete(t.errorReasons,e._id),t.$message.info("服务器 ".concat(e.name," 状态已自动修复为在线"))),r.abrupt("return");case 13:r.next=18;break;case 15:r.prev=15,r.t0=r["catch"](3),console.error("获取服务器日志失败:",r.t0);case 18:return"online"===t.servers[n].status&&(t.$set(t.servers[n],"status","error"),t.$set(t.errorReasons,e._id,"心跳检测失败，可能是服务器重启或网络问题"),o="服务器 ".concat(e.name," 连接异常，心跳检测失败"),t.$notify({title:"连接异常",message:o,type:"error",duration:0,onClick:function(){t.showReconnectDialog(e)}}),t.reconnectCounters[e._id]||(t.reconnectCounters[e._id]=0),0===t.reconnectCounters[e._id]&&t.showReconnectDialog(e),t.reconnectCounters[e._id]++),r.next=21,t.verifyServerStatus(e);case 21:case"end":return r.stop()}}),r,null,[[3,15]])})))()},showReconnectDialog:function(e){var t=this;this.$confirm("服务器 ".concat(e.name," 连接异常，可能是服务器已重启或网络问题。是否尝试重新连接？"),"连接异常",{confirmButtonText:"重新连接",cancelButtonText:"忽略",type:"warning",closeOnClickModal:!1,closeOnPressEscape:!1,showClose:!1}).then((function(){t.handleReconnect(e)}))["catch"]((function(){t.$message({type:"info",message:"已忽略服务器 ".concat(e.name," 的连接异常")})}))},handleReconnect:function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,r.prev=1,r.next=4,t.disconnectServer(e._id);case 4:r.next=9;break;case 6:r.prev=6,r.t0=r["catch"](1),console.log("断开连接失败，可能已断开:",r.t0);case 9:setTimeout((0,y.A)((0,$.A)().mark((function r(){var n,s,a,o;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,n=t.servers.findIndex((function(t){return t._id===e._id})),-1!==n&&t.$set(t.servers[n],"status","connecting"),t.$set(t.errorReasons,e._id,null),t.$set(t.connectingServers,e._id,!0),r.next=7,t.connectServer(e._id);case 7:return t.$message.success("服务器 ".concat(e.name," 重新连接成功")),r.next=10,t.fetchServers();case 10:s=t.servers.find((function(t){return t._id===e._id})),s&&"online"===s.status&&t.startHeartbeat(s),r.next=21;break;case 14:r.prev=14,r.t0=r["catch"](0),t.$message.error("重新连接失败: ".concat(r.t0.message)),a=t.parseErrorMessage(r.t0),t.$set(t.errorReasons,e._id,a),o=t.servers.findIndex((function(t){return t._id===e._id})),-1!==o&&t.$set(t.servers[o],"status","error");case 21:return r.prev=21,t.$set(t.connectingServers,e._id,!1),r.finish(21);case 24:case"end":return r.stop()}}),r,null,[[0,14,21,24]])}))),1e3),r.next=15;break;case 12:r.prev=12,r.t1=r["catch"](0),t.$message.error("重连操作失败: ".concat(r.t1.message));case 15:case"end":return r.stop()}}),r,null,[[0,12],[1,6]])})))()},showTimeoutHelpDialog:function(e){this.$alert("\n        <strong>连接超时可能的原因：</strong>\n        <ul>\n          <li>网络连接问题或防火墙限制</li>\n          <li>服务器SSH服务未启动或端口未开放</li>\n          <li>主机地址或端口号填写错误</li>\n          <li>服务器负载过高，响应缓慢</li>\n        </ul>\n        <strong>建议解决方案：</strong>\n        <ul>\n          <li>检查网络连接和防火墙设置</li>\n          <li>确认SSH服务运行状态和端口开放情况</li>\n          <li>验证服务器地址、端口和凭据信息</li>\n          <li>可尝试增加连接超时时间</li>\n        </ul>\n        <p>您也可以检查服务器日志获取更多信息。</p>\n      ","连接超时帮助",{dangerouslyUseHTMLString:!0,confirmButtonText:"我知道了",callback:function(){}})},parseErrorMessage:function(e){var t="未知错误";return"string"===typeof e?t=e:e.message&&(t=e.message),t.includes("timeout")||t.includes("超时")||t.includes("timed out")?"连接超时，请检查网络或服务器SSH服务状态":t.includes("refused")||t.includes("拒绝")?"连接被拒绝，请检查服务器是否启动或端口是否正确":t.includes("authentication")||t.includes("认证")?"认证失败，请检查用户名和密码":t.includes("not found")||t.includes("找不到")?"找不到服务器，请检查主机地址是否正确":t.includes("handshake")?"SSH握手失败，可能是网络问题或SSH服务配置错误":t.includes("took too long")?"连接操作耗时过长，已自动中断":"连接错误: ".concat(t)},getOfflineCount:function(){return this.servers.filter((function(e){return"offline"===e.status||"error"===e.status})).length},getOnlineCount:function(){return this.servers.filter((function(e){return"online"===e.status})).length},formatTime:function(e){if(!e)return"";var t=new Date,r=new Date(e),n=Math.floor((t-r)/1e3);return n<60?"刚刚":n<3600?"".concat(Math.floor(n/60),"分钟前"):n<86400?"".concat(Math.floor(n/3600),"小时前"):"".concat(r.getMonth()+1,"-").concat(r.getDate()," ").concat(r.getHours(),":").concat(r.getMinutes())},handleConnectionRetry:function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(r.prev=0,!t.isRetrying){r.next=3;break}return r.abrupt("return");case 3:return t.isRetrying=!0,t.$message.info("正在重新获取服务器 ".concat(e.name," 的连接状态...")),r.next=7,t.forceCheckServerStatus(e);case 7:n=r.sent,"online"===n?t.$message.success("服务器 ".concat(e.name," 实际上已经连接成功！界面已更新。")):"offline"===n?t.$confirm("服务器 ".concat(e.name," 未连接，是否尝试重新连接？"),"连接确认",{confirmButtonText:"重新连接",cancelButtonText:"取消",type:"info"}).then((function(){t.handleConnect(e)}))["catch"]((function(){})):t.checkServerLogs(e),r.next=14;break;case 11:r.prev=11,r.t0=r["catch"](0),t.$message.error("重试失败: ".concat(r.t0.message));case 14:return r.prev=14,setTimeout((function(){t.isRetrying=!1}),1e3),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[0,11,14,17]])})))()},forceCheckServerStatus:function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o,c,i,u,l,d,p,v;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,t.$set(t.checkingServers,e._id,!0),r.next=4,new Promise((function(e){return setTimeout(e,1e3)}));case 4:return n=null,r.prev=5,r.next=8,t.getServerLogs(e._id);case 8:s=r.sent,s&&s.data&&(a=s.data,(a.includes("SSH连接建立成功")||a.includes("服务器已连接且连接有效")||a.includes("连接套接字正常"))&&(n="online",console.log("日志显示连接实际有效"))),r.next=15;break;case 12:r.prev=12,r.t0=r["catch"](5),console.error("获取服务器日志失败:",r.t0);case 15:if("online"!==n){r.next=24;break}if(o=t.servers.findIndex((function(t){return t._id===e._id})),-1===o){r.next=24;break}return c=t.servers[o].status,t.$set(t.servers[o],"status","online"),t.$set(t.servers[o],"lastChecked",Date.now()),"online"!==c&&(t.$set(t.servers[o],"statusChanged",!0),t.$delete(t.errorReasons,e._id),t.startHeartbeat(t.servers[o]),setTimeout((function(){t.$set(t.servers[o],"statusChanged",!1)}),2e3),t.$message.success("服务器 ".concat(e.name," 实际连接正常，状态已更新为在线"))),t.saveStatesToCache(),r.abrupt("return","online");case 24:i="error",u=0,l=3;case 27:if(!(u<l)){r.next=51;break}return r.prev=28,r.next=31,t.checkStatus(e._id);case 31:if(d=r.sent,!(d&&d.data&&d.data.data)){r.next=40;break}if(i=d.data.data.status,"error"!==i||!d.data.data.backendConnected&&"online"!==n){r.next=38;break}return console.log("后端连接实际有效，强制更新状态为在线"),i="online",r.abrupt("break",51);case 38:if("online"!==i){r.next=40;break}return r.abrupt("break",51);case 40:r.next=45;break;case 42:r.prev=42,r.t1=r["catch"](28),console.error("状态检查重试 ".concat(u+1,"/").concat(l," 失败:"),r.t1);case 45:if(u++,!(u<l)){r.next=49;break}return r.next=49,new Promise((function(e){return setTimeout(e,1e3)}));case 49:r.next=27;break;case 51:return p=t.servers.findIndex((function(t){return t._id===e._id})),-1!==p&&(v=t.servers[p].status,t.$set(t.servers[p],"status",i),t.$set(t.servers[p],"lastChecked",Date.now()),v!==i&&(t.$set(t.servers[p],"statusChanged",!0),"error"===i?t.$set(t.errorReasons,e._id,"连接状态检查显示连接失败，请检查服务器日志"):"online"===i&&(t.$delete(t.errorReasons,e._id),t.startHeartbeat(t.servers[p])),setTimeout((function(){t.$set(t.servers[p],"statusChanged",!1)}),2e3)),"online"===i?t.$message.success("服务器 ".concat(e.name," 已成功连接")):"error"===i?t.$message.error("服务器 ".concat(e.name," 连接存在问题，状态检查显示错误")):t.$message.info("服务器 ".concat(e.name," 当前状态: ").concat(t.statusText[i]))),t.saveStatesToCache(),r.abrupt("return",i);case 57:return r.prev=57,r.t2=r["catch"](0),console.error("强制检查服务器状态失败:",r.t2),r.abrupt("return","error");case 61:return r.prev=61,t.$set(t.checkingServers,e._id,!1),r.finish(61);case 64:case"end":return r.stop()}}),r,null,[[0,57,61,64],[5,12],[28,42]])})))()},checkServerLogs:function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,t.getServerLogs(e._id);case 3:n=r.sent,n&&n.data?(s=n.data,s.includes("SSH连接建立成功")||s.includes("服务器已连接且连接有效")?t.$alert("\n              <p>检测到状态不一致:</p>\n              <p>界面显示: <strong>错误</strong></p>\n              <p>后台日志: <strong>连接成功</strong></p>\n              <p>这通常是因为状态更新未正确同步。</p>\n            ","连接状态异常",{dangerouslyUseHTMLString:!0,confirmButtonText:"立即修复",callback:function(){var r=t.servers.findIndex((function(t){return t._id===e._id}));-1!==r&&(t.$set(t.servers[r],"status","online"),t.$set(t.servers[r],"lastChecked",Date.now()),t.$delete(t.errorReasons,e._id),t.startHeartbeat(t.servers[r]),t.$message.success("状态已修复为在线"),t.saveStatesToCache())}}):s.includes("连接失败")||s.includes("连接错误")?t.$confirm("服务器连接确实失败，日志显示连接错误。是否尝试重新连接？","连接确认",{confirmButtonText:"重新连接",cancelButtonText:"取消",type:"warning"}).then((function(){t.handleConnect(e)}))["catch"]((function(){})):t.$confirm("无法从日志确定连接状态。是否尝试重新连接？","连接确认",{confirmButtonText:"重新连接",cancelButtonText:"取消",type:"info",closeOnClickModal:!0}).then((function(){t.handleConnect(e)}))["catch"]((function(){}))):t.$confirm("无法获取服务器日志。是否尝试重新连接？","连接确认",{confirmButtonText:"重新连接",cancelButtonText:"取消",type:"info"}).then((function(){t.handleConnect(e)}))["catch"]((function(){})),r.next=11;break;case 7:r.prev=7,r.t0=r["catch"](0),console.error("获取服务器日志失败:",r.t0),t.$message.error("获取服务器日志失败: "+r.t0.message);case 11:case"end":return r.stop()}}),r,null,[[0,7]])})))()},autoFixInconsistentStatus:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c,i,u;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:console.log("开始检查并自动修复状态不一致问题..."),r=e.servers.filter((function(e){return"error"===e.status})),n=(0,C.A)(r),t.prev=3,a=(0,$.A)().mark((function t(){var r,n,a,o;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return r=s.value,t.prev=1,console.log("检查错误状态服务器: ".concat(r.name)),t.next=5,e.getServerLogs(r._id);case 5:n=t.sent,n&&n.data&&(a=n.data,(a.includes("SSH连接建立成功")||a.includes("服务器已连接且连接有效")||a.includes("连接套接字正常"))&&(console.log("服务器 ".concat(r.name," 状态显示错误，但日志表明连接有效，自动修复")),o=e.servers.findIndex((function(e){return e._id===r._id})),-1!==o&&(e.$set(e.servers[o],"status","online"),e.$set(e.servers[o],"lastChecked",Date.now()),e.$delete(e.errorReasons,r._id),e.startHeartbeat(e.servers[o]),e.$message.success("已自动修复服务器 ".concat(r.name," 的状态为在线"))))),t.next=12;break;case 9:t.prev=9,t.t0=t["catch"](1),console.error("自动修复 ".concat(r.name," 状态失败:"),t.t0);case 12:case"end":return t.stop()}}),t,null,[[1,9]])})),n.s();case 6:if((s=n.n()).done){t.next=10;break}return t.delegateYield(a(),"t0",8);case 8:t.next=6;break;case 10:t.next=15;break;case 12:t.prev=12,t.t1=t["catch"](3),n.e(t.t1);case 15:return t.prev=15,n.f(),t.finish(15);case 18:o=e.servers.filter((function(e){return"offline"===e.status})),c=(0,C.A)(o),t.prev=20,u=(0,$.A)().mark((function t(){var r,n,s;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return r=i.value,t.prev=1,console.log("检查离线状态服务器: ".concat(r.name)),t.next=5,e.checkStatus(r._id);case 5:n=t.sent,n&&n.data&&("online"===n.data.status||n.data.backendConnected)&&(console.log("服务器 ".concat(r.name," 状态显示离线，但实际连接有效，自动修复")),s=e.servers.findIndex((function(e){return e._id===r._id})),-1!==s&&(e.$set(e.servers[s],"status","online"),e.$set(e.servers[s],"lastChecked",Date.now()),e.startHeartbeat(e.servers[s]),e.$message.success("已自动修复服务器 ".concat(r.name," 的状态为在线")))),t.next=12;break;case 9:t.prev=9,t.t0=t["catch"](1),console.error("检查 ".concat(r.name," 实际状态失败:"),t.t0);case 12:case"end":return t.stop()}}),t,null,[[1,9]])})),c.s();case 23:if((i=c.n()).done){t.next=27;break}return t.delegateYield(u(),"t2",25);case 25:t.next=23;break;case 27:t.next=32;break;case 29:t.prev=29,t.t3=t["catch"](20),c.e(t.t3);case 32:return t.prev=32,c.f(),t.finish(32);case 35:e.saveStatesToCache();case 36:case"end":return t.stop()}}),t,null,[[3,12,15,18],[20,29,32,35]])})))()}})},V=R;var N=(0,h.A)(V,S,P,!1,null,"0c04964d",null);const H=N.exports;var B,M=function(){var e=this,t=e._self._c;return t("div",{staticClass:"rules-container"},[t("div",{staticClass:"page-header"},[t("h1",[e._v("防火墙规则管理")]),t("div",[t("el-button",{attrs:{type:"primary"},on:{click:function(t){return e.$router.push("/servers")}}},[e._v("返回服务器列表")]),e.isServerOnline&&!e.scriptExists?t("el-button",{attrs:{type:"success",loading:e.deploying},on:{click:e.deployScript}},[e._v("部署脚本")]):e._e(),e.isServerOnline&&e.scriptExists?t("el-button",{attrs:{type:"danger"},on:{click:e.confirmClearRules}},[e._v("清空所有规则")]):e._e(),!e.isServerOnline&&e.server?t("el-button",{attrs:{type:"warning",loading:e.connecting},on:{click:e.tryConnectServer}},[e._v("连接服务器")]):e._e()],1)]),e.server?t("div",{staticClass:"server-info"},[t("h2",[e._v(e._s(e.server.name)+" "),t("el-tag",{attrs:{type:"online"===e.server.status?"success":"danger"}},[e._v(e._s("online"===e.server.status?"在线":"离线"))])],1),t("p",[e._v(e._s(e.server.host)+":"+e._s(e.server.port)+" ("+e._s(e.server.username)+")")])]):e._e(),e.scriptCheckLoading||e.scriptExists||!e.isServerOnline?e._e():t("div",{staticClass:"script-deploy-needed"},[t("el-alert",{staticStyle:{"margin-bottom":"15px"},attrs:{title:"脚本未部署",type:"warning",description:"检测到服务器上没有部署Nftato脚本，需要先部署脚本才能使用防火墙功能","show-icon":"",closable:!1}}),t("div",{staticClass:"deploy-container"},[e._m(0),t("el-button",{attrs:{type:"success",size:"large",loading:e.deploying},on:{click:e.deployScript}},[t("i",{staticClass:"el-icon-upload"}),e._v(" 开始部署 ")])],1)],1),e.deploying&&e.deployLogs.length>0?t("div",{staticClass:"deploy-terminal"},[t("div",{staticClass:"terminal-header"},[t("span",[e._v("脚本部署进度")]),e.deployComplete?t("el-button",{attrs:{size:"mini",type:"success"},on:{click:function(t){e.deployLogs=[]}}},[e._v("关闭")]):e._e()],1),t("div",{ref:"terminalBody",staticClass:"terminal-body"},[e._l(e.deployLogs,(function(r,n){return t("div",{key:n,class:{"log-line":!0,"error-line":"error"===r.type,"success-line":"success"===r.type}},[t("pre",[e._v(e._s(r.message))])])})),e.deploying&&!e.deployComplete?t("div",{staticClass:"terminal-cursor"}):e._e()],2),e.deployComplete?t("div",{staticClass:"terminal-footer"},[e.deploySuccess?t("el-button",{attrs:{type:"success"},on:{click:e.refreshAllData}},[e._v("部署成功，加载规则数据")]):t("el-button",{attrs:{type:"danger"},on:{click:e.retryDeploy}},[e._v("部署失败，重试")])],1):e._e()]):e._e(),e.scriptExists||!e.isServerOnline?t("el-tabs",{attrs:{type:"card"},model:{value:e.activeTab,callback:function(t){e.activeTab=t},expression:"activeTab"}},[t("el-tab-pane",{attrs:{label:"入网控制",name:"inbound"}},[e.isServerOnline?t("div",[t("el-card",[t("div",{attrs:{slot:"header"},slot:"header"},[t("span",[e._v("SSH端口状态")]),t("el-button",{staticStyle:{float:"right",padding:"3px 0"},attrs:{type:"text"},on:{click:e.refreshSSHPort}},[e._v("刷新")])],1),e.sshPortStatus?t("pre",{staticClass:"output"},[e._v(e._s(e.sshPortStatus))]):t("div",[e._v("加载中...")])]),t("el-card",{staticStyle:{"margin-top":"20px"}},[t("div",{attrs:{slot:"header"},slot:"header"},[t("span",[e._v("入网端口管理")]),t("el-button",{staticStyle:{float:"right",padding:"3px 0"},attrs:{type:"text",loading:e.loadingPorts},on:{click:e.refreshInboundPorts}},[e._v("刷新")])],1),t("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loadingPorts,expression:"loadingPorts"}],staticStyle:{width:"100%"},attrs:{data:e.formattedPorts}},[t("el-table-column",{attrs:{prop:"port",label:"端口",width:"180"}}),t("el-table-column",{attrs:{prop:"protocol",label:"协议",width:"100"}}),t("el-table-column",{attrs:{label:"操作"},scopedSlots:e._u([{key:"default",fn:function(r){return[e.isSshPort(r.row.port)?t("el-tooltip",{attrs:{content:"不能取消SSH端口放行，这可能导致无法连接服务器",placement:"top"}},[t("el-button",{attrs:{type:"danger",size:"mini",disabled:""}},[e._v("取消放行")])],1):t("el-button",{attrs:{type:"danger",size:"mini",loading:e.loadingPorts,disabled:!e.isServerOnline},on:{click:function(t){return e.disallowPort(r.row.port)}}},[e._v("取消放行")])]}}],null,!1,1347874321)})],1),t("el-divider"),t("el-form",{attrs:{inline:!0},nativeOn:{submit:function(t){return t.preventDefault(),e.allowPort.apply(null,arguments)}}},[t("el-form-item",{attrs:{label:"放行端口"}},[t("el-input",{attrs:{placeholder:"如: 80,443",disabled:!e.isServerOnline},model:{value:e.portToAllow,callback:function(t){e.portToAllow=t},expression:"portToAllow"}})],1),t("el-form-item",[t("el-button",{attrs:{type:"primary",loading:e.loadingPorts,disabled:!e.isServerOnline},on:{click:e.allowPort}},[e._v("添加")])],1)],1)],1),t("el-card",{staticStyle:{"margin-top":"20px"}},[t("div",{attrs:{slot:"header"},slot:"header"},[t("span",[e._v("入网IP管理")]),t("el-button",{staticStyle:{float:"right",padding:"3px 0"},attrs:{type:"text",loading:e.loadingIPs},on:{click:e.refreshInboundIPs}},[e._v("刷新")])],1),t("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loadingIPs,expression:"loadingIPs"}],staticStyle:{width:"100%"},attrs:{data:e.inboundIPs}},[t("el-table-column",{attrs:{prop:"ip",label:"IP地址",width:"180"}}),t("el-table-column",{attrs:{label:"操作"},scopedSlots:e._u([{key:"default",fn:function(r){return[t("el-button",{attrs:{type:"danger",size:"mini",loading:e.loadingIPs,disabled:!e.isServerOnline},on:{click:function(t){return e.disallowIP(r.row.ip||r.row)}}},[e._v("取消放行")])]}}],null,!1,1073906791)})],1),t("el-divider"),t("el-form",{attrs:{inline:!0},nativeOn:{submit:function(t){return t.preventDefault(),e.allowIP.apply(null,arguments)}}},[t("el-form-item",{attrs:{label:"放行IP"}},[t("el-input",{attrs:{placeholder:"如: 192.168.1.1",disabled:!e.isServerOnline},model:{value:e.ipToAllow,callback:function(t){e.ipToAllow=t},expression:"ipToAllow"}})],1),t("el-form-item",[t("el-button",{attrs:{type:"primary",loading:e.loadingIPs,disabled:!e.isServerOnline},on:{click:e.allowIP}},[e._v("添加")])],1)],1)],1)],1):[t("el-alert",{staticStyle:{"margin-bottom":"15px"},attrs:{title:"服务器当前处于离线状态",type:"warning",description:"服务器离线时无法管理防火墙规则，请先连接服务器","show-icon":"",closable:!1}}),t("div",{staticClass:"server-offline"},[t("i",{staticClass:"el-icon-connection"}),t("h3",[e._v("服务器未连接")]),t("p",[e._v("当前无法管理防火墙规则，请先连接服务器")])]),t("div",{staticClass:"offline-actions"},[t("el-button",{attrs:{type:"primary",loading:e.connecting,icon:"el-icon-refresh"},on:{click:e.tryConnectServer}},[e._v("连接服务器")]),t("el-button",{attrs:{icon:"el-icon-back"},on:{click:function(t){return e.$router.push("/servers")}}},[e._v("返回服务器列表")])],1)]],2),t("el-tab-pane",{attrs:{label:"出网控制",name:"outbound"}},[e.isServerOnline?t("div",[t("el-card",[t("div",{attrs:{slot:"header"},slot:"header"},[t("span",[e._v("当前封禁列表")]),t("el-button",{staticStyle:{float:"right",padding:"3px 0"},attrs:{type:"text",loading:e.loadingBlockList},on:{click:e.refreshBlockList}},[e._v("刷新")])],1),e.blockList?t("pre",{staticClass:"output"},[e._v(e._s(e.blockList))]):t("div",[e._v("加载中...")])]),t("el-card",{staticStyle:{"margin-top":"20px"}},[t("div",{attrs:{slot:"header"},slot:"header"},[t("span",[e._v("封禁管理")])]),t("el-button-group",[t("el-button",{attrs:{type:"primary",loading:e.loading,disabled:!e.isServerOnline},on:{click:e.blockSPAM}},[e._v("封禁SPAM")])],1),t("el-divider"),t("el-form",{attrs:{inline:!0},nativeOn:{submit:function(t){return t.preventDefault(),e.blockCustomPorts.apply(null,arguments)}}},[t("el-form-item",{attrs:{label:"自定义端口"}},[t("el-input",{attrs:{placeholder:"如: 6881,6882-6889",disabled:!e.isServerOnline},model:{value:e.customPorts,callback:function(t){e.customPorts=t},expression:"customPorts"}})],1),t("el-form-item",[t("el-button",{attrs:{type:"warning",loading:e.loading,disabled:!e.isServerOnline},on:{click:e.blockCustomPorts}},[e._v("封禁")])],1)],1)],1),t("el-card",{staticStyle:{"margin-top":"20px"}},[t("div",{attrs:{slot:"header"},slot:"header"},[t("span",[e._v("解封管理")])]),t("el-button-group",[t("el-button",{attrs:{type:"success",loading:e.loading,disabled:!e.isServerOnline},on:{click:e.unblockSPAM}},[e._v("解封SPAM")])],1),t("el-divider"),t("el-form",{attrs:{inline:!0},nativeOn:{submit:function(t){return t.preventDefault(),e.unblockCustomPorts.apply(null,arguments)}}},[t("el-form-item",{attrs:{label:"自定义端口"}},[t("el-input",{attrs:{placeholder:"如: 6881,6882-6889",disabled:!e.isServerOnline},model:{value:e.customUnblockPorts,callback:function(t){e.customUnblockPorts=t},expression:"customUnblockPorts"}})],1),t("el-form-item",[t("el-button",{attrs:{type:"success",loading:e.loading,disabled:!e.isServerOnline},on:{click:e.unblockCustomPorts}},[e._v("解封")])],1)],1)],1)],1):[t("el-alert",{staticStyle:{"margin-bottom":"15px"},attrs:{title:"服务器当前处于离线状态",type:"warning",description:"服务器离线时无法管理防火墙规则，请先连接服务器","show-icon":"",closable:!1}}),t("div",{staticClass:"server-offline"},[t("i",{staticClass:"el-icon-connection"}),t("h3",[e._v("服务器未连接")]),t("p",[e._v("当前无法管理防火墙规则，请先连接服务器")])]),t("div",{staticClass:"offline-actions"},[t("el-button",{attrs:{type:"primary",loading:e.connecting,icon:"el-icon-refresh"},on:{click:e.tryConnectServer}},[e._v("连接服务器")]),t("el-button",{attrs:{icon:"el-icon-back"},on:{click:function(t){return e.$router.push("/servers")}}},[e._v("返回服务器列表")])],1)]],2),t("el-tab-pane",{attrs:{label:"DDoS防御",name:"ddos"}},[e.isServerOnline?t("div",[t("el-card",[t("div",{attrs:{slot:"header"},slot:"header"},[t("span",[e._v("当前防御状态")]),t("el-button",{staticStyle:{float:"right",padding:"3px 0"},attrs:{type:"text",loading:e.loadingDefenseStatus},on:{click:e.refreshDefenseStatus}},[e._v("刷新")])],1),e.defenseStatus?t("pre",{staticClass:"output"},[e._v(e._s(e.defenseStatus))]):t("div",[e._v("加载中...")])]),t("el-card",{staticStyle:{"margin-top":"20px"}},[t("div",{attrs:{slot:"header"},slot:"header"},[t("span",[e._v("DDoS防御配置")])]),t("el-button-group",[t("el-button",{attrs:{type:"primary",loading:e.loading,disabled:!e.isServerOnline},on:{click:e.setupDdosProtectionAction}},[e._v("配置DDoS防御规则")]),t("el-button",{attrs:{type:"primary",loading:e.loading,disabled:!e.isServerOnline},on:{click:e.showIpListsDialog}},[e._v("管理IP黑白名单")])],1),t("el-divider"),t("h4",[e._v("自定义端口DDoS防御")]),t("el-form",{attrs:{"label-width":"140px"},nativeOn:{submit:function(t){return t.preventDefault(),e.setupCustomPortProtectionAction.apply(null,arguments)}}},[t("el-form-item",{attrs:{label:"端口号"}},[t("el-input",{staticStyle:{width:"200px"},attrs:{placeholder:"如: 8080",disabled:!e.isServerOnline},model:{value:e.customDdosPort,callback:function(t){e.customDdosPort=t},expression:"customDdosPort"}})],1),t("el-form-item",{attrs:{label:"协议类型"}},[t("el-select",{staticStyle:{width:"200px"},attrs:{placeholder:"请选择",disabled:!e.isServerOnline},model:{value:e.customDdosProtoType,callback:function(t){e.customDdosProtoType=t},expression:"customDdosProtoType"}},[t("el-option",{attrs:{label:"TCP",value:1}}),t("el-option",{attrs:{label:"UDP",value:2}}),t("el-option",{attrs:{label:"TCP+UDP",value:3}})],1)],1),t("el-form-item",{attrs:{label:"每IP最大连接数"}},[t("el-input-number",{attrs:{min:100,max:1e3,step:50,disabled:!e.isServerOnline},model:{value:e.customDdosMaxConn,callback:function(t){e.customDdosMaxConn=t},expression:"customDdosMaxConn"}})],1),t("el-form-item",{attrs:{label:"每分钟最大新连接"}},[t("el-input-number",{attrs:{min:100,max:1e3,step:50,disabled:!e.isServerOnline},model:{value:e.customDdosMaxRateMin,callback:function(t){e.customDdosMaxRateMin=t},expression:"customDdosMaxRateMin"}})],1),t("el-form-item",{attrs:{label:"每秒最大新连接"}},[t("el-input-number",{attrs:{min:50,max:500,step:25,disabled:!e.isServerOnline},model:{value:e.customDdosMaxRateSec,callback:function(t){e.customDdosMaxRateSec=t},expression:"customDdosMaxRateSec"}})],1),t("el-form-item",{attrs:{label:"违规IP封禁时长"}},[t("el-input-number",{attrs:{min:1,max:72,step:1,disabled:!e.isServerOnline},model:{value:e.customDdosBanHours,callback:function(t){e.customDdosBanHours=t},expression:"customDdosBanHours"}}),t("span",{staticClass:"form-item-tip"},[e._v("小时")])],1),t("el-form-item",[t("el-button",{attrs:{type:"primary",loading:e.loading,disabled:!e.isServerOnline},on:{click:e.setupCustomPortProtectionAction}},[e._v("配置")])],1)],1)],1)],1):[t("el-alert",{staticStyle:{"margin-bottom":"15px"},attrs:{title:"服务器当前处于离线状态",type:"warning",description:"服务器离线时无法管理DDoS防御，请先连接服务器","show-icon":"",closable:!1}}),t("div",{staticClass:"server-offline"},[t("i",{staticClass:"el-icon-connection"}),t("h3",[e._v("服务器未连接")]),t("p",[e._v("当前无法管理DDoS防御，请先连接服务器")])]),t("div",{staticClass:"offline-actions"},[t("el-button",{attrs:{type:"primary",loading:e.connecting,icon:"el-icon-refresh"},on:{click:e.tryConnectServer}},[e._v("连接服务器")]),t("el-button",{attrs:{icon:"el-icon-back"},on:{click:function(t){return e.$router.push("/servers")}}},[e._v("返回服务器列表")])],1)]],2)],1):e._e(),t("el-dialog",{attrs:{title:"IP黑白名单管理",visible:e.ipListsDialogVisible,width:"600px","close-on-click-modal":!1},on:{"update:visible":function(t){e.ipListsDialogVisible=t}}},[t("el-tabs",{model:{value:e.ipListsActiveTab,callback:function(t){e.ipListsActiveTab=t},expression:"ipListsActiveTab"}},[t("el-tab-pane",{attrs:{label:"添加IP白名单",name:"addWhite"}},[t("el-form",{attrs:{"label-width":"120px"}},[t("el-form-item",{attrs:{label:"IP地址"}},[t("el-input",{attrs:{placeholder:"如: 192.168.1.1"},model:{value:e.ipToManage,callback:function(t){e.ipToManage=t},expression:"ipToManage"}})],1),t("el-form-item",{attrs:{label:"有效期(天)"}},[t("el-input-number",{attrs:{min:0,max:365,step:1},model:{value:e.ipDuration,callback:function(t){e.ipDuration=t},expression:"ipDuration"}}),t("span",{staticClass:"form-item-tip"},[e._v("0表示永久")])],1),t("el-form-item",[t("el-button",{attrs:{type:"primary",loading:e.loading},on:{click:e.addToWhitelist}},[e._v("添加到白名单")])],1)],1)],1),t("el-tab-pane",{attrs:{label:"添加IP黑名单",name:"addBlack"}},[t("el-form",{attrs:{"label-width":"120px"}},[t("el-form-item",{attrs:{label:"IP地址"}},[t("el-input",{attrs:{placeholder:"如: 192.168.1.1"},model:{value:e.ipToManage,callback:function(t){e.ipToManage=t},expression:"ipToManage"}})],1),t("el-form-item",{attrs:{label:"有效期(小时)"}},[t("el-input-number",{attrs:{min:0,max:720,step:1},model:{value:e.ipDuration,callback:function(t){e.ipDuration=t},expression:"ipDuration"}}),t("span",{staticClass:"form-item-tip"},[e._v("0表示永久")])],1),t("el-form-item",[t("el-button",{attrs:{type:"danger",loading:e.loading},on:{click:e.addToBlacklist}},[e._v("添加到黑名单")])],1)],1)],1),t("el-tab-pane",{attrs:{label:"从白名单移除",name:"removeWhite"}},[t("el-form",{attrs:{"label-width":"120px"}},[t("el-form-item",{attrs:{label:"IP地址"}},[t("el-input",{attrs:{placeholder:"如: 192.168.1.1"},model:{value:e.ipToManage,callback:function(t){e.ipToManage=t},expression:"ipToManage"}})],1),t("el-form-item",[t("el-button",{attrs:{type:"warning",loading:e.loading},on:{click:e.removeFromWhitelist}},[e._v("从白名单移除")])],1)],1)],1),t("el-tab-pane",{attrs:{label:"从黑名单移除",name:"removeBlack"}},[t("el-form",{attrs:{"label-width":"120px"}},[t("el-form-item",{attrs:{label:"IP地址"}},[t("el-input",{attrs:{placeholder:"如: 192.168.1.1"},model:{value:e.ipToManage,callback:function(t){e.ipToManage=t},expression:"ipToManage"}})],1),t("el-form-item",[t("el-button",{attrs:{type:"warning",loading:e.loading},on:{click:e.removeFromBlacklist}},[e._v("从黑名单移除")])],1)],1)],1)],1),e.ipManageResult?t("div",{staticClass:"ip-manage-result"},[t("pre",[e._v(e._s(e.ipManageResult))])]):e._e(),t("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.ipListsDialogVisible=!1}}},[e._v("关闭")]),t("el-button",{attrs:{type:"primary"},on:{click:function(t){e.ipListsDialogVisible=!1}}},[e._v("完成")])],1)],1),e.scriptCheckLoading&&e.isServerOnline?t("div",{staticClass:"loading-container"},[t("el-card",[t("div",{staticClass:"loading-content"},[t("i",{staticClass:"el-icon-loading"}),t("p",[e._v("正在检查服务器脚本状态...")])])])],1):e._e()],1)},z=[function(){var e=this,t=e._self._c;return t("div",{staticClass:"deploy-intro"},[t("i",{staticClass:"el-icon-warning"}),t("h3",[e._v("需要部署Nftato脚本")]),t("p",[e._v("Nftato脚本是防火墙规则管理的核心组件，使用此脚本可以更方便地管理nftables规则。")]),t("p",[e._v('点击"开始部署"按钮开始部署过程。')])])}],U=r(32362),F=r(45929),W=r(15060),j=(r(16280),r(76918),r(64346),r(58940),r(27495),r(38781),r(31415),r(17642),r(58004),r(33853),r(45876),r(32475),r(15024),r(31698),r(71761),r(42762),r(61221));const q={name:"RulesView",props:{serverId:{type:String,required:!0}},data:function(){return{activeTab:"inbound",loading:!1,deploying:!1,connecting:!1,loadingPorts:!1,loadingIPs:!1,loadingSSHPort:!1,loadingBlockList:!1,loadingDefenseStatus:!1,loadingDeployment:!1,loadingRefreshAll:!1,server:null,blockList:"",sshPortStatus:"",sshPort:null,inboundPorts:[],inboundIPs:[],commandOutput:"",customPorts:"",customKeyword:"",customUnblockPorts:"",portToAllow:"",ipToAllow:"",isInitialized:!1,initStepActive:0,initializationSteps:[{name:"检查状态",done:!1},{name:"连接服务器",done:!1},{name:"部署脚本",done:!1},{name:"加载规则",done:!1}],debugging:!1,debugInfo:"",statusCheckTimer:null,dataCache:{blockList:null,sshPortStatus:null,inboundPorts:null,inboundIPs:null},cacheTTL:{blockList:6e4,sshPortStatus:6e4,inboundPorts:6e4,inboundIPs:6e4},cacheTimestamps:{blockList:0,sshPortStatus:0,inboundPorts:0,inboundIPs:0},dataLoaded:{blockList:!1,sshPortStatus:!1,inboundPorts:!1,inboundIPs:!1},serverCacheAvailable:!1,serverCacheLastUpdate:null,defenseStatus:"",customDdosPort:"",customDdosProtoType:1,customDdosMaxConn:500,customDdosMaxRateMin:500,customDdosMaxRateSec:250,customDdosBanHours:24,ipListsDialogVisible:!1,ipListsActiveTab:"addWhite",ipToManage:"",ipDuration:0,ipManageResult:"",retryConfig:{maxRetries:2,retryDelay:1e3},criticalPorts:[22,80,443,3306,6379,8080,8443,27017,5432],ipOperationDebounce:{timer:null,lastIp:"",lastAction:null,cooldown:!1,timeout:2e3},scriptExists:!1,scriptCheckLoading:!0,deployLogs:[],socket:null,deployRoomId:null,deployComplete:!1,deploySuccess:!1}},computed:(0,i.A)((0,i.A)({},(0,u.L8)("servers",["getLoading"])),{},{hasValidServerId:function(){return this.serverId&&this.serverId.length>0},isServerOnline:function(){return this.server&&"online"===this.server.status},formattedPorts:function(){var e=this.dataCache.inboundPorts;if(!e)return[];if(Array.isArray(e))return e;if(e.tcp||e.udp){var t=Array.isArray(e.tcp)?e.tcp:[],r=Array.isArray(e.udp)?e.udp:[],n=(0,W.A)(new Set([].concat((0,W.A)(t),(0,W.A)(r))));return n.map((function(e){return{port:e,protocol:"TCP/UDP"}}))}return[]},serverStatusText:function(){if(!this.server)return"未知";switch(this.server.status){case"online":return"在线";case"offline":return"离线";case"connecting":return"连接中";case"disconnecting":return"断开中";default:return"未知状态"}},isServerAvailable:function(){return this.server&&["online","connecting"].includes(this.server.status)},isServerTransitioning:function(){return this.server&&["connecting","disconnecting"].includes(this.server.status)}}),beforeRouteEnter:function(e,t,r){e.params.serverId?r():r((function(e){e.$message.error("未指定服务器ID，请先选择服务器"),e.$router.push("/servers")}))},created:function(){var e=this;this.activeTab="inbound",this.hasValidServerId?(this.$nextTick((0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.initializeApplication();case 2:case"end":return t.stop()}}),t)})))),this.startServerStatusCheck()):this.handleInvalidServerId()},beforeDestroy:function(){this.stopServerStatusCheck(),this.socket&&(this.socket.disconnect(),this.socket=null)},methods:(0,i.A)((0,i.A)((0,i.A)({},(0,u.i0)("servers",["getServer","deployIptato","connectServer","testSSHConnection","checkScriptExists","resetConnectionStatus"])),(0,u.i0)("rules",["getBlockList","blockSPAMAction","blockCustomPortsAction",,"unblockSPAMAction","unblockCustomPortsAction","getInboundPorts","getInboundIPs","allowInboundPortsAction","disallowInboundPortsAction","allowInboundIPsAction","disallowInboundIPsAction","getSSHPort","clearAllRulesAction","getServerCache","getCacheLastUpdate","clearServerCache","updateCacheItem","setupDdosProtection","setupCustomPortProtection","manageIpLists","getDefenseStatus"])),{},(B={initializeApplication:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(t.prev=0,e.loading=!0,e.isInitialized=!1,e.scriptCheckLoading=!0,e.hasValidServerId){t.next=7;break}return e.$message.error("未指定服务器ID"),t.abrupt("return",!1);case 7:return t.next=9,e.getServer(e.serverId);case 9:if(r=t.sent,r&&r.success){t.next=12;break}throw new Error((null===r||void 0===r?void 0:r.error)||"获取服务器信息失败");case 12:return e.server=r.data,t.next=15,e.loadServerCache();case 15:if(n=t.sent,n&&(e.commandOutput+="\n已成功加载服务器缓存数据"),e.server.status&&"online"===e.server.status){t.next=31;break}return e.connecting=!0,t.prev=19,t.next=22,e.connectServer(e.serverId);case 22:e.connecting=!1,t.next=31;break;case 25:if(t.prev=25,t.t0=t["catch"](19),e.connecting=!1,n){t.next=30;break}throw new Error("连接服务器失败: ".concat(t.t0.message));case 30:e.$message.warning("连接服务器失败: ".concat(t.t0.message,"，将使用缓存数据"));case 31:if(!e.isServerOnline){t.next=45;break}return t.prev=32,t.next=35,e.checkScriptExists(e.serverId);case 35:s=t.sent,s&&s.success?e.scriptExists=s.exists:e.scriptExists=!1,t.next=43;break;case 39:t.prev=39,t.t1=t["catch"](32),console.error("检查脚本状态失败:",t.t1),e.scriptExists=!1;case 43:t.next=46;break;case 45:e.scriptExists=!!n;case 46:return e.isInitialized=!0,e.scriptCheckLoading=!1,e.loading=!1,e.isServerOnline&&e.scriptExists&&!e.dataLoaded?(e.dataLoaded=!0,setTimeout((function(){e.refreshAllData()}),500)):n&&e.loadCachedData(),t.abrupt("return",!0);case 53:return t.prev=53,t.t2=t["catch"](0),e.loading=!1,e.connecting=!1,e.scriptCheckLoading=!1,e.isInitialized=!1,e.$message.error("初始化失败: ".concat(t.t2.message)),console.error("初始化错误:",t.t2),t.abrupt("return",!1);case 62:case"end":return t.stop()}}),t,null,[[0,53],[19,25],[32,39]])})))()},refreshAllData:function(){this.scriptExists&&this.isServerOnline?"inbound"===this.activeTab?(this.refreshSSHPort(),this.refreshInboundPorts(),this.refreshInboundIPs()):"outbound"===this.activeTab?this.refreshBlockList():"ddos"===this.activeTab&&this.refreshDefenseStatus():console.log("脚本未部署或服务器离线，跳过加载数据")},refreshSSHPort:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.scriptExists&&e.isServerOnline){t.next=3;break}return console.log("脚本未部署或服务器离线，跳过加载SSH端口"),t.abrupt("return");case 3:if(e.hasValidServerId){t.next=6;break}return e.$message.error("未指定服务器ID，无法获取SSH端口"),t.abrupt("return");case 6:if(r=Date.now(),!(e.dataCache.sshPortStatus&&r-e.cacheTimestamps.sshPortStatus<e.cacheTTL.sshPortStatus)){t.next=11;break}return e.sshPortStatus=e.dataCache.sshPortStatus,console.log("使用缓存的SSH端口数据"),t.abrupt("return");case 11:n=0,s=e.retryConfig.maxRetries;case 13:if(!(n<=s)){t.next=59;break}return t.prev=14,e.loadingSSHPort=!0,t.next=18,e.getSSHPort(e.serverId);case 18:if(a=t.sent,!a||!a.success){t.next=30;break}return e.sshPortStatus=a.data||"无SSH端口数据",e.dataCache.sshPortStatus=e.sshPortStatus,e.cacheTimestamps.sshPortStatus=r,e.dataLoaded.sshPortStatus=!0,t.next=26,e.updateServerCacheItem("sshPortStatus",e.sshPortStatus);case 26:try{o=a.data,o&&"string"===typeof o&&(c=o.match(/SSH端口\s*[:：]\s*(\d+)/i)||o.match(/端口\s*[:：]\s*(\d+)/i)||o.match(/port\s*[:：]\s*(\d+)/i),c&&c[1]&&(e.sshPort=parseInt(c[1],10),console.log("已识别SSH端口: ".concat(e.sshPort))))}catch(i){console.error("解析SSH端口数据出错:",i),e.server&&e.server.port&&(e.sshPort=e.server.port,console.log("使用服务器配置的端口: ".concat(e.sshPort)))}return t.abrupt("break",59);case 30:if(!(n<s&&e.retryConfig.enabled)){t.next=37;break}return n++,e.commandOutput+="\n获取SSH端口失败，第".concat(n,"次重试..."),t.next=35,new Promise((function(t){return setTimeout(t,e.retryConfig.delay)}));case 35:t.next=40;break;case 37:return e.$message.warning((null===a||void 0===a?void 0:a.error)||"获取SSH端口失败"),e.sshPortStatus="获取SSH端口失败",t.abrupt("break",59);case 40:t.next=54;break;case 42:if(t.prev=42,t.t0=t["catch"](14),!(n<s&&e.retryConfig.enabled)){t.next=51;break}return n++,e.commandOutput+="\n获取SSH端口错误，第".concat(n,"次重试..."),t.next=49,new Promise((function(t){return setTimeout(t,e.retryConfig.delay)}));case 49:t.next=54;break;case 51:return e.$message.error("获取SSH端口错误: ".concat(t.t0.message)),e.sshPortStatus="获取失败: ".concat(t.t0.message),t.abrupt("break",59);case 54:return t.prev=54,(n>=s||!e.retryConfig.enabled)&&(e.loadingSSHPort=!1),t.finish(54);case 57:t.next=13;break;case 59:e.loadingSSHPort=!1;case 60:case"end":return t.stop()}}),t,null,[[14,42,54,57]])})))()},refreshInboundPorts:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.scriptExists&&e.isServerOnline){t.next=4;break}return console.log("脚本未部署或服务器离线，跳过加载入网端口"),e.dataCache.inboundPorts={tcp:[],udp:[]},t.abrupt("return");case 4:if(e.hasValidServerId){t.next=8;break}return e.$message.error("未指定服务器ID，无法获取入网端口"),e.dataCache.inboundPorts={tcp:[],udp:[]},t.abrupt("return");case 8:if(r=Date.now(),!(e.dataCache.inboundPorts&&r-e.cacheTimestamps.inboundPorts<e.cacheTTL.inboundPorts)){t.next=12;break}return console.log("使用缓存的入网端口数据"),t.abrupt("return");case 12:n=0,s=e.retryConfig.maxRetries;case 14:if(!(n<=s)){t.next=71;break}return t.prev=15,e.loadingPorts=!0,t.next=19,e.getInboundPorts(e.serverId);case 19:if(a=t.sent,!a||!a.success){t.next=42;break}if(o=a.data||{},!Array.isArray(o)){t.next=36;break}if(c=o.map((function(e){return e.port})),e.dataCache.inboundPorts={tcp:c,udp:c},t.prev=25,!e.hasValidServerId){t.next=29;break}return t.next=29,e.updateServerCacheItem("inboundPorts",e.dataCache.inboundPorts);case 29:t.next=34;break;case 31:t.prev=31,t.t0=t["catch"](25),console.error("更新服务器缓存失败:",t.t0);case 34:t.next=37;break;case 36:o.tcp||o.udp?e.dataCache.inboundPorts=o:e.dataCache.inboundPorts={tcp:[],udp:[]};case 37:return e.cacheTimestamps.inboundPorts=r,e.dataLoaded.inboundPorts=!0,t.abrupt("break",71);case 42:if(!(n<s&&e.retryConfig.enabled)){t.next=49;break}return n++,e.commandOutput+="\n获取入网端口失败，第".concat(n,"次重试..."),t.next=47,new Promise((function(t){return setTimeout(t,e.retryConfig.delay)}));case 47:t.next=52;break;case 49:return e.$message.warning((null===a||void 0===a?void 0:a.error)||"获取入网端口失败"),e.dataCache.inboundPorts={tcp:[],udp:[]},t.abrupt("break",71);case 52:t.next=66;break;case 54:if(t.prev=54,t.t1=t["catch"](15),!(n<s&&e.retryConfig.enabled)){t.next=63;break}return n++,e.commandOutput+="\n获取入网端口错误，第".concat(n,"次重试..."),t.next=61,new Promise((function(t){return setTimeout(t,e.retryConfig.delay)}));case 61:t.next=66;break;case 63:return e.$message.error("获取入网端口错误: ".concat(t.t1.message)),e.dataCache.inboundPorts={tcp:[],udp:[]},t.abrupt("break",71);case 66:return t.prev=66,(n>=s||!e.retryConfig.enabled)&&(e.loadingPorts=!1),t.finish(66);case 69:t.next=14;break;case 71:e.loadingPorts=!1;case 72:case"end":return t.stop()}}),t,null,[[15,54,66,69],[25,31]])})))()},refreshInboundIPs:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.scriptExists&&e.isServerOnline){t.next=4;break}return console.log("脚本未部署或服务器离线，跳过加载入网IP"),e.inboundIPs=[],t.abrupt("return");case 4:if(e.hasValidServerId){t.next=8;break}return e.$message.error("未指定服务器ID，无法获取入网IP"),e.inboundIPs=[],t.abrupt("return");case 8:if(console.log("缓存inboundIPs已失效"),r=Date.now(),!(e.dataCache.inboundIPs&&Array.isArray(e.dataCache.inboundIPs)&&r-e.cacheTimestamps.inboundIPs<e.cacheTTL.inboundIPs)){t.next=14;break}return e.inboundIPs=(0,W.A)(e.dataCache.inboundIPs),console.log("使用缓存的入网IP数据"),t.abrupt("return");case 14:n=0,s=e.retryConfig.maxRetries,a=(0,$.A)().mark((function t(){var a,o,c,i;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,e.loadingIPs=!0,t.next=4,e.getInboundIPs(e.serverId);case 4:if(a=t.sent,!a||!a.success){t.next=24;break}if(o=a.data||[],Array.isArray(o))e.inboundIPs=o.map((function(e){return"string"===typeof e?{ip:e}:e}));else if(o&&"object"===(0,F.A)(o)){e.inboundIPs=[];try{if(Object.keys(o).length>0){for(i in c=[],o)"string"===typeof o[i]?c.push({ip:o[i]}):Array.isArray(o[i])&&o[i].forEach((function(e){"string"===typeof e?c.push({ip:e}):"object"===(0,F.A)(e)&&e.ip&&c.push(e)}));e.inboundIPs=c}}catch(u){console.error("解析IP数据出错:",u),e.inboundIPs=[]}}else e.inboundIPs=[];if(e.inboundIPs=e.inboundIPs.filter((function(e){return e&&"object"===(0,F.A)(e)&&"string"===typeof e.ip})),e.dataCache.inboundIPs=(0,W.A)(e.inboundIPs),e.cacheTimestamps.inboundIPs=r,e.dataLoaded.inboundIPs=!0,t.prev=12,!e.hasValidServerId){t.next=16;break}return t.next=16,e.updateServerCacheItem("inboundIPs",e.inboundIPs);case 16:t.next=21;break;case 18:t.prev=18,t.t0=t["catch"](12),console.error("更新服务器缓存失败:",t.t0);case 21:return t.abrupt("return",0);case 24:if(!(n<s&&e.retryConfig.enabled)){t.next=31;break}return n++,e.commandOutput+="\n获取入网IP失败，第".concat(n,"次重试..."),t.next=29,new Promise((function(t){return setTimeout(t,e.retryConfig.delay)}));case 29:t.next=34;break;case 31:return e.$message.warning((null===a||void 0===a?void 0:a.error)||"获取入网IP失败"),e.inboundIPs=[],t.abrupt("return",0);case 34:t.next=48;break;case 36:if(t.prev=36,t.t1=t["catch"](0),!(n<s&&e.retryConfig.enabled)){t.next=45;break}return n++,e.commandOutput+="\n获取入网IP错误，第".concat(n,"次重试..."),t.next=43,new Promise((function(t){return setTimeout(t,e.retryConfig.delay)}));case 43:t.next=48;break;case 45:return e.$message.error("获取入网IP错误: ".concat(t.t1.message)),e.inboundIPs=[],t.abrupt("return",0);case 48:return t.prev=48,(n>=s||!e.retryConfig.enabled)&&(e.loadingIPs=!1),t.finish(48);case 51:case"end":return t.stop()}}),t,null,[[0,36,48,51],[12,18]])}));case 17:if(!(n<=s)){t.next=24;break}return t.delegateYield(a(),"t0",19);case 19:if(o=t.t0,0!==o){t.next=22;break}return t.abrupt("break",24);case 22:t.next=17;break;case 24:e.loadingIPs=!1,Array.isArray(e.inboundIPs)||(e.inboundIPs=[]),c=(0,W.A)(e.inboundIPs),e.$nextTick((function(){e.inboundIPs=[],e.$nextTick((function(){e.inboundIPs=c}))}));case 28:case"end":return t.stop()}}),t)})))()},refreshBlockList:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.scriptExists&&e.isServerOnline){t.next=3;break}return console.log("脚本未部署或服务器离线，跳过加载阻止列表"),t.abrupt("return");case 3:if(e.hasValidServerId){t.next=6;break}return e.$message.error("未指定服务器ID，无法获取阻止列表"),t.abrupt("return");case 6:if(r=Date.now(),!(e.dataCache.blockList&&r-e.cacheTimestamps.blockList<e.cacheTTL.blockList)){t.next=11;break}return e.blockList=e.dataCache.blockList,console.log("使用缓存的阻止列表数据"),t.abrupt("return");case 11:n=0,s=e.retryConfig.maxRetries;case 13:if(!(n<=s)){t.next=58;break}return t.prev=14,e.loadingBlockList=!0,t.next=18,e.getBlockList(e.serverId);case 18:if(a=t.sent,!a||!a.success){t.next=29;break}return e.blockList=a.data||"无阻止列表数据",e.dataCache.blockList=e.blockList,e.cacheTimestamps.blockList=r,e.dataLoaded.blockList=!0,t.next=26,e.updateServerCacheItem("blockList",e.blockList);case 26:return t.abrupt("break",58);case 29:if(!(n<s&&e.retryConfig.enabled)){t.next=36;break}return n++,e.commandOutput+="\n获取阻止列表失败，第".concat(n,"次重试..."),t.next=34,new Promise((function(t){return setTimeout(t,e.retryConfig.delay)}));case 34:t.next=39;break;case 36:return e.$message.warning((null===a||void 0===a?void 0:a.error)||"获取阻止列表失败"),e.blockList="获取阻止列表失败",t.abrupt("break",58);case 39:t.next=53;break;case 41:if(t.prev=41,t.t0=t["catch"](14),!(n<s&&e.retryConfig.enabled)){t.next=50;break}return n++,e.commandOutput+="\n获取阻止列表错误，第".concat(n,"次重试..."),t.next=48,new Promise((function(t){return setTimeout(t,e.retryConfig.delay)}));case 48:t.next=53;break;case 50:return e.$message.error("获取阻止列表错误: ".concat(t.t0.message)),e.blockList="获取失败: ".concat(t.t0.message),t.abrupt("break",58);case 53:return t.prev=53,(n>=s||!e.retryConfig.enabled)&&(e.loadingBlockList=!1),t.finish(53);case 56:t.next=13;break;case 58:e.loadingBlockList=!1;case 59:case"end":return t.stop()}}),t,null,[[14,41,53,56]])})))()},refreshDefenseStatus:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.scriptExists&&e.isServerOnline){t.next=3;break}return console.log("脚本未部署或服务器离线，跳过加载防御状态"),t.abrupt("return");case 3:if(e.hasValidServerId){t.next=6;break}return e.$message.error("未指定服务器ID，无法获取防御状态"),t.abrupt("return");case 6:return t.prev=6,e.loadingDefenseStatus=!0,t.next=10,e.getDefenseStatus(e.serverId);case 10:r=t.sent,r&&r.success?(e.defenseStatus=r.data||"未启用",e.dataLoaded.defenseStatus=!0):(e.$message.warning((null===r||void 0===r?void 0:r.error)||"获取防御状态失败"),e.defenseStatus="未知"),t.next=18;break;case 14:t.prev=14,t.t0=t["catch"](6),e.$message.error("获取防御状态错误: ".concat(t.t0.message)),e.defenseStatus="错误";case 18:return t.prev=18,e.loadingDefenseStatus=!1,t.finish(18);case 21:case"end":return t.stop()}}),t,null,[[6,14,18,21]])})))()},handleTabClick:function(e){this.scriptExists&&this.isServerOnline?"inbound"!==e.name||this.dataLoaded.inboundPorts?"outbound"!==e.name||this.dataLoaded.blockList?"ddos"!==e.name||this.dataLoaded.defenseStatus||this.refreshDefenseStatus():this.refreshBlockList():(this.refreshSSHPort(),this.refreshInboundPorts(),this.refreshInboundIPs()):console.log("脚本未部署或服务器离线，跳过标签页数据加载")},handleInvalidServerId:function(){this.commandOutput="服务器ID无效，请返回服务器列表重新选择服务器",this.$message.error("服务器ID无效")},handleInitializationFailure:function(){this.$message.warning("应用初始化未完成，某些功能可能不可用"),this.commandOutput+="\n初始化未完成，请检查服务器连接状态或手动初始化"},handleInitializationError:function(e){this.$message.error("初始化出错: ".concat(e.message)),this.commandOutput+="\n初始化过程中出错: ".concat(e.message),console.error("应用初始化错误:",e)},checkInitialization:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(t.prev=0,e.hasValidServerId){t.next=5;break}return e.commandOutput="错误：未指定服务器ID，请返回服务器列表选择服务器",e.$message.error("未指定服务器ID"),t.abrupt("return",!1);case 5:return e.resetInitSteps(),e.isInitialized=!1,e.initStepActive=0,e.commandOutput="正在检查服务器状态...",e.loading=!0,t.next=12,e.getServer(e.serverId);case 12:if(r=t.sent,r&&r.success){t.next=15;break}throw new Error((null===r||void 0===r?void 0:r.error)||"获取服务器信息失败");case 15:return e.server=r.data,e.initializationSteps[0].done=!0,e.initStepActive=1,t.next=20,e.loadServerCache();case 20:if(n=t.sent,n&&(e.commandOutput+="\n已成功加载服务器缓存数据"),e.server.status&&"online"===e.server.status){t.next=47;break}return e.commandOutput+="\n服务器未连接，正在尝试连接...",e.connecting=!0,t.next=27,e.connectServer(e.serverId);case 27:if(s=t.sent,e.connecting=!1,s&&s.success){t.next=44;break}if(!n){t.next=43;break}return e.$message.warning("服务器连接失败，将使用缓存数据"),e.commandOutput+="\n服务器连接失败，将使用缓存数据",e.initializationSteps[1].done=!0,e.initStepActive=2,e.initializationSteps[2].done=!0,e.initStepActive=3,e.initializationSteps[3].done=!0,e.isInitialized=!0,e.loading=!1,t.abrupt("return",!0);case 43:throw new Error((null===s||void 0===s?void 0:s.error)||"连接服务器失败");case 44:e.commandOutput+="\n服务器连接成功",t.next=50;break;case 47:e.commandOutput+="\n服务器已连接，跳过连接步骤",e.initializationSteps[1].done=!0,e.initStepActive=2;case 50:if(n&&!e.deploying){t.next=79;break}return e.commandOutput+="\n检查脚本部署情况...",e.deploying=!0,t.prev=53,t.next=56,e.deployIptato(e.serverId);case 56:if(a=t.sent,e.deploying=!1,a&&a.success){t.next=64;break}throw o=(null===a||void 0===a?void 0:a.error)||"脚本部署失败",e.commandOutput+="\n脚本部署失败: ".concat(o),(o.includes("500")||o.includes("内部错误"))&&(e.commandOutput+="\n服务器内部错误，可能原因：",e.commandOutput+="\n1. 服务器磁盘空间不足",e.commandOutput+="\n2. 服务器防火墙限制了文件上传",e.commandOutput+="\n3. 服务器缺少必要的依赖包",e.commandOutput+="\n\n建议操作：",e.commandOutput+="\n- 检查服务器连接状态",e.commandOutput+="\n- 查看服务器日志获取详细错误信息",e.commandOutput+="\n- 尝试手动连接服务器并安装依赖"),e.$message.error("脚本部署失败: ".concat(o)),new Error(o);case 64:e.commandOutput+="\n脚本部署成功",t.next=77;break;case 67:if(t.prev=67,t.t0=t["catch"](53),e.deploying=!1,e.commandOutput+="\n脚本部署过程中出错: ".concat(t.t0.message),!n){t.next=76;break}e.$message.warning("脚本部署失败，将使用缓存数据"),e.commandOutput+="\n将使用缓存数据继续",t.next=77;break;case 76:throw t.t0;case 77:t.next=80;break;case 79:e.commandOutput+="\n使用已有缓存数据，跳过脚本部署检查";case 80:return e.initializationSteps[2].done=!0,e.initStepActive=3,e.initializationSteps[3].done=!0,e.isInitialized=!0,e.loading=!1,e.isServerOnline&&(c=[],e.dataLoaded.blockList||c.push("blockList"),e.dataLoaded.sshPortStatus||c.push("sshPortStatus"),e.dataLoaded.inboundPorts||c.push("inboundPorts"),e.dataLoaded.inboundIPs||c.push("inboundIPs"),c.length>0&&setTimeout((function(){return e.refreshSelectedData(c)}),500)),t.abrupt("return",!0);case 89:return t.prev=89,t.t1=t["catch"](0),e.loading=!1,e.deploying=!1,e.connecting=!1,e.commandOutput+="\n初始化失败: ".concat(t.t1.message),e.$message.error("初始化失败: ".concat(t.t1.message)),t.abrupt("return",!1);case 97:case"end":return t.stop()}}),t,null,[[0,89],[53,67]])})))()},resetInitSteps:function(){this.initializationSteps.forEach((function(e){return e.done=!1}))},deployScript:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.isServerOnline){t.next=3;break}return e.$message.error("服务器离线，无法部署脚本"),t.abrupt("return");case 3:return t.prev=3,e.deploying=!0,e.deployLogs=[],e.deployComplete=!1,e.deploySuccess=!1,e.initWebSocket(),e.deployLogs.push({type:"log",message:"正在准备部署Nftato脚本..."}),t.next=12,e.deployIptatoWithWebSocket(e.serverId);case 12:if(r=t.sent,r&&r.success){t.next=15;break}throw new Error((null===r||void 0===r?void 0:r.error)||"开始部署过程失败");case 15:e.deployLogs.push({type:"log",message:"脚本部署已开始，正在执行..."}),t.next=26;break;case 18:t.prev=18,t.t0=t["catch"](3),e.deployComplete=!0,e.deploySuccess=!1,e.deploying=!1,e.deployLogs.push({type:"error",message:"部署失败: ".concat(t.t0.message)}),e.$message.error("部署脚本失败: ".concat(t.t0.message)),e.fallbackToNormalDeploy();case 26:case"end":return t.stop()}}),t,null,[[3,18]])})))()},fallbackToNormalDeploy:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,e.deployLogs.push({type:"log",message:"实时部署失败，尝试使用常规部署方法..."}),e.deploying=!0,t.next=5,e.deployIptato(e.serverId);case 5:r=t.sent,r&&r.success?(e.deployLogs.push({type:"success",message:"使用常规方法部署成功"}),e.deploySuccess=!0,e.scriptExists=!0,setTimeout((function(){e.clearServerCacheAfterChange(),e.refreshAllData()}),1e3)):e.deployLogs.push({type:"error",message:"常规部署也失败: ".concat((null===r||void 0===r?void 0:r.error)||"未知错误")}),t.next=12;break;case 9:t.prev=9,t.t0=t["catch"](0),e.deployLogs.push({type:"error",message:"常规部署错误: ".concat(t.t0.message)});case 12:return t.prev=12,e.deployComplete=!0,e.deploying=!1,t.finish(12);case 16:case"end":return t.stop()}}),t,null,[[0,9,12,16]])})))()},retryDeploy:function(){this.deployLogs=[],this.deployComplete=!1,this.deploySuccess=!1,this.deployScript()}},(0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)(B,"handleInvalidServerId",(function(){this.commandOutput="服务器ID无效，请返回服务器列表重新选择服务器",this.$message.error("服务器ID无效")})),"handleInitializationFailure",(function(){this.$message.warning("应用初始化未完成，某些功能可能不可用"),this.commandOutput+="\n初始化未完成，请检查服务器连接状态或手动初始化"})),"handleInitializationError",(function(e){this.$message.error("初始化出错: ".concat(e.message)),this.commandOutput+="\n初始化过程中出错: ".concat(e.message),console.error("应用初始化错误:",e)})),"checkInitialization",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(t.prev=0,e.hasValidServerId){t.next=5;break}return e.commandOutput="错误：未指定服务器ID，请返回服务器列表选择服务器",e.$message.error("未指定服务器ID"),t.abrupt("return",!1);case 5:return e.resetInitSteps(),e.isInitialized=!1,e.initStepActive=0,e.commandOutput="正在检查服务器状态...",e.loading=!0,t.next=12,e.getServer(e.serverId);case 12:if(r=t.sent,r&&r.success){t.next=15;break}throw new Error((null===r||void 0===r?void 0:r.error)||"获取服务器信息失败");case 15:return e.server=r.data,e.initializationSteps[0].done=!0,e.initStepActive=1,t.next=20,e.loadServerCache();case 20:if(n=t.sent,n&&(e.commandOutput+="\n已成功加载服务器缓存数据"),e.server.status&&"online"===e.server.status){t.next=47;break}return e.commandOutput+="\n服务器未连接，正在尝试连接...",e.connecting=!0,t.next=27,e.connectServer(e.serverId);case 27:if(s=t.sent,e.connecting=!1,s&&s.success){t.next=44;break}if(!n){t.next=43;break}return e.$message.warning("服务器连接失败，将使用缓存数据"),e.commandOutput+="\n服务器连接失败，将使用缓存数据",e.initializationSteps[1].done=!0,e.initStepActive=2,e.initializationSteps[2].done=!0,e.initStepActive=3,e.initializationSteps[3].done=!0,e.isInitialized=!0,e.loading=!1,t.abrupt("return",!0);case 43:throw new Error((null===s||void 0===s?void 0:s.error)||"连接服务器失败");case 44:e.commandOutput+="\n服务器连接成功",t.next=50;break;case 47:e.commandOutput+="\n服务器已连接，跳过连接步骤",e.initializationSteps[1].done=!0,e.initStepActive=2;case 50:if(n&&!e.deploying){t.next=79;break}return e.commandOutput+="\n检查脚本部署情况...",e.deploying=!0,t.prev=53,t.next=56,e.deployIptato(e.serverId);case 56:if(a=t.sent,e.deploying=!1,a&&a.success){t.next=64;break}throw o=(null===a||void 0===a?void 0:a.error)||"脚本部署失败",e.commandOutput+="\n脚本部署失败: ".concat(o),(o.includes("500")||o.includes("内部错误"))&&(e.commandOutput+="\n服务器内部错误，可能原因：",e.commandOutput+="\n1. 服务器磁盘空间不足",e.commandOutput+="\n2. 服务器防火墙限制了文件上传",e.commandOutput+="\n3. 服务器缺少必要的依赖包",e.commandOutput+="\n\n建议操作：",e.commandOutput+="\n- 检查服务器连接状态",e.commandOutput+="\n- 查看服务器日志获取详细错误信息",e.commandOutput+="\n- 尝试手动连接服务器并安装依赖"),e.$message.error("脚本部署失败: ".concat(o)),new Error(o);case 64:e.commandOutput+="\n脚本部署成功",t.next=77;break;case 67:if(t.prev=67,t.t0=t["catch"](53),e.deploying=!1,e.commandOutput+="\n脚本部署过程中出错: ".concat(t.t0.message),!n){t.next=76;break}e.$message.warning("脚本部署失败，将使用缓存数据"),e.commandOutput+="\n将使用缓存数据继续",t.next=77;break;case 76:throw t.t0;case 77:t.next=80;break;case 79:e.commandOutput+="\n使用已有缓存数据，跳过脚本部署检查";case 80:return e.initializationSteps[2].done=!0,e.initStepActive=3,e.initializationSteps[3].done=!0,e.isInitialized=!0,e.loading=!1,e.isServerOnline&&(c=[],e.dataLoaded.blockList||c.push("blockList"),e.dataLoaded.sshPortStatus||c.push("sshPortStatus"),e.dataLoaded.inboundPorts||c.push("inboundPorts"),e.dataLoaded.inboundIPs||c.push("inboundIPs"),c.length>0&&setTimeout((function(){return e.refreshSelectedData(c)}),500)),t.abrupt("return",!0);case 89:return t.prev=89,t.t1=t["catch"](0),e.loading=!1,e.deploying=!1,e.connecting=!1,e.commandOutput+="\n初始化失败: ".concat(t.t1.message),e.$message.error("初始化失败: ".concat(t.t1.message)),t.abrupt("return",!1);case 97:case"end":return t.stop()}}),t,null,[[0,89],[53,67]])})))()})),"resetInitSteps",(function(){this.initializationSteps.forEach((function(e){return e.done=!1}))})),"deployIptatoManually",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行部署操作"),t.abrupt("return");case 3:return t.prev=3,e.deploying=!0,e.commandOutput="正在尝试手动部署脚本...\n",t.next=8,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:"wget -N --no-check-certificate https://raw.githubusercontent.com/Fiftonb/Gnftato/refs/heads/main/Nftato.sh && chmod +x Nftato.sh && bash Nftato.sh"});case 8:if(r=t.sent,!r||!r.success){t.next=37;break}return e.commandOutput+="手动部署命令执行成功，正在验证安装结果...\n",t.next=13,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:'test -f /root/Nftato.sh && echo "installed" || echo "not found"'});case 13:if(n=t.sent,!(n&&n.success&&n.data&&n.data.stdout&&n.data.stdout.includes("installed"))){t.next=33;break}return e.commandOutput+="脚本已成功安装!\n",e.$message.success("脚本手动部署成功"),e.initializationSteps[2].done=!0,e.initStepActive=3,t.next=21,e.clearServerCacheAfterChange();case 21:return t.next=23,e.refreshBlockList();case 23:return t.next=25,e.refreshSSHPort();case 25:return t.next=27,e.refreshInboundPorts();case 27:return t.next=29,e.refreshInboundIPs();case 29:e.initializationSteps[3].done=!0,e.isInitialized=!0,t.next=35;break;case 33:e.commandOutput+="脚本安装验证失败，请检查服务器环境或联系管理员\n",e.$message.error("脚本安装验证失败");case 35:t.next=39;break;case 37:e.commandOutput+="手动部署失败: ".concat((null===r||void 0===r?void 0:r.error)||"未知错误","\n"),e.$message.error("手动部署失败");case 39:t.next=45;break;case 41:t.prev=41,t.t0=t["catch"](3),e.commandOutput+="手动部署出错: ".concat(t.t0.message,"\n"),e.$message.error("手动部署出错: ".concat(t.t0.message));case 45:return t.prev=45,e.deploying=!1,t.finish(45);case 48:case"end":return t.stop()}}),t,null,[[3,41,45,48]])})))()})),"completeInitialization",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法完成初始化"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,e.commandOutput="正在加载规则信息...\n",t.next=8,e.clearServerCacheAfterChange();case 8:return t.next=10,e.refreshBlockList();case 10:return t.next=12,e.refreshSSHPort();case 12:return t.next=14,e.refreshInboundPorts();case 14:return t.next=16,e.refreshInboundIPs();case 16:e.initializationSteps[3].done=!0,e.isInitialized=!0,e.$message.success("初始化完成"),e.commandOutput+="初始化完成，可以开始管理防火墙规则",t.next=26;break;case 22:t.prev=22,t.t0=t["catch"](3),e.commandOutput+="\n初始化过程中加载规则出错: ".concat(t.t0.message),e.$message.error("加载规则失败: ".concat(t.t0.message));case 26:return t.prev=26,e.loading=!1,t.finish(26);case 29:case"end":return t.stop()}}),t,null,[[3,22,26,29]])})))()})),"clearCommandOutput",(function(){this.commandOutput=""})),"checkScriptExistence",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c,i,u,l,d,p,v;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法检查脚本"),t.abrupt("return");case 3:t.prev=3,e.debugging=!0,e.debugInfo="正在检查脚本存在状态...\n",r=["ls -la /root/Nftato.sh","ls -la /root/Nftato.sh",'find /root -name "*.sh" | grep -i Nftato','find / -name "*.sh" -type f -not -path "*/\\.*" | grep -i Nftato 2>/dev/null'],n=0,s=r;case 8:if(!(n<s.length)){t.next=30;break}return a=s[n],e.debugInfo+="\n执行命令: ".concat(a,"\n"),t.next=13,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:a});case 13:if(o=t.sent,!o||!o.success){t.next=26;break}if(u=(null===(c=o.data)||void 0===c?void 0:c.stdout)||"",l=(null===(i=o.data)||void 0===i?void 0:i.stderr)||"",e.debugInfo+="输出:\n".concat(u,"\n"),l&&(e.debugInfo+="错误:\n".concat(l,"\n")),!u||!u.includes("Nftato.sh")&&!u.includes("Nftato.sh")){t.next=24;break}return e.debugInfo+="\n检测到脚本存在！但前端应用未能识别。\n",e.debugInfo+="这可能是脚本命名不一致或路径不同导致的问题。\n",e.$message.warning("脚本已存在但应用无法识别，请参考调试信息"),t.abrupt("break",30);case 24:t.next=27;break;case 26:e.debugInfo+="命令执行失败: ".concat((null===o||void 0===o?void 0:o.error)||"未知错误","\n");case 27:n++,t.next=8;break;case 30:return e.debugInfo+="\n尝试直接执行脚本...\n",t.next=33,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:'cd /root && (./Nftato.sh --help || ./Nftato.sh --help || echo "无法执行脚本")'});case 33:d=t.sent,d&&d.success?(v=(null===(p=d.data)||void 0===p?void 0:p.stdout)||"",e.debugInfo+="执行脚本输出:\n".concat(v,"\n"),(v.includes("管理脚本")||v.includes("nftables"))&&(e.debugInfo+="\n脚本可以成功执行！\n",e.debugInfo+="建议使用手动初始化功能完成后续步骤。\n",e.$message.success("脚本可以成功执行，但需要手动初始化"))):e.debugInfo+="脚本执行失败: ".concat((null===d||void 0===d?void 0:d.error)||"未知错误","\n"),t.next=41;break;case 37:t.prev=37,t.t0=t["catch"](3),e.debugInfo+="\n检查过程出错: ".concat(t.t0.message,"\n"),e.$message.error("检查出错: ".concat(t.t0.message));case 41:return t.prev=41,e.debugging=!1,t.finish(41);case 44:case"end":return t.stop()}}),t,null,[[3,37,41,44]])})))()})),"testServerConnection",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c,i;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法测试连接"),t.abrupt("return");case 3:return t.prev=3,e.debugging=!0,e.debugInfo="正在测试服务器连接...\n",e.debugInfo+="1. 检查服务器信息:\n",t.next=9,e.getServer(e.serverId);case 9:return r=t.sent,r&&r.success?(e.debugInfo+="服务器信息: ".concat(JSON.stringify(r.data,null,2),"\n"),e.debugInfo+="连接状态: ".concat(r.data.status,"\n")):e.debugInfo+="获取服务器信息失败: ".concat((null===r||void 0===r?void 0:r.error)||"未知错误","\n"),e.debugInfo+="\n尝试重新连接服务器...\n",t.prev=12,t.next=15,e.connectServer(e.serverId);case 15:n=t.sent,n&&n.success?e.debugInfo+="服务器重新连接成功\n":e.debugInfo+="服务器重新连接失败: ".concat((null===n||void 0===n?void 0:n.error)||"未知错误","\n"),t.next=22;break;case 19:t.prev=19,t.t0=t["catch"](12),e.debugInfo+="重新连接出错: ".concat(t.t0.message,"\n");case 22:return e.debugInfo+="\n2. 执行简单命令测试:\n",t.next=25,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:"uname -a && whoami && pwd"});case 25:return s=t.sent,s&&s.success?(e.debugInfo+="命令输出:\n".concat((null===(a=s.data)||void 0===a?void 0:a.stdout)||"","\n"),e.debugInfo+="命令成功执行，服务器连接正常\n"):(e.debugInfo+="命令执行失败: ".concat((null===s||void 0===s?void 0:s.error)||"未知错误","\n"),e.debugInfo+="服务器连接可能存在问题\n"),e.debugInfo+="\n3. 检查前后端连接配置:\n",o={NODE_ENV:"production",BASE_URL:"/"}.VUE_APP_API_URL||window.location.origin,e.debugInfo+="API基础URL: ".concat(o,"\n"),e.debugInfo+="当前连接模式: ".concat("production","\n"),e.debugInfo+="\n4. 检查网络连接:\n",t.prev=32,t.next=35,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:"ping -c 3 8.8.8.8"});case 35:c=t.sent,c&&c.success?e.debugInfo+="ping测试结果:\n".concat((null===(i=c.data)||void 0===i?void 0:i.stdout)||"","\n"):e.debugInfo+="ping测试失败: ".concat((null===c||void 0===c?void 0:c.error)||"未知错误","\n"),t.next=42;break;case 39:t.prev=39,t.t1=t["catch"](32),e.debugInfo+="ping测试错误: ".concat(t.t1.message,"\n");case 42:e.$message.info("连接测试完成，请查看调试信息"),t.next=49;break;case 45:t.prev=45,t.t2=t["catch"](3),e.debugInfo+="\n测试过程出错: ".concat(t.t2.message,"\n"),e.$message.error("测试出错: ".concat(t.t2.message));case 49:return t.prev=49,e.debugging=!1,t.finish(49);case 52:case"end":return t.stop()}}),t,null,[[3,45,49,52],[12,19],[32,39]])})))()})),(0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)(B,"resetConnectionState",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法重置状态"),t.abrupt("return");case 3:return t.prev=3,e.debugging=!0,e.debugInfo="正在重置连接状态...\n",t.prev=6,e.debugInfo+="尝试断开当前连接...\n",t.next=10,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:'echo "测试连接状态重置"'});case 10:r=t.sent,e.debugInfo+="断开连接测试命令执行结果: "+(null!==r&&void 0!==r&&r.success?"成功":"失败")+"\n",t.next=17;break;case 14:t.prev=14,t.t0=t["catch"](6),e.debugInfo+="断开连接测试出错: ".concat(t.t0.message,"\n");case 17:return e.debugInfo+="尝试重新连接服务器...\n",t.prev=18,t.next=21,e.connectServer(e.serverId);case 21:n=t.sent,n&&n.success?e.debugInfo+="服务器重新连接成功\n":e.debugInfo+="服务器重新连接失败: ".concat((null===n||void 0===n?void 0:n.error)||"未知错误","\n"),t.next=28;break;case 25:t.prev=25,t.t1=t["catch"](18),e.debugInfo+="重新连接出错: ".concat(t.t1.message,"\n");case 28:return e.resetInitSteps(),e.isInitialized=!1,e.initStepActive=0,t.next=33,e.checkInitialization();case 33:e.debugInfo+="初始化状态已重置，并重新检查\n",e.$message.success("连接状态已重置"),t.next=41;break;case 37:t.prev=37,t.t2=t["catch"](3),e.debugInfo+="\n重置过程出错: ".concat(t.t2.message,"\n"),e.$message.error("重置出错: ".concat(t.t2.message));case 41:return t.prev=41,e.debugging=!1,t.finish(41);case 44:case"end":return t.stop()}}),t,null,[[3,37,41,44],[6,14],[18,25]])})))()})),"manualInitialize",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法初始化"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,e.commandOutput="正在手动初始化...\n",e.initializationSteps.forEach((function(e){return e.done=!0})),e.isInitialized=!0,t.next=10,e.clearServerCacheAfterChange();case 10:return t.next=12,e.refreshBlockList();case 12:return t.next=14,e.refreshSSHPort();case 14:return t.next=16,e.refreshInboundPorts();case 16:return t.next=18,e.refreshInboundIPs();case 18:e.commandOutput+="手动初始化完成，已跳过脚本检查\n",e.$message.success("手动初始化完成"),t.next=26;break;case 22:t.prev=22,t.t0=t["catch"](3),e.commandOutput+="\n手动初始化失败: ".concat(t.t0.message,"\n"),e.$message.error("初始化失败: ".concat(t.t0.message));case 26:return t.prev=26,e.loading=!1,t.finish(26);case 29:case"end":return t.stop()}}),t,null,[[3,22,26,29]])})))()})),"generateManualCommands",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法生成命令"),t.abrupt("return");case 3:try{e.debugging=!0,e.debugInfo="以下是您可以直接在服务器上执行的命令：\n\n",e.debugInfo+="## 1. 部署Nftato脚本\n",e.debugInfo+="```\n",e.debugInfo+="cd ~ && wget -N --no-check-certificate https://raw.githubusercontent.com/Fiftonb/Gnftato/refs/heads/main/Nftato.sh && chmod +x Nftato.sh\n",e.debugInfo+="```\n\n",e.debugInfo+="## 2. 测试Nftato脚本\n",e.debugInfo+="```\n",e.debugInfo+="./Nftato.sh\n",e.debugInfo+="```\n\n",e.debugInfo+="## 3. 常用操作命令\n",e.debugInfo+="```\n",e.debugInfo+="# 阻止BT/PT流量\n",e.debugInfo+="./Nftato.sh 1\n\n",e.debugInfo+="# 解封BT/PT流量\n",e.debugInfo+="./Nftato.sh 11\n\n",e.debugInfo+="# 查看当前封禁列表\n",e.debugInfo+="./Nftato.sh 101\n",e.debugInfo+="```\n\n",e.debugInfo+="## 使用方法\n",e.debugInfo+="1. 通过SSH工具连接到您的服务器\n",e.debugInfo+="2. 复制并粘贴上述命令到SSH终端执行\n",e.debugInfo+='3. 执行完成后，返回此界面点击"跳过检查直接初始化"按钮\n\n',e.debugInfo+='如果您成功执行了这些命令，请点击页面上的"跳过检查直接初始化"按钮，这样可以绕过自动部署和检查过程，直接使用界面管理规则。\n',e.$message.success("已生成手动执行命令，请查看调试信息")}catch(r){e.debugInfo+="\n生成命令过程出错: ".concat(r.message,"\n"),e.$message.error("生成命令出错: ".concat(r.message))}finally{e.debugging=!1}case 4:case"end":return t.stop()}}),t)})))()})),"deployIptatoScript",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行部署操作"),t.abrupt("return");case 3:return t.prev=3,e.loadingDeployment=!0,e.commandOutput="正在部署脚本...\n",t.next=8,e.deployIptato(e.serverId);case 8:if(r=t.sent,!r||!r.success){t.next=18;break}return e.$message.success("脚本部署成功"),e.commandOutput+="\n脚本部署成功",t.next=14,e.clearServerCacheAfterChange();case 14:return t.next=16,e.refreshAllData();case 16:t.next=20;break;case 18:n=(null===r||void 0===r?void 0:r.error)||"脚本部署失败",n.includes("网络连接")?(e.commandOutput+="\n网络连接问题，请检查服务器网络设置",e.$message.error("网络连接问题，请检查服务器网络")):n.includes("权限")?(e.commandOutput+="\n权限不足，请确认SSH用户拥有root权限",e.$message.error("权限不足，请确认用户权限")):n.includes("500")||n.includes("内部错误")?(e.commandOutput+="\n服务器内部错误，可能原因：",e.commandOutput+="\n1. 服务器磁盘空间不足",e.commandOutput+="\n2. 服务器防火墙限制了文件上传",e.commandOutput+="\n3. 服务器缺少必要的依赖包",e.$message.error("服务器内部错误，请查看详细信息")):(e.$message.error("脚本部署失败: ".concat(n)),e.commandOutput+="\n脚本部署失败: ".concat(n));case 20:t.next=26;break;case 22:t.prev=22,t.t0=t["catch"](3),e.$message.error("脚本部署错误: ".concat(t.t0.message)),e.commandOutput+="\n脚本部署错误: ".concat(t.t0.message);case 26:return t.prev=26,e.loadingDeployment=!1,t.finish(26);case 29:case"end":return t.stop()}}),t,null,[[3,22,26,29]])})))()})),"isSshPort",(function(e){return!(!this.sshPort||this.sshPort!==parseInt(e,10))||(!(!this.server||this.server.port!==parseInt(e,10))||22===parseInt(e,10))})),"startServerStatusCheck",(function(){var e=this;this.statusCheckTimer=setInterval((0,y.A)((0,$.A)().mark((function t(){var r,n,s;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.hasValidServerId){t.next=11;break}return t.prev=1,t.next=4,e.getServer(e.serverId);case 4:r=t.sent,r&&r.success&&(n=r.data.status,s=e.server?e.server.status:null,e.server=r.data,"online"!==s&&"online"===n&&e.$message.success("服务器已恢复在线状态"),"online"===s&&"online"!==n&&e.$message.warning("服务器已离线，无法管理防火墙规则")),t.next=11;break;case 8:t.prev=8,t.t0=t["catch"](1),console.error("检查服务器状态出错:",t.t0);case 11:case"end":return t.stop()}}),t,null,[[1,8]])}))),3e4)})),"stopServerStatusCheck",(function(){this.statusCheckTimer&&(clearInterval(this.statusCheckTimer),this.statusCheckTimer=null)})),"tryConnectServer",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法连接服务器"),t.abrupt("return");case 3:return t.prev=3,e.connecting=!0,e.commandOutput="正在尝试连接服务器...\n",t.next=8,e.connectServer(e.serverId);case 8:r=t.sent,r&&r.success?(e.$message.success("服务器连接成功"),e.commandOutput+="\n服务器连接成功"):(e.$message.error((null===r||void 0===r?void 0:r.error)||"连接服务器失败"),e.commandOutput+="\n连接服务器失败: ".concat((null===r||void 0===r?void 0:r.error)||"未知错误")),t.next=16;break;case 12:t.prev=12,t.t0=t["catch"](3),e.$message.error("连接服务器错误: ".concat(t.t0.message)),e.commandOutput+="\n连接服务器错误: ".concat(t.t0.message);case 16:return t.prev=16,e.connecting=!1,t.finish(16);case 19:case"end":return t.stop()}}),t,null,[[3,12,16,19]])})))()})),"invalidateCache",(function(e){if(e)try{this.cacheTimestamps[e]=0,this.dataCache[e]="inboundPorts"===e||"inboundIPs"===e?[]:null,console.log("缓存".concat(e,"已失效"))}catch(t){console.error("重置缓存".concat(e,"时出错:"),t),this.cacheTimestamps[e]=0,this.dataCache[e]="inboundPorts"===e||"inboundIPs"===e?[]:null}})),"loadServerCache",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c,i;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=2;break}return t.abrupt("return",!1);case 2:return t.prev=2,t.next=5,e.getCacheLastUpdate(e.serverId);case 5:if(r=t.sent,r.success){t.next=9;break}return console.log("服务器缓存不存在或无法访问"),t.abrupt("return",!1);case 9:return e.serverCacheLastUpdate=r.data.lastUpdate,e.serverCacheAvailable=!0,t.next=13,e.getServerCache(e.serverId);case 13:if(n=t.sent,n.success){t.next=16;break}return t.abrupt("return",!1);case 16:if(s=n.data,s.data.blockList&&(e.blockList=s.data.blockList,e.dataCache.blockList=s.data.blockList,e.cacheTimestamps.blockList=Date.now(),e.dataLoaded.blockList=!0),s.data.sshPortStatus){e.sshPortStatus=s.data.sshPortStatus,e.dataCache.sshPortStatus=s.data.sshPortStatus,e.cacheTimestamps.sshPortStatus=Date.now(),e.dataLoaded.sshPortStatus=!0;try{a=s.data.sshPortStatus,a&&"string"===typeof a&&(o=a.match(/SSH端口\s*[:：]\s*(\d+)/i)||a.match(/端口\s*[:：]\s*(\d+)/i)||a.match(/port\s*[:：]\s*(\d+)/i),o&&o[1]&&(e.sshPort=parseInt(o[1],10)))}catch(u){console.error("解析SSH端口数据出错:",u),e.server&&e.server.port&&(e.sshPort=e.server.port,console.log("使用服务器配置的端口: ".concat(e.sshPort)))}}return s.data.inboundPorts&&(c=s.data.inboundPorts,Array.isArray(c)?(i=c.map((function(e){return e.port})),e.dataCache.inboundPorts={tcp:i,udp:i}):c.tcp||c.udp?e.dataCache.inboundPorts=c:e.dataCache.inboundPorts={tcp:[],udp:[]},e.cacheTimestamps.inboundPorts=Date.now(),e.dataLoaded.inboundPorts=!0),s.data.inboundIPs&&(e.inboundIPs=Array.isArray(s.data.inboundIPs)?s.data.inboundIPs.map((function(e){return"string"===typeof e?{ip:e}:e})):[],e.dataCache.inboundIPs=e.inboundIPs,e.cacheTimestamps.inboundIPs=Date.now(),e.dataLoaded.inboundIPs=!0),console.log("已成功加载服务器缓存数据"),e.commandOutput="已加载缓存数据",t.abrupt("return",!0);case 26:return t.prev=26,t.t0=t["catch"](2),console.error("加载服务器缓存失败:",t.t0),t.abrupt("return",!1);case 30:case"end":return t.stop()}}),t,null,[[2,26]])})))()})),(0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)(B,"clearServerCacheAfterChange",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=2;break}return t.abrupt("return");case 2:return t.prev=2,t.next=5,e.clearServerCache(e.serverId);case 5:e.serverCacheAvailable=!1,e.serverCacheLastUpdate=null,Object.keys(e.cacheTimestamps).forEach((function(t){e.cacheTimestamps[t]=0,e.dataCache[t]=null})),console.log("服务器和前端缓存已清除"),t.next=14;break;case 11:t.prev=11,t.t0=t["catch"](2),console.error("清除服务器缓存失败:",t.t0);case 14:case"end":return t.stop()}}),t,null,[[2,11]])})))()})),"updateServerCacheItem",(function(e,t){var r=this;return(0,y.A)((0,$.A)().mark((function n(){var s,a,o,c;return(0,$.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r.hasValidServerId){n.next=2;break}return n.abrupt("return");case 2:return n.prev=2,n.next=5,r.getServerCache(r.serverId);case 5:if(s=n.sent,!s||!s.success){n.next=15;break}return a=s.data,o=(0,i.A)({},a.data),o.data||(o.data={}),o.data[e]=t,n.next=13,r.$store.dispatch("rules/updateCacheItem",{serverId:r.serverId,key:e,value:t});case 13:c=n.sent,c&&c.success?console.log("服务器缓存项 ".concat(e," 已更新")):console.warn("更新服务器缓存项 ".concat(e," 失败"));case 15:n.next=20;break;case 17:n.prev=17,n.t0=n["catch"](2),console.error("更新服务器缓存项 ".concat(e," 出错:"),n.t0);case 20:r.invalidateCache(e);case 21:case"end":return n.stop()}}),n,null,[[2,17]])})))()})),"autoResetConnectionState",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=2;break}return t.abrupt("return",!1);case 2:return t.prev=2,e.commandOutput="正在自动重置连接状态...",e.loading=!0,t.next=7,e.connectServer(e.serverId);case 7:if(r=t.sent,!r||!r.success){t.next=17;break}return console.log("服务器重新连接成功"),t.next=12,e.getServer(e.serverId);case 12:return n=t.sent,n&&n.success&&(e.server=n.data),t.abrupt("return",!0);case 17:return console.warn("服务器重新连接失败，将尝试初始化过程"),t.abrupt("return",!1);case 19:t.next=25;break;case 21:return t.prev=21,t.t0=t["catch"](2),console.error("自动重置连接状态失败:",t.t0),t.abrupt("return",!1);case 25:return t.prev=25,e.loading=!1,t.finish(25);case 28:case"end":return t.stop()}}),t,null,[[2,21,25,28]])})))()})),"blockSPAM",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行阻止操作"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,t.next=7,e.blockSPAMAction(e.serverId);case 7:if(r=t.sent,!r||!r.success){t.next=15;break}return e.$message.success("成功阻止垃圾邮件流量"),e.invalidateCache("blockList"),t.next=13,e.refreshBlockList();case 13:t.next=16;break;case 15:e.$message.error((null===r||void 0===r?void 0:r.error)||"阻止垃圾邮件失败");case 16:t.next=21;break;case 18:t.prev=18,t.t0=t["catch"](3),e.$message.error("阻止垃圾邮件错误: ".concat(t.t0.message));case 21:return t.prev=21,e.loading=!1,t.finish(21);case 24:case"end":return t.stop()}}),t,null,[[3,18,21,24]])})))()})),"blockCustomPorts",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行阻止操作"),t.abrupt("return");case 3:if(e.customPorts){t.next=6;break}return e.$message.warning("请输入要阻止的端口"),t.abrupt("return");case 6:return t.prev=6,e.loading=!0,e.loadingAction=!0,t.next=11,e.blockCustomPortsAction({serverId:e.serverId,ports:e.customPorts});case 11:if(r=t.sent,!r||!r.success){t.next=20;break}return e.$message.success("成功阻止端口: ".concat(e.customPorts)),e.customPorts="",e.invalidateCache("blockList"),t.next=18,e.refreshSelectedData(["blockList"]);case 18:t.next=21;break;case 20:e.$message.error((null===r||void 0===r?void 0:r.error)||"阻止自定义端口失败");case 21:t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](6),e.$message.error("阻止自定义端口错误: ".concat(t.t0.message));case 26:return t.prev=26,e.loading=!1,e.loadingAction=!1,t.finish(26);case 30:case"end":return t.stop()}}),t,null,[[6,23,26,30]])})))()})),"unblockSPAM",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行取消阻止操作"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,t.next=7,e.unblockSPAMAction(e.serverId);case 7:if(r=t.sent,!r||!r.success){t.next=15;break}return e.$message.success("成功取消阻止垃圾邮件流量"),e.invalidateCache("blockList"),t.next=13,e.refreshBlockList();case 13:t.next=16;break;case 15:e.$message.error((null===r||void 0===r?void 0:r.error)||"取消阻止垃圾邮件失败");case 16:t.next=21;break;case 18:t.prev=18,t.t0=t["catch"](3),e.$message.error("取消阻止垃圾邮件错误: ".concat(t.t0.message));case 21:return t.prev=21,e.loading=!1,t.finish(21);case 24:case"end":return t.stop()}}),t,null,[[3,18,21,24]])})))()})),"unblockCustomPorts",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行取消阻止操作"),t.abrupt("return");case 3:if(e.customUnblockPorts){t.next=6;break}return e.$message.warning("请输入要取消阻止的端口"),t.abrupt("return");case 6:return t.prev=6,e.loading=!0,e.loadingAction=!0,t.next=11,e.unblockCustomPortsAction({serverId:e.serverId,ports:e.customUnblockPorts});case 11:if(r=t.sent,!r||!r.success){t.next=20;break}return e.$message.success("成功取消阻止端口: ".concat(e.customUnblockPorts)),e.customUnblockPorts="",e.invalidateCache("blockList"),t.next=18,e.refreshSelectedData(["blockList"]);case 18:t.next=21;break;case 20:e.$message.error((null===r||void 0===r?void 0:r.error)||"取消阻止自定义端口失败");case 21:t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](6),e.$message.error("取消阻止自定义端口错误: ".concat(t.t0.message));case 26:return t.prev=26,e.loading=!1,e.loadingAction=!1,t.finish(26);case 30:case"end":return t.stop()}}),t,null,[[6,23,26,30]])})))()})),"allowPort",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行允许入网操作"),t.abrupt("return");case 3:if(e.portToAllow){t.next=6;break}return e.$message.warning("请输入要允许的端口"),t.abrupt("return");case 6:return t.prev=6,e.loadingPorts=!0,e.loadingAction=!0,t.next=11,e.allowInboundPortsAction({serverId:e.serverId,ports:e.portToAllow});case 11:r=t.sent,r&&r.success?(e.$message.success("成功允许入网端口: ".concat(e.portToAllow)),n=e.portToAllow.split(",").map((function(e){return parseInt(e.trim(),10)})).filter((function(e){return!isNaN(e)})),e.dataCache.inboundPorts&&(e.dataCache.inboundPorts.tcp||(e.dataCache.inboundPorts.tcp=[]),e.dataCache.inboundPorts.udp||(e.dataCache.inboundPorts.udp=[]),e.dataCache.inboundPorts.tcp=(0,W.A)(new Set([].concat((0,W.A)(e.dataCache.inboundPorts.tcp),(0,W.A)(n)))),e.dataCache.inboundPorts.udp=(0,W.A)(new Set([].concat((0,W.A)(e.dataCache.inboundPorts.udp),(0,W.A)(n)))),e.cacheTimestamps.inboundPorts=Date.now()),e.portToAllow=""):e.$message.error((null===r||void 0===r?void 0:r.error)||"允许入网端口失败"),t.next=18;break;case 15:t.prev=15,t.t0=t["catch"](6),e.$message.error("允许入网端口错误: ".concat(t.t0.message));case 18:return t.prev=18,e.loadingPorts=!1,e.loadingAction=!1,t.finish(18);case 22:case"end":return t.stop()}}),t,null,[[6,15,18,22]])})))()})),"executeDisallowPort",(function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,t.loadingPorts=!0,t.loadingAction=!0,r.next=5,t.disallowInboundPortsAction({serverId:t.serverId,ports:e.toString()});case 5:n=r.sent,n&&n.success?(t.$message.success("成功取消放行端口: ".concat(e)),t.dataCache.inboundPorts&&(t.dataCache.inboundPorts.tcp&&(t.dataCache.inboundPorts.tcp=t.dataCache.inboundPorts.tcp.filter((function(t){return t!==e}))),t.dataCache.inboundPorts.udp&&(t.dataCache.inboundPorts.udp=t.dataCache.inboundPorts.udp.filter((function(t){return t!==e}))),t.cacheTimestamps.inboundPorts=Date.now())):(t.$message.error((null===n||void 0===n?void 0:n.error)||"取消放行入网端口失败"),console.error("取消放行端口失败:",null===n||void 0===n?void 0:n.error)),r.next=13;break;case 9:r.prev=9,r.t0=r["catch"](0),t.$message.error("取消放行端口错误: ".concat(r.t0.message)),console.error("取消放行端口错误:",r.t0);case 13:return r.prev=13,t.loadingPorts=!1,t.loadingAction=!1,r.finish(13);case 17:case"end":return r.stop()}}),r,null,[[0,9,13,17]])})))()})),"allowIP",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行允许入网操作"),t.abrupt("return");case 3:if(e.ipToAllow){t.next=6;break}return e.$message.warning("请输入要允许的IP地址"),t.abrupt("return");case 6:return t.prev=6,e.loadingIPs=!0,e.loadingAction=!0,t.next=11,e.allowInboundIPsAction({serverId:e.serverId,ips:e.ipToAllow});case 11:if(r=t.sent,!r||!r.success){t.next=20;break}return e.$message.success("成功允许入网IP: ".concat(e.ipToAllow)),e.ipToAllow="",e.invalidateCache("inboundIPs"),t.next=18,e.refreshInboundIPs();case 18:t.next=21;break;case 20:e.$message.error((null===r||void 0===r?void 0:r.error)||"允许入网IP失败");case 21:t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](6),e.$message.error("允许入网IP错误: ".concat(t.t0.message));case 26:return t.prev=26,e.loadingIPs=!1,e.loadingAction=!1,t.finish(26);case 30:case"end":return t.stop()}}),t,null,[[6,23,26,30]])})))()})),(0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)(B,"disallowIP",(function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(t.hasValidServerId){r.next=3;break}return t.$message.error("未指定服务器ID，无法执行取消放行操作"),r.abrupt("return");case 3:if(n="object"===(0,F.A)(e)?e.ip:e,n){r.next=7;break}return t.$message.error("无效的IP地址"),r.abrupt("return");case 7:return r.prev=7,t.loadingIPs=!0,t.loadingAction=!0,r.next=12,t.disallowInboundIPsAction({serverId:t.serverId,ips:n});case 12:if(s=r.sent,!s||!s.success){r.next=20;break}return t.$message.success("成功取消放行IP: ".concat(n)),t.invalidateCache("inboundIPs"),r.next=18,t.refreshInboundIPs();case 18:r.next=21;break;case 20:t.$message.error((null===s||void 0===s?void 0:s.error)||"取消放行IP失败");case 21:r.next=26;break;case 23:r.prev=23,r.t0=r["catch"](7),t.$message.error("取消放行IP错误: ".concat(r.t0.message));case 26:return r.prev=26,t.loadingIPs=!1,t.loadingAction=!1,r.finish(26);case 30:case"end":return r.stop()}}),r,null,[[7,23,26,30]])})))()})),"confirmClearRules",(function(){var e=this;this.hasValidServerId?this.$confirm("此操作将清空所有防火墙规则，是否继续?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){e.clearAllRules()}))["catch"]((function(){e.$message({type:"info",message:"已取消清空操作"})})):this.$message.error("未指定服务器ID，无法执行清除规则操作")})),"clearAllRules",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行清除规则操作"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,e.loadingAction=!0,t.next=8,e.clearAllRulesAction(e.serverId);case 8:if(r=t.sent,!r||!r.success){t.next=17;break}return e.$message.success("成功清除所有规则"),t.next=13,e.clearServerCacheAfterChange();case 13:return t.next=15,e.refreshAllData();case 15:t.next=18;break;case 17:e.$message.error((null===r||void 0===r?void 0:r.error)||"清除所有规则失败");case 18:t.next=23;break;case 20:t.prev=20,t.t0=t["catch"](3),e.$message.error("清除所有规则错误: ".concat(t.t0.message));case 23:return t.prev=23,e.loading=!1,e.loadingAction=!1,t.finish(23);case 27:case"end":return t.stop()}}),t,null,[[3,20,23,27]])})))()})),"executeTestCommand",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=4;break}return e.commandOutput="错误：未指定服务器ID，无法执行命令",e.$message.error("未指定服务器ID"),t.abrupt("return");case 4:case"end":return t.stop()}}),t)})))()})),"blockSPAM",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行阻止操作"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,t.next=7,e.blockSPAMAction(e.serverId);case 7:if(r=t.sent,!r||!r.success){t.next=15;break}return e.$message.success("成功阻止垃圾邮件流量"),e.invalidateCache("blockList"),t.next=13,e.refreshBlockList();case 13:t.next=16;break;case 15:e.$message.error((null===r||void 0===r?void 0:r.error)||"阻止垃圾邮件失败");case 16:t.next=21;break;case 18:t.prev=18,t.t0=t["catch"](3),e.$message.error("阻止垃圾邮件错误: ".concat(t.t0.message));case 21:return t.prev=21,e.loading=!1,t.finish(21);case 24:case"end":return t.stop()}}),t,null,[[3,18,21,24]])})))()})),"blockCustomPorts",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行阻止操作"),t.abrupt("return");case 3:if(e.customPorts){t.next=6;break}return e.$message.warning("请输入要阻止的端口"),t.abrupt("return");case 6:return t.prev=6,e.loading=!0,e.loadingAction=!0,t.next=11,e.blockCustomPortsAction({serverId:e.serverId,ports:e.customPorts});case 11:if(r=t.sent,!r||!r.success){t.next=20;break}return e.$message.success("成功阻止端口: ".concat(e.customPorts)),e.customPorts="",e.invalidateCache("blockList"),t.next=18,e.refreshSelectedData(["blockList"]);case 18:t.next=21;break;case 20:e.$message.error((null===r||void 0===r?void 0:r.error)||"阻止自定义端口失败");case 21:t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](6),e.$message.error("阻止自定义端口错误: ".concat(t.t0.message));case 26:return t.prev=26,e.loading=!1,e.loadingAction=!1,t.finish(26);case 30:case"end":return t.stop()}}),t,null,[[6,23,26,30]])})))()})),"unblockSPAM",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行取消阻止操作"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,t.next=7,e.unblockSPAMAction(e.serverId);case 7:if(r=t.sent,!r||!r.success){t.next=15;break}return e.$message.success("成功取消阻止垃圾邮件流量"),e.invalidateCache("blockList"),t.next=13,e.refreshBlockList();case 13:t.next=16;break;case 15:e.$message.error((null===r||void 0===r?void 0:r.error)||"取消阻止垃圾邮件失败");case 16:t.next=21;break;case 18:t.prev=18,t.t0=t["catch"](3),e.$message.error("取消阻止垃圾邮件错误: ".concat(t.t0.message));case 21:return t.prev=21,e.loading=!1,t.finish(21);case 24:case"end":return t.stop()}}),t,null,[[3,18,21,24]])})))()})),"unblockCustomPorts",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行取消阻止操作"),t.abrupt("return");case 3:if(e.customUnblockPorts){t.next=6;break}return e.$message.warning("请输入要取消阻止的端口"),t.abrupt("return");case 6:return t.prev=6,e.loading=!0,e.loadingAction=!0,t.next=11,e.unblockCustomPortsAction({serverId:e.serverId,ports:e.customUnblockPorts});case 11:if(r=t.sent,!r||!r.success){t.next=20;break}return e.$message.success("成功取消阻止端口: ".concat(e.customUnblockPorts)),e.customUnblockPorts="",e.invalidateCache("blockList"),t.next=18,e.refreshSelectedData(["blockList"]);case 18:t.next=21;break;case 20:e.$message.error((null===r||void 0===r?void 0:r.error)||"取消阻止自定义端口失败");case 21:t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](6),e.$message.error("取消阻止自定义端口错误: ".concat(t.t0.message));case 26:return t.prev=26,e.loading=!1,e.loadingAction=!1,t.finish(26);case 30:case"end":return t.stop()}}),t,null,[[6,23,26,30]])})))()})),"allowPort",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行允许入网操作"),t.abrupt("return");case 3:if(e.portToAllow){t.next=6;break}return e.$message.warning("请输入要允许的端口"),t.abrupt("return");case 6:return t.prev=6,e.loadingPorts=!0,e.loadingAction=!0,t.next=11,e.allowInboundPortsAction({serverId:e.serverId,ports:e.portToAllow});case 11:if(r=t.sent,!r||!r.success){t.next=20;break}return e.$message.success("成功允许入网端口: ".concat(e.portToAllow)),e.portToAllow="",e.invalidateCache("inboundPorts"),t.next=18,e.refreshInboundPorts();case 18:t.next=21;break;case 20:e.$message.error((null===r||void 0===r?void 0:r.error)||"允许入网端口失败");case 21:t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](6),e.$message.error("允许入网端口错误: ".concat(t.t0.message));case 26:return t.prev=26,e.loadingPorts=!1,e.loadingAction=!1,t.finish(26);case 30:case"end":return t.stop()}}),t,null,[[6,23,26,30]])})))()})),"disallowPort",(function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(t.hasValidServerId){r.next=3;break}return t.$message.error("未指定服务器ID，无法执行取消放行操作"),r.abrupt("return");case 3:if(!t.isSshPort(e)){r.next=6;break}return t.$message.error("不能取消SSH端口的放行，这可能导致无法连接服务器"),r.abrupt("return");case 6:t.isCriticalPort(e)&&!t.isSshPort(e)?t.$confirm("端口".concat(e,"是常用服务端口，取消放行可能影响服务器某些功能。确定要继续吗?"),"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){t.executeDisallowPort(e)}))["catch"]((function(){t.$message.info("已取消操作")})):t.executeDisallowPort(e);case 7:case"end":return r.stop()}}),r)})))()})),(0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)(B,"allowIP",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行允许入网操作"),t.abrupt("return");case 3:if(e.ipToAllow){t.next=6;break}return e.$message.warning("请输入要允许的IP地址"),t.abrupt("return");case 6:return t.prev=6,e.loadingIPs=!0,e.loadingAction=!0,t.next=11,e.allowInboundIPsAction({serverId:e.serverId,ips:e.ipToAllow});case 11:if(r=t.sent,!r||!r.success){t.next=20;break}return e.$message.success("成功允许入网IP: ".concat(e.ipToAllow)),e.ipToAllow="",e.invalidateCache("inboundIPs"),t.next=18,e.refreshInboundIPs();case 18:t.next=21;break;case 20:e.$message.error((null===r||void 0===r?void 0:r.error)||"允许入网IP失败");case 21:t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](6),e.$message.error("允许入网IP错误: ".concat(t.t0.message));case 26:return t.prev=26,e.loadingIPs=!1,e.loadingAction=!1,t.finish(26);case 30:case"end":return t.stop()}}),t,null,[[6,23,26,30]])})))()})),"confirmClearRules",(function(){var e=this;this.hasValidServerId?this.$confirm("此操作将清空所有防火墙规则，是否继续?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){e.clearAllRules()}))["catch"]((function(){e.$message({type:"info",message:"已取消清空操作"})})):this.$message.error("未指定服务器ID，无法执行清除规则操作")})),"clearAllRules",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行清除规则操作"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,e.loadingAction=!0,t.next=8,e.clearAllRulesAction(e.serverId);case 8:if(r=t.sent,!r||!r.success){t.next=17;break}return e.$message.success("成功清除所有规则"),t.next=13,e.clearServerCacheAfterChange();case 13:return t.next=15,e.refreshAllData();case 15:t.next=18;break;case 17:e.$message.error((null===r||void 0===r?void 0:r.error)||"清除所有规则失败");case 18:t.next=23;break;case 20:t.prev=20,t.t0=t["catch"](3),e.$message.error("清除所有规则错误: ".concat(t.t0.message));case 23:return t.prev=23,e.loading=!1,e.loadingAction=!1,t.finish(23);case 27:case"end":return t.stop()}}),t,null,[[3,20,23,27]])})))()})),"deployIptatoManually",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行部署操作"),t.abrupt("return");case 3:return t.prev=3,e.deploying=!0,e.commandOutput="正在尝试手动部署脚本...\n",t.next=8,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:"wget -N --no-check-certificate https://raw.githubusercontent.com/Fiftonb/Gnftato/refs/heads/main/Nftato.sh && chmod +x Nftato.sh && bash Nftato.sh"});case 8:if(r=t.sent,!r||!r.success){t.next=37;break}return e.commandOutput+="手动部署命令执行成功，正在验证安装结果...\n",t.next=13,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:'test -f /root/Nftato.sh && echo "installed" || echo "not found"'});case 13:if(n=t.sent,!(n&&n.success&&n.data&&n.data.stdout&&n.data.stdout.includes("installed"))){t.next=33;break}return e.commandOutput+="脚本已成功安装!\n",e.$message.success("脚本手动部署成功"),e.initializationSteps[2].done=!0,e.initStepActive=3,t.next=21,e.clearServerCacheAfterChange();case 21:return t.next=23,e.refreshBlockList();case 23:return t.next=25,e.refreshSSHPort();case 25:return t.next=27,e.refreshInboundPorts();case 27:return t.next=29,e.refreshInboundIPs();case 29:e.initializationSteps[3].done=!0,e.isInitialized=!0,t.next=35;break;case 33:e.commandOutput+="脚本安装验证失败，请检查服务器环境或联系管理员\n",e.$message.error("脚本安装验证失败");case 35:t.next=39;break;case 37:e.commandOutput+="手动部署失败: ".concat((null===r||void 0===r?void 0:r.error)||"未知错误","\n"),e.$message.error("手动部署失败");case 39:t.next=45;break;case 41:t.prev=41,t.t0=t["catch"](3),e.commandOutput+="手动部署出错: ".concat(t.t0.message,"\n"),e.$message.error("手动部署出错: ".concat(t.t0.message));case 45:return t.prev=45,e.deploying=!1,t.finish(45);case 48:case"end":return t.stop()}}),t,null,[[3,41,45,48]])})))()})),"completeInitialization",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法完成初始化"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,e.commandOutput="正在加载规则信息...\n",t.next=8,e.clearServerCacheAfterChange();case 8:return t.next=10,e.refreshBlockList();case 10:return t.next=12,e.refreshSSHPort();case 12:return t.next=14,e.refreshInboundPorts();case 14:return t.next=16,e.refreshInboundIPs();case 16:e.initializationSteps[3].done=!0,e.isInitialized=!0,e.$message.success("初始化完成"),e.commandOutput+="初始化完成，可以开始管理防火墙规则",t.next=26;break;case 22:t.prev=22,t.t0=t["catch"](3),e.commandOutput+="\n初始化过程中加载规则出错: ".concat(t.t0.message),e.$message.error("加载规则失败: ".concat(t.t0.message));case 26:return t.prev=26,e.loading=!1,t.finish(26);case 29:case"end":return t.stop()}}),t,null,[[3,22,26,29]])})))()})),"clearCommandOutput",(function(){this.commandOutput=""})),"checkScriptExistence",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c,i,u,l,d,p,v;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法检查脚本"),t.abrupt("return");case 3:t.prev=3,e.debugging=!0,e.debugInfo="正在检查脚本存在状态...\n",r=["ls -la /root/Nftato.sh","ls -la /root/Nftato.sh",'find /root -name "*.sh" | grep -i Nftato','find / -name "*.sh" -type f -not -path "*/\\.*" | grep -i Nftato 2>/dev/null'],n=0,s=r;case 8:if(!(n<s.length)){t.next=30;break}return a=s[n],e.debugInfo+="\n执行命令: ".concat(a,"\n"),t.next=13,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:a});case 13:if(o=t.sent,!o||!o.success){t.next=26;break}if(u=(null===(c=o.data)||void 0===c?void 0:c.stdout)||"",l=(null===(i=o.data)||void 0===i?void 0:i.stderr)||"",e.debugInfo+="输出:\n".concat(u,"\n"),l&&(e.debugInfo+="错误:\n".concat(l,"\n")),!u||!u.includes("Nftato.sh")&&!u.includes("Nftato.sh")){t.next=24;break}return e.debugInfo+="\n检测到脚本存在！但前端应用未能识别。\n",e.debugInfo+="这可能是脚本命名不一致或路径不同导致的问题。\n",e.$message.warning("脚本已存在但应用无法识别，请参考调试信息"),t.abrupt("break",30);case 24:t.next=27;break;case 26:e.debugInfo+="命令执行失败: ".concat((null===o||void 0===o?void 0:o.error)||"未知错误","\n");case 27:n++,t.next=8;break;case 30:return e.debugInfo+="\n尝试直接执行脚本...\n",t.next=33,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:'cd /root && (./Nftato.sh --help || ./Nftato.sh --help || echo "无法执行脚本")'});case 33:d=t.sent,d&&d.success?(v=(null===(p=d.data)||void 0===p?void 0:p.stdout)||"",e.debugInfo+="执行脚本输出:\n".concat(v,"\n"),(v.includes("管理脚本")||v.includes("nftables"))&&(e.debugInfo+="\n脚本可以成功执行！\n",e.debugInfo+="建议使用手动初始化功能完成后续步骤。\n",e.$message.success("脚本可以成功执行，但需要手动初始化"))):e.debugInfo+="脚本执行失败: ".concat((null===d||void 0===d?void 0:d.error)||"未知错误","\n"),t.next=41;break;case 37:t.prev=37,t.t0=t["catch"](3),e.debugInfo+="\n检查过程出错: ".concat(t.t0.message,"\n"),e.$message.error("检查出错: ".concat(t.t0.message));case 41:return t.prev=41,e.debugging=!1,t.finish(41);case 44:case"end":return t.stop()}}),t,null,[[3,37,41,44]])})))()})),"testServerConnection",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c,i;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法测试连接"),t.abrupt("return");case 3:return t.prev=3,e.debugging=!0,e.debugInfo="正在测试服务器连接...\n",e.debugInfo+="1. 检查服务器信息:\n",t.next=9,e.getServer(e.serverId);case 9:return r=t.sent,r&&r.success?(e.debugInfo+="服务器信息: ".concat(JSON.stringify(r.data,null,2),"\n"),e.debugInfo+="连接状态: ".concat(r.data.status,"\n")):e.debugInfo+="获取服务器信息失败: ".concat((null===r||void 0===r?void 0:r.error)||"未知错误","\n"),e.debugInfo+="\n尝试重新连接服务器...\n",t.prev=12,t.next=15,e.connectServer(e.serverId);case 15:n=t.sent,n&&n.success?e.debugInfo+="服务器重新连接成功\n":e.debugInfo+="服务器重新连接失败: ".concat((null===n||void 0===n?void 0:n.error)||"未知错误","\n"),t.next=22;break;case 19:t.prev=19,t.t0=t["catch"](12),e.debugInfo+="重新连接出错: ".concat(t.t0.message,"\n");case 22:return e.debugInfo+="\n2. 执行简单命令测试:\n",t.next=25,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:"uname -a && whoami && pwd"});case 25:return s=t.sent,s&&s.success?(e.debugInfo+="命令输出:\n".concat((null===(a=s.data)||void 0===a?void 0:a.stdout)||"","\n"),e.debugInfo+="命令成功执行，服务器连接正常\n"):(e.debugInfo+="命令执行失败: ".concat((null===s||void 0===s?void 0:s.error)||"未知错误","\n"),e.debugInfo+="服务器连接可能存在问题\n"),e.debugInfo+="\n3. 检查前后端连接配置:\n",o={NODE_ENV:"production",BASE_URL:"/"}.VUE_APP_API_URL||window.location.origin,e.debugInfo+="API基础URL: ".concat(o,"\n"),e.debugInfo+="当前连接模式: ".concat("production","\n"),e.debugInfo+="\n4. 检查网络连接:\n",t.prev=32,t.next=35,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:"ping -c 3 8.8.8.8"});case 35:c=t.sent,c&&c.success?e.debugInfo+="ping测试结果:\n".concat((null===(i=c.data)||void 0===i?void 0:i.stdout)||"","\n"):e.debugInfo+="ping测试失败: ".concat((null===c||void 0===c?void 0:c.error)||"未知错误","\n"),t.next=42;break;case 39:t.prev=39,t.t1=t["catch"](32),e.debugInfo+="ping测试错误: ".concat(t.t1.message,"\n");case 42:e.$message.info("连接测试完成，请查看调试信息"),t.next=49;break;case 45:t.prev=45,t.t2=t["catch"](3),e.debugInfo+="\n测试过程出错: ".concat(t.t2.message,"\n"),e.$message.error("测试出错: ".concat(t.t2.message));case 49:return t.prev=49,e.debugging=!1,t.finish(49);case 52:case"end":return t.stop()}}),t,null,[[3,45,49,52],[12,19],[32,39]])})))()})),"resetConnectionState",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法重置状态"),t.abrupt("return");case 3:return t.prev=3,e.debugging=!0,e.debugInfo="正在重置连接状态...\n",t.prev=6,e.debugInfo+="尝试断开当前连接...\n",t.next=10,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:'echo "测试连接状态重置"'});case 10:r=t.sent,e.debugInfo+="断开连接测试命令执行结果: "+(null!==r&&void 0!==r&&r.success?"成功":"失败")+"\n",t.next=17;break;case 14:t.prev=14,t.t0=t["catch"](6),e.debugInfo+="断开连接测试出错: ".concat(t.t0.message,"\n");case 17:return e.debugInfo+="尝试重新连接服务器...\n",t.prev=18,t.next=21,e.connectServer(e.serverId);case 21:n=t.sent,n&&n.success?e.debugInfo+="服务器重新连接成功\n":e.debugInfo+="服务器重新连接失败: ".concat((null===n||void 0===n?void 0:n.error)||"未知错误","\n"),t.next=28;break;case 25:t.prev=25,t.t1=t["catch"](18),e.debugInfo+="重新连接出错: ".concat(t.t1.message,"\n");case 28:return e.resetInitSteps(),e.isInitialized=!1,e.initStepActive=0,t.next=33,e.checkInitialization();case 33:e.debugInfo+="初始化状态已重置，并重新检查\n",e.$message.success("连接状态已重置"),t.next=41;break;case 37:t.prev=37,t.t2=t["catch"](3),e.debugInfo+="\n重置过程出错: ".concat(t.t2.message,"\n"),e.$message.error("重置出错: ".concat(t.t2.message));case 41:return t.prev=41,e.debugging=!1,t.finish(41);case 44:case"end":return t.stop()}}),t,null,[[3,37,41,44],[6,14],[18,25]])})))()})),"manualInitialize",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法初始化"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,e.commandOutput="正在手动初始化...\n",e.initializationSteps.forEach((function(e){return e.done=!0})),e.isInitialized=!0,t.next=10,e.clearServerCacheAfterChange();case 10:return t.next=12,e.refreshBlockList();case 12:return t.next=14,e.refreshSSHPort();case 14:return t.next=16,e.refreshInboundPorts();case 16:return t.next=18,e.refreshInboundIPs();case 18:e.commandOutput+="手动初始化完成，已跳过脚本检查\n",e.$message.success("手动初始化完成"),t.next=26;break;case 22:t.prev=22,t.t0=t["catch"](3),e.commandOutput+="\n手动初始化失败: ".concat(t.t0.message,"\n"),e.$message.error("初始化失败: ".concat(t.t0.message));case 26:return t.prev=26,e.loading=!1,t.finish(26);case 29:case"end":return t.stop()}}),t,null,[[3,22,26,29]])})))()})),(0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)(B,"generateManualCommands",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法生成命令"),t.abrupt("return");case 3:try{e.debugging=!0,e.debugInfo="以下是您可以直接在服务器上执行的命令：\n\n",e.debugInfo+="## 1. 部署Nftato脚本\n",e.debugInfo+="```\n",e.debugInfo+="cd ~ && wget -N --no-check-certificate https://raw.githubusercontent.com/Fiftonb/Gnftato/refs/heads/main/Nftato.sh && chmod +x Nftato.sh\n",e.debugInfo+="```\n\n",e.debugInfo+="## 2. 测试Nftato脚本\n",e.debugInfo+="```\n",e.debugInfo+="./Nftato.sh\n",e.debugInfo+="```\n\n",e.debugInfo+="## 3. 常用操作命令\n",e.debugInfo+="```\n",e.debugInfo+="# 阻止BT/PT流量\n",e.debugInfo+="./Nftato.sh 1\n\n",e.debugInfo+="# 解封BT/PT流量\n",e.debugInfo+="./Nftato.sh 11\n\n",e.debugInfo+="# 查看当前封禁列表\n",e.debugInfo+="./Nftato.sh 101\n",e.debugInfo+="```\n\n",e.debugInfo+="## 使用方法\n",e.debugInfo+="1. 通过SSH工具连接到您的服务器\n",e.debugInfo+="2. 复制并粘贴上述命令到SSH终端执行\n",e.debugInfo+='3. 执行完成后，返回此界面点击"跳过检查直接初始化"按钮\n\n',e.debugInfo+='如果您成功执行了这些命令，请点击页面上的"跳过检查直接初始化"按钮，这样可以绕过自动部署和检查过程，直接使用界面管理规则。\n',e.$message.success("已生成手动执行命令，请查看调试信息")}catch(r){e.debugInfo+="\n生成命令过程出错: ".concat(r.message,"\n"),e.$message.error("生成命令出错: ".concat(r.message))}finally{e.debugging=!1}case 4:case"end":return t.stop()}}),t)})))()})),"deployIptatoScript",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行部署操作"),t.abrupt("return");case 3:return t.prev=3,e.loadingDeployment=!0,e.commandOutput="正在部署脚本...\n",t.next=8,e.deployIptato(e.serverId);case 8:if(r=t.sent,!r||!r.success){t.next=18;break}return e.$message.success("脚本部署成功"),e.commandOutput+="\n脚本部署成功",t.next=14,e.clearServerCacheAfterChange();case 14:return t.next=16,e.refreshAllData();case 16:t.next=20;break;case 18:n=(null===r||void 0===r?void 0:r.error)||"脚本部署失败",n.includes("网络连接")?(e.commandOutput+="\n网络连接问题，请检查服务器网络设置",e.$message.error("网络连接问题，请检查服务器网络")):n.includes("权限")?(e.commandOutput+="\n权限不足，请确认SSH用户拥有root权限",e.$message.error("权限不足，请确认用户权限")):n.includes("500")||n.includes("内部错误")?(e.commandOutput+="\n服务器内部错误，可能原因：",e.commandOutput+="\n1. 服务器磁盘空间不足",e.commandOutput+="\n2. 服务器防火墙限制了文件上传",e.commandOutput+="\n3. 服务器缺少必要的依赖包",e.$message.error("服务器内部错误，请查看详细信息")):(e.$message.error("脚本部署失败: ".concat(n)),e.commandOutput+="\n脚本部署失败: ".concat(n));case 20:t.next=26;break;case 22:t.prev=22,t.t0=t["catch"](3),e.$message.error("脚本部署错误: ".concat(t.t0.message)),e.commandOutput+="\n脚本部署错误: ".concat(t.t0.message);case 26:return t.prev=26,e.loadingDeployment=!1,t.finish(26);case 29:case"end":return t.stop()}}),t,null,[[3,22,26,29]])})))()})),"isSshPort",(function(e){return!(!this.sshPort||this.sshPort!==parseInt(e,10))||(!(!this.server||this.server.port!==parseInt(e,10))||22===parseInt(e,10))})),"startServerStatusCheck",(function(){var e=this;this.statusCheckTimer=setInterval((0,y.A)((0,$.A)().mark((function t(){var r,n,s;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.hasValidServerId){t.next=11;break}return t.prev=1,t.next=4,e.getServer(e.serverId);case 4:r=t.sent,r&&r.success&&(n=r.data.status,s=e.server?e.server.status:null,e.server=r.data,"online"!==s&&"online"===n&&e.$message.success("服务器已恢复在线状态"),"online"===s&&"online"!==n&&e.$message.warning("服务器已离线，无法管理防火墙规则")),t.next=11;break;case 8:t.prev=8,t.t0=t["catch"](1),console.error("检查服务器状态出错:",t.t0);case 11:case"end":return t.stop()}}),t,null,[[1,8]])}))),3e4)})),"stopServerStatusCheck",(function(){this.statusCheckTimer&&(clearInterval(this.statusCheckTimer),this.statusCheckTimer=null)})),"tryConnectServer",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法连接服务器"),t.abrupt("return");case 3:return t.prev=3,e.connecting=!0,e.commandOutput="正在尝试连接服务器...\n",t.next=8,e.connectServer(e.serverId);case 8:r=t.sent,r&&r.success?(e.$message.success("服务器连接成功"),e.commandOutput+="\n服务器连接成功"):(e.$message.error((null===r||void 0===r?void 0:r.error)||"连接服务器失败"),e.commandOutput+="\n连接服务器失败: ".concat((null===r||void 0===r?void 0:r.error)||"未知错误")),t.next=16;break;case 12:t.prev=12,t.t0=t["catch"](3),e.$message.error("连接服务器错误: ".concat(t.t0.message)),e.commandOutput+="\n连接服务器错误: ".concat(t.t0.message);case 16:return t.prev=16,e.connecting=!1,t.finish(16);case 19:case"end":return t.stop()}}),t,null,[[3,12,16,19]])})))()})),"invalidateCache",(function(e){if(e)try{this.cacheTimestamps[e]=0,this.dataCache[e]="inboundPorts"===e||"inboundIPs"===e?[]:null,console.log("缓存".concat(e,"已失效"))}catch(t){console.error("重置缓存".concat(e,"时出错:"),t),this.cacheTimestamps[e]=0,this.dataCache[e]="inboundPorts"===e||"inboundIPs"===e?[]:null}})),"loadServerCache",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c,i;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=2;break}return t.abrupt("return",!1);case 2:return t.prev=2,t.next=5,e.getCacheLastUpdate(e.serverId);case 5:if(r=t.sent,r.success){t.next=9;break}return console.log("服务器缓存不存在或无法访问"),t.abrupt("return",!1);case 9:return e.serverCacheLastUpdate=r.data.lastUpdate,e.serverCacheAvailable=!0,t.next=13,e.getServerCache(e.serverId);case 13:if(n=t.sent,n.success){t.next=16;break}return t.abrupt("return",!1);case 16:if(s=n.data,s.data.blockList&&(e.blockList=s.data.blockList,e.dataCache.blockList=s.data.blockList,e.cacheTimestamps.blockList=Date.now(),e.dataLoaded.blockList=!0),s.data.sshPortStatus){e.sshPortStatus=s.data.sshPortStatus,e.dataCache.sshPortStatus=s.data.sshPortStatus,e.cacheTimestamps.sshPortStatus=Date.now(),e.dataLoaded.sshPortStatus=!0;try{a=s.data.sshPortStatus,a&&"string"===typeof a&&(o=a.match(/SSH端口\s*[:：]\s*(\d+)/i)||a.match(/端口\s*[:：]\s*(\d+)/i)||a.match(/port\s*[:：]\s*(\d+)/i),o&&o[1]&&(e.sshPort=parseInt(o[1],10)))}catch(u){console.error("解析SSH端口数据出错:",u),e.server&&e.server.port&&(e.sshPort=e.server.port,console.log("使用服务器配置的端口: ".concat(e.sshPort)))}}return s.data.inboundPorts&&(c=s.data.inboundPorts,Array.isArray(c)?(i=c.map((function(e){return e.port})),e.dataCache.inboundPorts={tcp:i,udp:i}):c.tcp||c.udp?e.dataCache.inboundPorts=c:e.dataCache.inboundPorts={tcp:[],udp:[]},e.cacheTimestamps.inboundPorts=Date.now(),e.dataLoaded.inboundPorts=!0),s.data.inboundIPs&&(e.inboundIPs=Array.isArray(s.data.inboundIPs)?s.data.inboundIPs.map((function(e){return"string"===typeof e?{ip:e}:e})):[],e.dataCache.inboundIPs=e.inboundIPs,e.cacheTimestamps.inboundIPs=Date.now(),e.dataLoaded.inboundIPs=!0),console.log("已成功加载服务器缓存数据"),e.commandOutput="已加载缓存数据",t.abrupt("return",!0);case 26:return t.prev=26,t.t0=t["catch"](2),console.error("加载服务器缓存失败:",t.t0),t.abrupt("return",!1);case 30:case"end":return t.stop()}}),t,null,[[2,26]])})))()})),"clearServerCacheAfterChange",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=2;break}return t.abrupt("return");case 2:return t.prev=2,t.next=5,e.clearServerCache(e.serverId);case 5:e.serverCacheAvailable=!1,e.serverCacheLastUpdate=null,Object.keys(e.cacheTimestamps).forEach((function(t){e.cacheTimestamps[t]=0,e.dataCache[t]=null})),console.log("服务器和前端缓存已清除"),t.next=14;break;case 11:t.prev=11,t.t0=t["catch"](2),console.error("清除服务器缓存失败:",t.t0);case 14:case"end":return t.stop()}}),t,null,[[2,11]])})))()})),"updateServerCacheItem",(function(e,t){var r=this;return(0,y.A)((0,$.A)().mark((function n(){var s,a,o,c;return(0,$.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r.hasValidServerId){n.next=2;break}return n.abrupt("return");case 2:return n.prev=2,n.next=5,r.getServerCache(r.serverId);case 5:if(s=n.sent,!s||!s.success){n.next=15;break}return a=s.data,o=(0,i.A)({},a.data),o.data||(o.data={}),o.data[e]=t,n.next=13,r.$store.dispatch("rules/updateCacheItem",{serverId:r.serverId,key:e,value:t});case 13:c=n.sent,c&&c.success?console.log("服务器缓存项 ".concat(e," 已更新")):console.warn("更新服务器缓存项 ".concat(e," 失败"));case 15:n.next=20;break;case 17:n.prev=17,n.t0=n["catch"](2),console.error("更新服务器缓存项 ".concat(e," 出错:"),n.t0);case 20:r.invalidateCache(e);case 21:case"end":return n.stop()}}),n,null,[[2,17]])})))()})),(0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)(B,"autoResetConnectionState",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=2;break}return t.abrupt("return",!1);case 2:return t.prev=2,e.commandOutput="正在自动重置连接状态...",e.loading=!0,t.next=7,e.connectServer(e.serverId);case 7:if(r=t.sent,!r||!r.success){t.next=17;break}return console.log("服务器重新连接成功"),t.next=12,e.getServer(e.serverId);case 12:return n=t.sent,n&&n.success&&(e.server=n.data),t.abrupt("return",!0);case 17:return console.warn("服务器重新连接失败，将尝试初始化过程"),t.abrupt("return",!1);case 19:t.next=25;break;case 21:return t.prev=21,t.t0=t["catch"](2),console.error("自动重置连接状态失败:",t.t0),t.abrupt("return",!1);case 25:return t.prev=25,e.loading=!1,t.finish(25);case 28:case"end":return t.stop()}}),t,null,[[2,21,25,28]])})))()})),"blockSPAM",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行阻止操作"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,t.next=7,e.blockSPAMAction(e.serverId);case 7:if(r=t.sent,!r||!r.success){t.next=15;break}return e.$message.success("成功阻止垃圾邮件流量"),e.invalidateCache("blockList"),t.next=13,e.refreshBlockList();case 13:t.next=16;break;case 15:e.$message.error((null===r||void 0===r?void 0:r.error)||"阻止垃圾邮件失败");case 16:t.next=21;break;case 18:t.prev=18,t.t0=t["catch"](3),e.$message.error("阻止垃圾邮件错误: ".concat(t.t0.message));case 21:return t.prev=21,e.loading=!1,t.finish(21);case 24:case"end":return t.stop()}}),t,null,[[3,18,21,24]])})))()})),"blockCustomPorts",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行阻止操作"),t.abrupt("return");case 3:if(e.customPorts){t.next=6;break}return e.$message.warning("请输入要阻止的端口"),t.abrupt("return");case 6:return t.prev=6,e.loading=!0,e.loadingAction=!0,t.next=11,e.blockCustomPortsAction({serverId:e.serverId,ports:e.customPorts});case 11:if(r=t.sent,!r||!r.success){t.next=20;break}return e.$message.success("成功阻止端口: ".concat(e.customPorts)),e.customPorts="",e.invalidateCache("blockList"),t.next=18,e.refreshSelectedData(["blockList"]);case 18:t.next=21;break;case 20:e.$message.error((null===r||void 0===r?void 0:r.error)||"阻止自定义端口失败");case 21:t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](6),e.$message.error("阻止自定义端口错误: ".concat(t.t0.message));case 26:return t.prev=26,e.loading=!1,e.loadingAction=!1,t.finish(26);case 30:case"end":return t.stop()}}),t,null,[[6,23,26,30]])})))()})),"unblockSPAM",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行取消阻止操作"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,t.next=7,e.unblockSPAMAction(e.serverId);case 7:if(r=t.sent,!r||!r.success){t.next=15;break}return e.$message.success("成功取消阻止垃圾邮件流量"),e.invalidateCache("blockList"),t.next=13,e.refreshBlockList();case 13:t.next=16;break;case 15:e.$message.error((null===r||void 0===r?void 0:r.error)||"取消阻止垃圾邮件失败");case 16:t.next=21;break;case 18:t.prev=18,t.t0=t["catch"](3),e.$message.error("取消阻止垃圾邮件错误: ".concat(t.t0.message));case 21:return t.prev=21,e.loading=!1,t.finish(21);case 24:case"end":return t.stop()}}),t,null,[[3,18,21,24]])})))()})),"unblockCustomPorts",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行取消阻止操作"),t.abrupt("return");case 3:if(e.customUnblockPorts){t.next=6;break}return e.$message.warning("请输入要取消阻止的端口"),t.abrupt("return");case 6:return t.prev=6,e.loading=!0,e.loadingAction=!0,t.next=11,e.unblockCustomPortsAction({serverId:e.serverId,ports:e.customUnblockPorts});case 11:if(r=t.sent,!r||!r.success){t.next=20;break}return e.$message.success("成功取消阻止端口: ".concat(e.customUnblockPorts)),e.customUnblockPorts="",e.invalidateCache("blockList"),t.next=18,e.refreshSelectedData(["blockList"]);case 18:t.next=21;break;case 20:e.$message.error((null===r||void 0===r?void 0:r.error)||"取消阻止自定义端口失败");case 21:t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](6),e.$message.error("取消阻止自定义端口错误: ".concat(t.t0.message));case 26:return t.prev=26,e.loading=!1,e.loadingAction=!1,t.finish(26);case 30:case"end":return t.stop()}}),t,null,[[6,23,26,30]])})))()})),"allowPort",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行允许入网操作"),t.abrupt("return");case 3:if(e.portToAllow){t.next=6;break}return e.$message.warning("请输入要允许的端口"),t.abrupt("return");case 6:return t.prev=6,e.loadingPorts=!0,e.loadingAction=!0,t.next=11,e.allowInboundPortsAction({serverId:e.serverId,ports:e.portToAllow});case 11:if(r=t.sent,!r||!r.success){t.next=20;break}return e.$message.success("成功允许入网端口: ".concat(e.portToAllow)),e.portToAllow="",e.invalidateCache("inboundPorts"),t.next=18,e.refreshInboundPorts();case 18:t.next=21;break;case 20:e.$message.error((null===r||void 0===r?void 0:r.error)||"允许入网端口失败");case 21:t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](6),e.$message.error("允许入网端口错误: ".concat(t.t0.message));case 26:return t.prev=26,e.loadingPorts=!1,e.loadingAction=!1,t.finish(26);case 30:case"end":return t.stop()}}),t,null,[[6,23,26,30]])})))()})),"disallowPort",(function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(t.hasValidServerId){r.next=3;break}return t.$message.error("未指定服务器ID，无法执行取消放行操作"),r.abrupt("return");case 3:if(!t.isSshPort(e)){r.next=6;break}return t.$message.error("不能取消SSH端口的放行，这可能导致无法连接服务器"),r.abrupt("return");case 6:t.isCriticalPort(e)&&!t.isSshPort(e)?t.$confirm("端口".concat(e,"是常用服务端口，取消放行可能影响服务器某些功能。确定要继续吗?"),"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){t.executeDisallowPort(e)}))["catch"]((function(){t.$message.info("已取消操作")})):t.executeDisallowPort(e);case 7:case"end":return r.stop()}}),r)})))()})),"allowIP",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行允许入网操作"),t.abrupt("return");case 3:if(e.ipToAllow){t.next=6;break}return e.$message.warning("请输入要允许的IP地址"),t.abrupt("return");case 6:return t.prev=6,e.loadingIPs=!0,e.loadingAction=!0,t.next=11,e.allowInboundIPsAction({serverId:e.serverId,ips:e.ipToAllow});case 11:if(r=t.sent,!r||!r.success){t.next=20;break}return e.$message.success("成功允许入网IP: ".concat(e.ipToAllow)),e.ipToAllow="",e.invalidateCache("inboundIPs"),t.next=18,e.refreshInboundIPs();case 18:t.next=21;break;case 20:e.$message.error((null===r||void 0===r?void 0:r.error)||"允许入网IP失败");case 21:t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](6),e.$message.error("允许入网IP错误: ".concat(t.t0.message));case 26:return t.prev=26,e.loadingIPs=!1,e.loadingAction=!1,t.finish(26);case 30:case"end":return t.stop()}}),t,null,[[6,23,26,30]])})))()})),"confirmClearRules",(function(){var e=this;this.hasValidServerId?this.$confirm("此操作将清空所有防火墙规则，是否继续?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){e.clearAllRules()}))["catch"]((function(){e.$message({type:"info",message:"已取消清空操作"})})):this.$message.error("未指定服务器ID，无法执行清除规则操作")})),"clearAllRules",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行清除规则操作"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,e.loadingAction=!0,t.next=8,e.clearAllRulesAction(e.serverId);case 8:if(r=t.sent,!r||!r.success){t.next=17;break}return e.$message.success("成功清除所有规则"),t.next=13,e.clearServerCacheAfterChange();case 13:return t.next=15,e.refreshAllData();case 15:t.next=18;break;case 17:e.$message.error((null===r||void 0===r?void 0:r.error)||"清除所有规则失败");case 18:t.next=23;break;case 20:t.prev=20,t.t0=t["catch"](3),e.$message.error("清除所有规则错误: ".concat(t.t0.message));case 23:return t.prev=23,e.loading=!1,e.loadingAction=!1,t.finish(23);case 27:case"end":return t.stop()}}),t,null,[[3,20,23,27]])})))()})),(0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)(B,"deployIptatoManually",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行部署操作"),t.abrupt("return");case 3:return t.prev=3,e.deploying=!0,e.commandOutput="正在尝试手动部署脚本...\n",t.next=8,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:"wget -N --no-check-certificate https://raw.githubusercontent.com/Fiftonb/Gnftato/refs/heads/main/Nftato.sh && chmod +x Nftato.sh && bash Nftato.sh"});case 8:if(r=t.sent,!r||!r.success){t.next=37;break}return e.commandOutput+="手动部署命令执行成功，正在验证安装结果...\n",t.next=13,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:'test -f /root/Nftato.sh && echo "installed" || echo "not found"'});case 13:if(n=t.sent,!(n&&n.success&&n.data&&n.data.stdout&&n.data.stdout.includes("installed"))){t.next=33;break}return e.commandOutput+="脚本已成功安装!\n",e.$message.success("脚本手动部署成功"),e.initializationSteps[2].done=!0,e.initStepActive=3,t.next=21,e.clearServerCacheAfterChange();case 21:return t.next=23,e.refreshBlockList();case 23:return t.next=25,e.refreshSSHPort();case 25:return t.next=27,e.refreshInboundPorts();case 27:return t.next=29,e.refreshInboundIPs();case 29:e.initializationSteps[3].done=!0,e.isInitialized=!0,t.next=35;break;case 33:e.commandOutput+="脚本安装验证失败，请检查服务器环境或联系管理员\n",e.$message.error("脚本安装验证失败");case 35:t.next=39;break;case 37:e.commandOutput+="手动部署失败: ".concat((null===r||void 0===r?void 0:r.error)||"未知错误","\n"),e.$message.error("手动部署失败");case 39:t.next=45;break;case 41:t.prev=41,t.t0=t["catch"](3),e.commandOutput+="手动部署出错: ".concat(t.t0.message,"\n"),e.$message.error("手动部署出错: ".concat(t.t0.message));case 45:return t.prev=45,e.deploying=!1,t.finish(45);case 48:case"end":return t.stop()}}),t,null,[[3,41,45,48]])})))()})),"completeInitialization",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法完成初始化"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,e.commandOutput="正在加载规则信息...\n",t.next=8,e.clearServerCacheAfterChange();case 8:return t.next=10,e.refreshBlockList();case 10:return t.next=12,e.refreshSSHPort();case 12:return t.next=14,e.refreshInboundPorts();case 14:return t.next=16,e.refreshInboundIPs();case 16:e.initializationSteps[3].done=!0,e.isInitialized=!0,e.$message.success("初始化完成"),e.commandOutput+="初始化完成，可以开始管理防火墙规则",t.next=26;break;case 22:t.prev=22,t.t0=t["catch"](3),e.commandOutput+="\n初始化过程中加载规则出错: ".concat(t.t0.message),e.$message.error("加载规则失败: ".concat(t.t0.message));case 26:return t.prev=26,e.loading=!1,t.finish(26);case 29:case"end":return t.stop()}}),t,null,[[3,22,26,29]])})))()})),"clearCommandOutput",(function(){this.commandOutput=""})),"checkScriptExistence",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c,i,u,l,d,p,v;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法检查脚本"),t.abrupt("return");case 3:t.prev=3,e.debugging=!0,e.debugInfo="正在检查脚本存在状态...\n",r=["ls -la /root/Nftato.sh","ls -la /root/Nftato.sh",'find /root -name "*.sh" | grep -i Nftato','find / -name "*.sh" -type f -not -path "*/\\.*" | grep -i Nftato 2>/dev/null'],n=0,s=r;case 8:if(!(n<s.length)){t.next=30;break}return a=s[n],e.debugInfo+="\n执行命令: ".concat(a,"\n"),t.next=13,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:a});case 13:if(o=t.sent,!o||!o.success){t.next=26;break}if(u=(null===(c=o.data)||void 0===c?void 0:c.stdout)||"",l=(null===(i=o.data)||void 0===i?void 0:i.stderr)||"",e.debugInfo+="输出:\n".concat(u,"\n"),l&&(e.debugInfo+="错误:\n".concat(l,"\n")),!u||!u.includes("Nftato.sh")&&!u.includes("Nftato.sh")){t.next=24;break}return e.debugInfo+="\n检测到脚本存在！但前端应用未能识别。\n",e.debugInfo+="这可能是脚本命名不一致或路径不同导致的问题。\n",e.$message.warning("脚本已存在但应用无法识别，请参考调试信息"),t.abrupt("break",30);case 24:t.next=27;break;case 26:e.debugInfo+="命令执行失败: ".concat((null===o||void 0===o?void 0:o.error)||"未知错误","\n");case 27:n++,t.next=8;break;case 30:return e.debugInfo+="\n尝试直接执行脚本...\n",t.next=33,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:'cd /root && (./Nftato.sh --help || ./Nftato.sh --help || echo "无法执行脚本")'});case 33:d=t.sent,d&&d.success?(v=(null===(p=d.data)||void 0===p?void 0:p.stdout)||"",e.debugInfo+="执行脚本输出:\n".concat(v,"\n"),(v.includes("管理脚本")||v.includes("nftables"))&&(e.debugInfo+="\n脚本可以成功执行！\n",e.debugInfo+="建议使用手动初始化功能完成后续步骤。\n",e.$message.success("脚本可以成功执行，但需要手动初始化"))):e.debugInfo+="脚本执行失败: ".concat((null===d||void 0===d?void 0:d.error)||"未知错误","\n"),t.next=41;break;case 37:t.prev=37,t.t0=t["catch"](3),e.debugInfo+="\n检查过程出错: ".concat(t.t0.message,"\n"),e.$message.error("检查出错: ".concat(t.t0.message));case 41:return t.prev=41,e.debugging=!1,t.finish(41);case 44:case"end":return t.stop()}}),t,null,[[3,37,41,44]])})))()})),"testServerConnection",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c,i;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法测试连接"),t.abrupt("return");case 3:return t.prev=3,e.debugging=!0,e.debugInfo="正在测试服务器连接...\n",e.debugInfo+="1. 检查服务器信息:\n",t.next=9,e.getServer(e.serverId);case 9:return r=t.sent,r&&r.success?(e.debugInfo+="服务器信息: ".concat(JSON.stringify(r.data,null,2),"\n"),e.debugInfo+="连接状态: ".concat(r.data.status,"\n")):e.debugInfo+="获取服务器信息失败: ".concat((null===r||void 0===r?void 0:r.error)||"未知错误","\n"),e.debugInfo+="\n尝试重新连接服务器...\n",t.prev=12,t.next=15,e.connectServer(e.serverId);case 15:n=t.sent,n&&n.success?e.debugInfo+="服务器重新连接成功\n":e.debugInfo+="服务器重新连接失败: ".concat((null===n||void 0===n?void 0:n.error)||"未知错误","\n"),t.next=22;break;case 19:t.prev=19,t.t0=t["catch"](12),e.debugInfo+="重新连接出错: ".concat(t.t0.message,"\n");case 22:return e.debugInfo+="\n2. 执行简单命令测试:\n",t.next=25,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:"uname -a && whoami && pwd"});case 25:return s=t.sent,s&&s.success?(e.debugInfo+="命令输出:\n".concat((null===(a=s.data)||void 0===a?void 0:a.stdout)||"","\n"),e.debugInfo+="命令成功执行，服务器连接正常\n"):(e.debugInfo+="命令执行失败: ".concat((null===s||void 0===s?void 0:s.error)||"未知错误","\n"),e.debugInfo+="服务器连接可能存在问题\n"),e.debugInfo+="\n3. 检查前后端连接配置:\n",o={NODE_ENV:"production",BASE_URL:"/"}.VUE_APP_API_URL||window.location.origin,e.debugInfo+="API基础URL: ".concat(o,"\n"),e.debugInfo+="当前连接模式: ".concat("production","\n"),e.debugInfo+="\n4. 检查网络连接:\n",t.prev=32,t.next=35,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:"ping -c 3 8.8.8.8"});case 35:c=t.sent,c&&c.success?e.debugInfo+="ping测试结果:\n".concat((null===(i=c.data)||void 0===i?void 0:i.stdout)||"","\n"):e.debugInfo+="ping测试失败: ".concat((null===c||void 0===c?void 0:c.error)||"未知错误","\n"),t.next=42;break;case 39:t.prev=39,t.t1=t["catch"](32),e.debugInfo+="ping测试错误: ".concat(t.t1.message,"\n");case 42:e.$message.info("连接测试完成，请查看调试信息"),t.next=49;break;case 45:t.prev=45,t.t2=t["catch"](3),e.debugInfo+="\n测试过程出错: ".concat(t.t2.message,"\n"),e.$message.error("测试出错: ".concat(t.t2.message));case 49:return t.prev=49,e.debugging=!1,t.finish(49);case 52:case"end":return t.stop()}}),t,null,[[3,45,49,52],[12,19],[32,39]])})))()})),"resetConnectionState",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法重置状态"),t.abrupt("return");case 3:return t.prev=3,e.debugging=!0,e.debugInfo="正在重置连接状态...\n",t.prev=6,e.debugInfo+="尝试断开当前连接...\n",t.next=10,e.$store.dispatch("servers/executeCommand",{serverId:e.serverId,command:'echo "测试连接状态重置"'});case 10:r=t.sent,e.debugInfo+="断开连接测试命令执行结果: "+(null!==r&&void 0!==r&&r.success?"成功":"失败")+"\n",t.next=17;break;case 14:t.prev=14,t.t0=t["catch"](6),e.debugInfo+="断开连接测试出错: ".concat(t.t0.message,"\n");case 17:return e.debugInfo+="尝试重新连接服务器...\n",t.prev=18,t.next=21,e.connectServer(e.serverId);case 21:n=t.sent,n&&n.success?e.debugInfo+="服务器重新连接成功\n":e.debugInfo+="服务器重新连接失败: ".concat((null===n||void 0===n?void 0:n.error)||"未知错误","\n"),t.next=28;break;case 25:t.prev=25,t.t1=t["catch"](18),e.debugInfo+="重新连接出错: ".concat(t.t1.message,"\n");case 28:return e.resetInitSteps(),e.isInitialized=!1,e.initStepActive=0,t.next=33,e.checkInitialization();case 33:e.debugInfo+="初始化状态已重置，并重新检查\n",e.$message.success("连接状态已重置"),t.next=41;break;case 37:t.prev=37,t.t2=t["catch"](3),e.debugInfo+="\n重置过程出错: ".concat(t.t2.message,"\n"),e.$message.error("重置出错: ".concat(t.t2.message));case 41:return t.prev=41,e.debugging=!1,t.finish(41);case 44:case"end":return t.stop()}}),t,null,[[3,37,41,44],[6,14],[18,25]])})))()})),"manualInitialize",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法初始化"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,e.commandOutput="正在手动初始化...\n",e.initializationSteps.forEach((function(e){return e.done=!0})),e.isInitialized=!0,t.next=10,e.clearServerCacheAfterChange();case 10:return t.next=12,e.refreshBlockList();case 12:return t.next=14,e.refreshSSHPort();case 14:return t.next=16,e.refreshInboundPorts();case 16:return t.next=18,e.refreshInboundIPs();case 18:e.commandOutput+="手动初始化完成，已跳过脚本检查\n",e.$message.success("手动初始化完成"),t.next=26;break;case 22:t.prev=22,t.t0=t["catch"](3),e.commandOutput+="\n手动初始化失败: ".concat(t.t0.message,"\n"),e.$message.error("初始化失败: ".concat(t.t0.message));case 26:return t.prev=26,e.loading=!1,t.finish(26);case 29:case"end":return t.stop()}}),t,null,[[3,22,26,29]])})))()})),"generateManualCommands",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法生成命令"),t.abrupt("return");case 3:try{e.debugging=!0,e.debugInfo="以下是您可以直接在服务器上执行的命令：\n\n",e.debugInfo+="## 1. 部署Nftato脚本\n",e.debugInfo+="```\n",e.debugInfo+="cd ~ && wget -N --no-check-certificate https://raw.githubusercontent.com/Fiftonb/Gnftato/refs/heads/main/Nftato.sh && chmod +x Nftato.sh\n",e.debugInfo+="```\n\n",e.debugInfo+="## 2. 测试Nftato脚本\n",e.debugInfo+="```\n",e.debugInfo+="./Nftato.sh\n",e.debugInfo+="```\n\n",e.debugInfo+="## 3. 常用操作命令\n",e.debugInfo+="```\n",e.debugInfo+="# 阻止BT/PT流量\n",e.debugInfo+="./Nftato.sh 1\n\n",e.debugInfo+="# 解封BT/PT流量\n",e.debugInfo+="./Nftato.sh 11\n\n",e.debugInfo+="# 查看当前封禁列表\n",e.debugInfo+="./Nftato.sh 101\n",e.debugInfo+="```\n\n",e.debugInfo+="## 使用方法\n",e.debugInfo+="1. 通过SSH工具连接到您的服务器\n",e.debugInfo+="2. 复制并粘贴上述命令到SSH终端执行\n",e.debugInfo+='3. 执行完成后，返回此界面点击"跳过检查直接初始化"按钮\n\n',e.debugInfo+='如果您成功执行了这些命令，请点击页面上的"跳过检查直接初始化"按钮，这样可以绕过自动部署和检查过程，直接使用界面管理规则。\n',e.$message.success("已生成手动执行命令，请查看调试信息")}catch(r){e.debugInfo+="\n生成命令过程出错: ".concat(r.message,"\n"),e.$message.error("生成命令出错: ".concat(r.message))}finally{e.debugging=!1}case 4:case"end":return t.stop()}}),t)})))()})),"deployIptatoScript",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法执行部署操作"),t.abrupt("return");case 3:return t.prev=3,e.loadingDeployment=!0,e.commandOutput="正在部署脚本...\n",t.next=8,e.deployIptato(e.serverId);case 8:if(r=t.sent,!r||!r.success){t.next=18;break}return e.$message.success("脚本部署成功"),e.commandOutput+="\n脚本部署成功",t.next=14,e.clearServerCacheAfterChange();case 14:return t.next=16,e.refreshAllData();case 16:t.next=20;break;case 18:n=(null===r||void 0===r?void 0:r.error)||"脚本部署失败",n.includes("网络连接")?(e.commandOutput+="\n网络连接问题，请检查服务器网络设置",e.$message.error("网络连接问题，请检查服务器网络")):n.includes("权限")?(e.commandOutput+="\n权限不足，请确认SSH用户拥有root权限",e.$message.error("权限不足，请确认用户权限")):n.includes("500")||n.includes("内部错误")?(e.commandOutput+="\n服务器内部错误，可能原因：",e.commandOutput+="\n1. 服务器磁盘空间不足",e.commandOutput+="\n2. 服务器防火墙限制了文件上传",e.commandOutput+="\n3. 服务器缺少必要的依赖包",e.$message.error("服务器内部错误，请查看详细信息")):(e.$message.error("脚本部署失败: ".concat(n)),e.commandOutput+="\n脚本部署失败: ".concat(n));case 20:t.next=26;break;case 22:t.prev=22,t.t0=t["catch"](3),e.$message.error("脚本部署错误: ".concat(t.t0.message)),e.commandOutput+="\n脚本部署错误: ".concat(t.t0.message);case 26:return t.prev=26,e.loadingDeployment=!1,t.finish(26);case 29:case"end":return t.stop()}}),t,null,[[3,22,26,29]])})))()})),"isSshPort",(function(e){return!(!this.sshPort||this.sshPort!==parseInt(e,10))||(!(!this.server||this.server.port!==parseInt(e,10))||22===parseInt(e,10))})),(0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)(B,"startServerStatusCheck",(function(){var e=this;this.statusCheckTimer=setInterval((0,y.A)((0,$.A)().mark((function t(){var r,n,s;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.hasValidServerId){t.next=11;break}return t.prev=1,t.next=4,e.getServer(e.serverId);case 4:r=t.sent,r&&r.success&&(n=r.data.status,s=e.server?e.server.status:null,e.server=r.data,"online"!==s&&"online"===n&&e.$message.success("服务器已恢复在线状态"),"online"===s&&"online"!==n&&e.$message.warning("服务器已离线，无法管理防火墙规则")),t.next=11;break;case 8:t.prev=8,t.t0=t["catch"](1),console.error("检查服务器状态出错:",t.t0);case 11:case"end":return t.stop()}}),t,null,[[1,8]])}))),3e4)})),"stopServerStatusCheck",(function(){this.statusCheckTimer&&(clearInterval(this.statusCheckTimer),this.statusCheckTimer=null)})),"tryConnectServer",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法连接服务器"),t.abrupt("return");case 3:return t.prev=3,e.connecting=!0,e.commandOutput="正在尝试连接服务器...\n",t.next=8,e.connectServer(e.serverId);case 8:r=t.sent,r&&r.success?(e.$message.success("服务器连接成功"),e.commandOutput+="\n服务器连接成功"):(e.$message.error((null===r||void 0===r?void 0:r.error)||"连接服务器失败"),e.commandOutput+="\n连接服务器失败: ".concat((null===r||void 0===r?void 0:r.error)||"未知错误")),t.next=16;break;case 12:t.prev=12,t.t0=t["catch"](3),e.$message.error("连接服务器错误: ".concat(t.t0.message)),e.commandOutput+="\n连接服务器错误: ".concat(t.t0.message);case 16:return t.prev=16,e.connecting=!1,t.finish(16);case 19:case"end":return t.stop()}}),t,null,[[3,12,16,19]])})))()})),"invalidateCache",(function(e){if(e)try{this.cacheTimestamps[e]=0,this.dataCache[e]="inboundPorts"===e||"inboundIPs"===e?[]:null,console.log("缓存".concat(e,"已失效"))}catch(t){console.error("重置缓存".concat(e,"时出错:"),t),this.cacheTimestamps[e]=0,this.dataCache[e]="inboundPorts"===e||"inboundIPs"===e?[]:null}})),"loadServerCache",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n,s,a,o,c,i;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=2;break}return t.abrupt("return",!1);case 2:return t.prev=2,t.next=5,e.getCacheLastUpdate(e.serverId);case 5:if(r=t.sent,r.success){t.next=9;break}return console.log("服务器缓存不存在或无法访问"),t.abrupt("return",!1);case 9:return e.serverCacheLastUpdate=r.data.lastUpdate,e.serverCacheAvailable=!0,t.next=13,e.getServerCache(e.serverId);case 13:if(n=t.sent,n.success){t.next=16;break}return t.abrupt("return",!1);case 16:if(s=n.data,s.data.blockList&&(e.blockList=s.data.blockList,e.dataCache.blockList=s.data.blockList,e.cacheTimestamps.blockList=Date.now(),e.dataLoaded.blockList=!0),s.data.sshPortStatus){e.sshPortStatus=s.data.sshPortStatus,e.dataCache.sshPortStatus=s.data.sshPortStatus,e.cacheTimestamps.sshPortStatus=Date.now(),e.dataLoaded.sshPortStatus=!0;try{a=s.data.sshPortStatus,a&&"string"===typeof a&&(o=a.match(/SSH端口\s*[:：]\s*(\d+)/i)||a.match(/端口\s*[:：]\s*(\d+)/i)||a.match(/port\s*[:：]\s*(\d+)/i),o&&o[1]&&(e.sshPort=parseInt(o[1],10)))}catch(u){console.error("解析SSH端口数据出错:",u),e.server&&e.server.port&&(e.sshPort=e.server.port,console.log("使用服务器配置的端口: ".concat(e.sshPort)))}}return s.data.inboundPorts&&(c=s.data.inboundPorts,Array.isArray(c)?(i=c.map((function(e){return e.port})),e.dataCache.inboundPorts={tcp:i,udp:i}):c.tcp||c.udp?e.dataCache.inboundPorts=c:e.dataCache.inboundPorts={tcp:[],udp:[]},e.cacheTimestamps.inboundPorts=Date.now(),e.dataLoaded.inboundPorts=!0),s.data.inboundIPs&&(e.inboundIPs=Array.isArray(s.data.inboundIPs)?s.data.inboundIPs.map((function(e){return"string"===typeof e?{ip:e}:e})):[],e.dataCache.inboundIPs=e.inboundIPs,e.cacheTimestamps.inboundIPs=Date.now(),e.dataLoaded.inboundIPs=!0),console.log("已成功加载服务器缓存数据"),e.commandOutput="已加载缓存数据",t.abrupt("return",!0);case 26:return t.prev=26,t.t0=t["catch"](2),console.error("加载服务器缓存失败:",t.t0),t.abrupt("return",!1);case 30:case"end":return t.stop()}}),t,null,[[2,26]])})))()})),"clearServerCacheAfterChange",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=2;break}return t.abrupt("return");case 2:return t.prev=2,t.next=5,e.clearServerCache(e.serverId);case 5:e.serverCacheAvailable=!1,e.serverCacheLastUpdate=null,Object.keys(e.cacheTimestamps).forEach((function(t){e.cacheTimestamps[t]=0,e.dataCache[t]=null})),console.log("服务器和前端缓存已清除"),t.next=14;break;case 11:t.prev=11,t.t0=t["catch"](2),console.error("清除服务器缓存失败:",t.t0);case 14:case"end":return t.stop()}}),t,null,[[2,11]])})))()})),"updateServerCacheItem",(function(e,t){var r=this;return(0,y.A)((0,$.A)().mark((function n(){var s,a,o,c;return(0,$.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r.hasValidServerId){n.next=2;break}return n.abrupt("return");case 2:return n.prev=2,n.next=5,r.getServerCache(r.serverId);case 5:if(s=n.sent,!s||!s.success){n.next=15;break}return a=s.data,o=(0,i.A)({},a.data),o.data||(o.data={}),o.data[e]=t,n.next=13,r.$store.dispatch("rules/updateCacheItem",{serverId:r.serverId,key:e,value:t});case 13:c=n.sent,c&&c.success?console.log("服务器缓存项 ".concat(e," 已更新")):console.warn("更新服务器缓存项 ".concat(e," 失败"));case 15:n.next=20;break;case 17:n.prev=17,n.t0=n["catch"](2),console.error("更新服务器缓存项 ".concat(e," 出错:"),n.t0);case 20:r.invalidateCache(e);case 21:case"end":return n.stop()}}),n,null,[[2,17]])})))()})),"autoResetConnectionState",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=2;break}return t.abrupt("return",!1);case 2:return t.prev=2,e.commandOutput="正在自动重置连接状态...",e.loading=!0,t.next=7,e.connectServer(e.serverId);case 7:if(r=t.sent,!r||!r.success){t.next=17;break}return console.log("服务器重新连接成功"),t.next=12,e.getServer(e.serverId);case 12:return n=t.sent,n&&n.success&&(e.server=n.data),t.abrupt("return",!0);case 17:return console.warn("服务器重新连接失败，将尝试初始化过程"),t.abrupt("return",!1);case 19:t.next=25;break;case 21:return t.prev=21,t.t0=t["catch"](2),console.error("自动重置连接状态失败:",t.t0),t.abrupt("return",!1);case 25:return t.prev=25,e.loading=!1,t.finish(25);case 28:case"end":return t.stop()}}),t,null,[[2,21,25,28]])})))()})),"refreshDefenseStatus",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法获取防御状态"),t.abrupt("return");case 3:return t.prev=3,e.loadingDefenseStatus=!0,t.next=7,e.getDefenseStatus(e.serverId);case 7:r=t.sent,r&&r.success?(e.defenseStatus=r.data||"未启用",e.dataLoaded.defenseStatus=!0):(e.$message.warning((null===r||void 0===r?void 0:r.error)||"获取防御状态失败"),e.defenseStatus="未知"),t.next=15;break;case 11:t.prev=11,t.t0=t["catch"](3),e.$message.error("获取防御状态错误: ".concat(t.t0.message)),e.defenseStatus="错误";case 15:return t.prev=15,e.loadingDefenseStatus=!1,t.finish(15);case 18:case"end":return t.stop()}}),t,null,[[3,11,15,18]])})))()})),"showManageIpLists",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.ipListsDialogVisible=!0,e.ipManageResult="",e.ipListsActiveTab="addWhite",e.ipToManage="",e.ipDuration=0;case 5:case"end":return t.stop()}}),t)})))()})),(0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)(B,"addToWhitelist",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.ipToManage){t.next=3;break}return e.$message.warning("请输入IP地址"),t.abrupt("return");case 3:if(!e.isIpOperationDebounced(1,e.ipToManage)){t.next=5;break}return t.abrupt("return");case 5:return t.prev=5,console.log("[调试] 准备添加IP到白名单:",e.ipToManage),t.next=9,e.manageIP(1);case 9:t.next=15;break;case 11:t.prev=11,t.t0=t["catch"](5),console.error("[调试] 添加IP到白名单失败:",t.t0),e.$message.error("添加失败: ".concat(t.t0.message));case 15:case"end":return t.stop()}}),t,null,[[5,11]])})))()})),"addToBlacklist",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.ipToManage){t.next=3;break}return e.$message.warning("请输入IP地址"),t.abrupt("return");case 3:if(!e.isIpOperationDebounced(2,e.ipToManage)){t.next=5;break}return t.abrupt("return");case 5:return t.prev=5,console.log("[调试] 准备添加IP到黑名单:",e.ipToManage),t.next=9,e.manageIP(2);case 9:t.next=15;break;case 11:t.prev=11,t.t0=t["catch"](5),console.error("[调试] 添加IP到黑名单失败:",t.t0),e.$message.error("添加失败: ".concat(t.t0.message));case 15:case"end":return t.stop()}}),t,null,[[5,11]])})))()})),"removeFromWhitelist",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.ipToManage){t.next=3;break}return e.$message.warning("请输入IP地址"),t.abrupt("return");case 3:if(!e.isIpOperationDebounced(3,e.ipToManage)){t.next=5;break}return t.abrupt("return");case 5:return t.next=7,e.manageIP(3);case 7:case"end":return t.stop()}}),t)})))()})),"removeFromBlacklist",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.ipToManage){t.next=3;break}return e.$message.warning("请输入IP地址"),t.abrupt("return");case 3:if(!e.isIpOperationDebounced(4,e.ipToManage)){t.next=5;break}return t.abrupt("return");case 5:return t.next=7,e.manageIP(4);case 7:case"end":return t.stop()}}),t)})))()})),"isIpOperationDebounced",(function(e,t){var r=this;return this.ipOperationDebounce.cooldown&&this.ipOperationDebounce.lastAction===e&&this.ipOperationDebounce.lastIp===t?(this.$message.warning("操作过于频繁，请稍后再试"),!0):(this.ipOperationDebounce.lastAction=e,this.ipOperationDebounce.lastIp=t,this.ipOperationDebounce.cooldown=!0,this.ipOperationDebounce.timer&&clearTimeout(this.ipOperationDebounce.timer),this.ipOperationDebounce.timer=setTimeout((function(){r.ipOperationDebounce.cooldown=!1}),this.ipOperationDebounce.timeout),!1)})),"manageIP",(function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n,s,a;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,t.loading=!0,n={actionType:e,ip:t.ipToManage,duration:t.ipDuration||0},console.log("[调试] 准备发送IP操作请求: actionType=".concat(e,", ip=").concat(t.ipToManage,", duration=").concat(t.ipDuration||0)),console.log("[调试] 服务器ID: ".concat(t.serverId)),r.next=7,t.$store.dispatch("rules/manageIpLists",{serverId:t.serverId,data:n});case 7:if(s=r.sent,console.log("[调试] 收到响应:",s),!s||!s.success){r.next=28;break}a="",r.t0=e,r.next=1===r.t0?14:2===r.t0?16:3===r.t0?18:4===r.t0?20:22;break;case 14:return a="添加到白名单",r.abrupt("break",22);case 16:return a="添加到黑名单",r.abrupt("break",22);case 18:return a="从白名单移除",r.abrupt("break",22);case 20:return a="从黑名单移除",r.abrupt("break",22);case 22:return t.$message.success("IP ".concat(t.ipToManage," ").concat(a,"成功")),t.ipManageResult=s.data||"IP ".concat(t.ipToManage," ").concat(a,"成功"),r.next=26,t.refreshDefenseStatus();case 26:r.next=30;break;case 28:t.$message.error((null===s||void 0===s?void 0:s.error)||"IP管理操作失败"),t.ipManageResult="操作失败: ".concat((null===s||void 0===s?void 0:s.error)||"未知错误");case 30:r.next=36;break;case 32:r.prev=32,r.t1=r["catch"](0),t.$message.error("IP管理操作错误: ".concat(r.t1.message)),t.ipManageResult="操作错误: ".concat(r.t1.message);case 36:return r.prev=36,t.loading=!1,r.finish(36);case 39:case"end":return r.stop()}}),r,null,[[0,32,36,39]])})))()})),"setupDdosProtectionAction",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,e.loading=!0,t.next=4,e.setupDdosProtection(e.serverId);case 4:if(r=t.sent,!r||!r.success){t.next=12;break}return e.$message.success("DDoS防御规则配置成功"),e.commandOutput=r.data||"DDoS防御规则配置成功",t.next=10,e.refreshDefenseStatus();case 10:t.next=14;break;case 12:e.$message.error((null===r||void 0===r?void 0:r.error)||"配置DDoS防御规则失败"),e.commandOutput="配置失败: ".concat((null===r||void 0===r?void 0:r.error)||"未知错误");case 14:t.next=20;break;case 16:t.prev=16,t.t0=t["catch"](0),e.$message.error("配置DDoS防御规则错误: ".concat(t.t0.message)),e.commandOutput="配置错误: ".concat(t.t0.message);case 20:return t.prev=20,e.loading=!1,t.finish(20);case 23:case"end":return t.stop()}}),t,null,[[0,16,20,23]])})))()})),"setupCustomPortProtectionAction",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.customDdosPort){t.next=3;break}return e.$message.warning("请输入端口号"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,r={port:e.customDdosPort,protoType:e.customDdosProtoType,maxConn:e.customDdosMaxConn,maxRateMin:e.customDdosMaxRateMin,maxRateSec:e.customDdosMaxRateSec,banHours:e.customDdosBanHours},t.next=8,e.setupCustomPortProtection({serverId:e.serverId,data:r});case 8:if(n=t.sent,!n||!n.success){t.next=16;break}return e.$message.success("端口 ".concat(e.customDdosPort," DDoS防御配置成功")),e.commandOutput=n.data||"端口 ".concat(e.customDdosPort," DDoS防御配置成功"),t.next=14,e.refreshDefenseStatus();case 14:t.next=18;break;case 16:e.$message.error((null===n||void 0===n?void 0:n.error)||"配置自定义端口DDoS防御失败"),e.commandOutput="配置失败: ".concat((null===n||void 0===n?void 0:n.error)||"未知错误");case 18:t.next=24;break;case 20:t.prev=20,t.t0=t["catch"](3),e.$message.error("配置自定义端口DDoS防御错误: ".concat(t.t0.message)),e.commandOutput="配置错误: ".concat(t.t0.message);case 24:return t.prev=24,e.loading=!1,t.finish(24);case 27:case"end":return t.stop()}}),t,null,[[3,20,24,27]])})))()})),"showIpListsDialog",(function(){this.showManageIpLists()})),"isCriticalPort",(function(e){return this.criticalPorts.includes(parseInt(e,10))})),(0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)((0,U.A)(B,"executeDisallowPort",(function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){var n;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.prev=0,t.loadingPorts=!0,t.loadingAction=!0,r.next=5,t.disallowInboundPortsAction({serverId:t.serverId,ports:e.toString()});case 5:n=r.sent,n&&n.success?(t.$message.success("成功取消放行端口: ".concat(e)),t.dataCache.inboundPorts&&(t.dataCache.inboundPorts.tcp&&(t.dataCache.inboundPorts.tcp=t.dataCache.inboundPorts.tcp.filter((function(t){return t!==e}))),t.dataCache.inboundPorts.udp&&(t.dataCache.inboundPorts.udp=t.dataCache.inboundPorts.udp.filter((function(t){return t!==e}))),t.cacheTimestamps.inboundPorts=Date.now())):(t.$message.error((null===n||void 0===n?void 0:n.error)||"取消放行入网端口失败"),console.error("取消放行端口失败:",null===n||void 0===n?void 0:n.error)),r.next=13;break;case 9:r.prev=9,r.t0=r["catch"](0),t.$message.error("取消放行端口错误: ".concat(r.t0.message)),console.error("取消放行端口错误:",r.t0);case 13:return r.prev=13,t.loadingPorts=!1,t.loadingAction=!1,r.finish(13);case 17:case"end":return r.stop()}}),r,null,[[0,9,13,17]])})))()})),"refreshAllData",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.hasValidServerId){t.next=3;break}return e.$message.error("未指定服务器ID，无法刷新数据"),t.abrupt("return");case 3:return t.prev=3,e.loading=!0,t.next=7,Promise.all([e.refreshBlockList(),e.refreshSSHPort(),e.refreshInboundPorts(),e.refreshInboundIPs()]);case 7:e.$message.success("数据刷新成功"),t.next=13;break;case 10:t.prev=10,t.t0=t["catch"](3),e.$message.error("刷新数据失败: ".concat(t.t0.message));case 13:return t.prev=13,e.loading=!1,t.finish(13);case 16:case"end":return t.stop()}}),t,null,[[3,10,13,16]])})))()})),"refreshSelectedData",(function(){var e=arguments,t=this;return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(n=e.length>0&&void 0!==e[0]?e[0]:[],t.hasValidServerId){r.next=4;break}return t.$message.error("未指定服务器ID，无法刷新数据"),r.abrupt("return");case 4:if(n&&0!==n.length){r.next=6;break}return r.abrupt("return");case 6:return r.prev=6,s=[],n.includes("blockList")&&s.push(t.refreshBlockList()),n.includes("sshPortStatus")&&s.push(t.refreshSSHPort()),n.includes("inboundPorts")&&s.push(t.refreshInboundPorts()),n.includes("inboundIPs")&&s.push(t.refreshInboundIPs()),r.next=14,Promise.all(s);case 14:t.$nextTick((function(){if(n.includes("inboundPorts")){var e=(0,W.A)(t.inboundPorts);t.inboundPorts=[],t.$nextTick((function(){t.inboundPorts=e}))}if(n.includes("inboundIPs")){var r=(0,W.A)(t.inboundIPs);t.inboundIPs=[],t.$nextTick((function(){t.inboundIPs=r}))}})),r.next=20;break;case 17:r.prev=17,r.t0=r["catch"](6),console.error("刷新选定数据失败: ".concat(r.t0.message));case 20:case"end":return r.stop()}}),r,null,[[6,17]])})))()})),"isCacheValid",(function(e){var t=Date.now();return this.dataCache[e]&&t-this.cacheTimestamps[e]<this.cacheTTL[e]})),"initWebSocket",(function(){var e=this;this.socket&&this.socket.disconnect();var t=window.location.origin;console.log("尝试连接WebSocket:",t),this.socket=(0,j.Ay)(t,{transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3}),this.socket.on("connect",(function(){console.log("WebSocket已连接, ID:",e.socket.id),e.deployLogs.push({type:"log",message:"已建立实时部署连接..."}),e.scrollToBottom()})),this.socket.on("deploy_log",(function(t){console.log("收到部署日志:",t),t&&t.message&&(e.deployLogs.push({type:t.type||"log",message:t.message}),e.scrollToBottom())})),this.socket.on("deploy_complete",(function(t){console.log("部署完成:",t),e.deployComplete=!0,e.deploySuccess=t.success,t.success?(e.scriptExists=!0,e.deployLogs.push({type:"success",message:"部署成功完成！"}),setTimeout((function(){e.clearServerCacheAfterChange(),e.refreshAllData()}),1e3)):e.deployLogs.push({type:"error",message:"部署失败: ".concat(t.error||"未知错误")}),e.deploying=!1,e.scrollToBottom()})),this.socket.on("connect_error",(function(t){console.error("WebSocket连接错误:",t),e.deployLogs.push({type:"error",message:"实时连接错误: ".concat(t.message||"连接服务器失败")}),e.scrollToBottom()}))})),"deployIptatoWithWebSocket",(function(e){var t=this;return(0,y.A)((0,$.A)().mark((function r(){return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(r.prev=0,t.socket&&t.socket.connected){r.next=4;break}return r.next=4,new Promise((function(e){t.socket.on("connect",e),setTimeout(e,3e3)}));case 4:return console.log("发起WebSocket部署请求，服务器ID:",e),t.socket.emit("start_deploy",{serverId:e}),r.abrupt("return",{success:!0});case 9:return r.prev=9,r.t0=r["catch"](0),console.error("启动WebSocket部署失败:",r.t0),r.abrupt("return",{success:!1,error:r.t0.message});case 13:case"end":return r.stop()}}),r,null,[[0,9]])})))()})),"scrollToBottom",(function(){var e=this;this.$nextTick((function(){e.$refs.terminalBody&&(e.$refs.terminalBody.scrollTop=e.$refs.terminalBody.scrollHeight)}))})),"deployScript",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.isServerOnline){t.next=3;break}return e.$message.error("服务器离线，无法部署脚本"),t.abrupt("return");case 3:return t.prev=3,e.deploying=!0,e.deployLogs=[],e.deployComplete=!1,e.deploySuccess=!1,e.initWebSocket(),e.deployLogs.push({type:"log",message:"正在准备部署Nftato脚本..."}),t.next=12,e.deployIptatoWithWebSocket(e.serverId);case 12:if(r=t.sent,r&&r.success){t.next=15;break}throw new Error((null===r||void 0===r?void 0:r.error)||"开始部署过程失败");case 15:e.deployLogs.push({type:"log",message:"脚本部署已开始，正在执行..."}),t.next=26;break;case 18:t.prev=18,t.t0=t["catch"](3),e.deployComplete=!0,e.deploySuccess=!1,e.deploying=!1,e.deployLogs.push({type:"error",message:"部署失败: ".concat(t.t0.message)}),e.$message.error("部署脚本失败: ".concat(t.t0.message)),e.fallbackToNormalDeploy();case 26:case"end":return t.stop()}}),t,null,[[3,18]])})))()})),"fallbackToNormalDeploy",(function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,e.deployLogs.push({type:"log",message:"实时部署失败，尝试使用常规部署方法..."}),e.deploying=!0,t.next=5,e.deployIptato(e.serverId);case 5:r=t.sent,r&&r.success?(e.deployLogs.push({type:"success",message:"使用常规方法部署成功"}),e.deploySuccess=!0,e.scriptExists=!0,setTimeout((function(){e.clearServerCacheAfterChange(),e.refreshAllData()}),1e3)):e.deployLogs.push({type:"error",message:"常规部署也失败: ".concat((null===r||void 0===r?void 0:r.error)||"未知错误")}),t.next=12;break;case 9:t.prev=9,t.t0=t["catch"](0),e.deployLogs.push({type:"error",message:"常规部署错误: ".concat(t.t0.message)});case 12:return t.prev=12,e.deployComplete=!0,e.deploying=!1,t.finish(12);case 16:case"end":return t.stop()}}),t,null,[[0,9,12,16]])})))()})),"retryDeploy",(function(){this.deployLogs=[],this.deployComplete=!1,this.deploySuccess=!1,this.deployScript()})),(0,U.A)(B,"loadCachedData",(function(){if(this.dataCache.blockList&&(this.blockList=this.dataCache.blockList),this.dataCache.sshPortStatus){this.sshPortStatus=this.dataCache.sshPortStatus;try{if("string"===typeof this.dataCache.sshPortStatus){var e=this.dataCache.sshPortStatus.match(/SSH端口\s*[:：]\s*(\d+)/i)||this.dataCache.sshPortStatus.match(/端口\s*[:：]\s*(\d+)/i)||this.dataCache.sshPortStatus.match(/port\s*[:：]\s*(\d+)/i);e&&e[1]&&(this.sshPort=parseInt(e[1],10))}}catch(t){console.error("解析SSH端口出错:",t)}}this.dataCache.inboundPorts&&(this.inboundPorts=this.dataCache.inboundPorts),this.dataCache.inboundIPs&&(this.inboundIPs=this.dataCache.inboundIPs),console.log("已加载缓存数据"),this.commandOutput="已加载缓存数据"})))),watch:(0,U.A)({activeTab:function(e,t){var r=this;"outbound"!==e||this.dataLoaded.blockList?"inbound"===e?(this.dataLoaded.sshPortStatus||this.refreshSSHPort(),this.dataLoaded.inboundPorts||setTimeout((function(){return r.refreshInboundPorts()}),500),this.dataLoaded.inboundIPs||setTimeout((function(){return r.refreshInboundIPs()}),1e3)):"ddos"===e&&(this.dataLoaded.defenseStatus||this.refreshDefenseStatus()):this.refreshBlockList()},"server.status":function(e,t){"online"===e&&"online"!==t?this.refreshAllData():"online"!==e&&"online"===t&&this.$message.warning("服务器已离线，无法管理防火墙规则")},scriptExists:function(e){var t=this;e&&this.isServerOnline&&!this.dataLoaded&&(this.dataLoaded=!0,setTimeout((function(){t.refreshAllData()}),500))}},"server.status",(function(e){var t=this;"online"===e&&this.scriptExists&&!this.dataLoaded&&(this.dataLoaded=!0,setTimeout((function(){t.refreshAllData()}),500))}))},K=q;var G=(0,h.A)(K,M,z,!1,null,"56f4fa9c",null);const J=G.exports;r(25276);var Y=function(){var e=this,t=e._self._c;return t("div",{staticClass:"login-container"},[t("el-card",{staticClass:"login-card"},[t("div",{staticClass:"clearfix",attrs:{slot:"header"},slot:"header"},[t("h2",[e._v("Gnftato 防火墙管理系统")])]),t("el-form",{ref:"loginForm",attrs:{model:e.loginForm,rules:e.rules,"label-width":"80px"},nativeOn:{submit:function(t){return t.preventDefault(),e.handleLogin.apply(null,arguments)}}},[t("el-form-item",{attrs:{label:"用户名",prop:"username"}},[t("el-input",{attrs:{placeholder:"请输入用户名"},model:{value:e.loginForm.username,callback:function(t){e.$set(e.loginForm,"username",t)},expression:"loginForm.username"}})],1),t("el-form-item",{attrs:{label:"密码",prop:"password"}},[t("el-input",{attrs:{type:"password",placeholder:"请输入密码"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleLogin.apply(null,arguments)}},model:{value:e.loginForm.password,callback:function(t){e.$set(e.loginForm,"password",t)},expression:"loginForm.password"}})],1),t("el-form-item",[t("el-button",{attrs:{type:"primary",loading:e.loading},on:{click:e.handleLogin}},[e._v("登录")])],1)],1),t("div",{staticClass:"login-tip"},[t("small",[e._v("默认管理员账户：admin / admin123")])])],1)],1)},Q=[];const X={name:"Login",data:function(){return{loginForm:{username:"",password:""},rules:{username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]},loading:!1}},methods:(0,i.A)((0,i.A)({},(0,u.i0)(["login"])),{},{handleLogin:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.$refs.loginForm.validate();case 3:return e.loading=!0,t.next=6,e.login({username:e.loginForm.username,password:e.loginForm.password});case 6:e.$router.push("/"),e.$message.success("登录成功"),t.next=13;break;case 10:t.prev=10,t.t0=t["catch"](0),t.t0.response&&t.t0.response.data?e.$message.error(t.t0.response.data.message||"登录失败"):t.t0.response&&e.$message.error("登录失败，请稍后重试");case 13:return t.prev=13,e.loading=!1,t.finish(13);case 16:case"end":return t.stop()}}),t,null,[[0,10,13,16]])})))()}}),beforeRouteEnter:function(e,t,r){var n=localStorage.getItem("token");n?r("/"):r()}},Z=X;var ee=(0,h.A)(Z,Y,Q,!1,null,"4a046720",null);const te=ee.exports;var re=function(){var e=this,t=e._self._c;return t("div",{staticClass:"profile-container"},[t("div",{staticClass:"page-header"},[t("div",{staticClass:"header-content"},[t("h1",[e._v("个人资料")]),t("el-button",{attrs:{icon:"el-icon-back"},on:{click:e.goBack}},[e._v("返回")])],1)]),t("el-card",{staticClass:"profile-card"},[t("div",{staticClass:"clearfix",attrs:{slot:"header"},slot:"header"},[t("span",[e._v("账号信息")])]),t("div",{staticClass:"profile-info"},[t("p",[t("strong",[e._v("用户名:")]),e._v(" "+e._s(e.currentUser.username))]),t("p",[t("strong",[e._v("创建时间:")]),e._v(" "+e._s(e.formatDate(e.currentUser.createdAt)))])])]),t("el-card",{staticClass:"password-card"},[t("div",{staticClass:"clearfix",attrs:{slot:"header"},slot:"header"},[t("span",[e._v("修改密码")])]),t("change-password-form",{on:{"password-updated":e.onPasswordUpdated}})],1)],1)},ne=[],se=function(){var e=this,t=e._self._c;return t("el-form",{ref:"passwordForm",attrs:{model:e.passwordForm,rules:e.rules,"label-width":"120px"},nativeOn:{submit:function(e){e.preventDefault()}}},[t("el-form-item",{attrs:{label:"当前密码",prop:"currentPassword"}},[t("el-input",{attrs:{type:"password",placeholder:"请输入当前密码"},model:{value:e.passwordForm.currentPassword,callback:function(t){e.$set(e.passwordForm,"currentPassword",t)},expression:"passwordForm.currentPassword"}})],1),t("el-form-item",{attrs:{label:"新密码",prop:"newPassword"}},[t("el-input",{attrs:{type:"password",placeholder:"请输入新密码"},model:{value:e.passwordForm.newPassword,callback:function(t){e.$set(e.passwordForm,"newPassword",t)},expression:"passwordForm.newPassword"}})],1),t("el-form-item",{attrs:{label:"确认新密码",prop:"confirmPassword"}},[t("el-input",{attrs:{type:"password",placeholder:"请再次输入新密码"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSubmit.apply(null,arguments)}},model:{value:e.passwordForm.confirmPassword,callback:function(t){e.$set(e.passwordForm,"confirmPassword",t)},expression:"passwordForm.confirmPassword"}})],1),t("el-form-item",[t("el-button",{attrs:{type:"primary",loading:e.loading},on:{click:e.handleSubmit}},[e._v("修改密码")]),t("el-button",{on:{click:e.resetForm}},[e._v("重置")])],1)],1)},ae=[];const oe={name:"ChangePasswordForm",data:function(){var e=this,t=function(t,r,n){r!==e.passwordForm.newPassword?n(new Error("两次输入的密码不一致")):n()};return{passwordForm:{currentPassword:"",newPassword:"",confirmPassword:""},rules:{currentPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度至少为6个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请再次输入新密码",trigger:"blur"},{validator:t,trigger:"blur"}]},loading:!1}},methods:{handleSubmit:function(){var e=this;return(0,y.A)((0,$.A)().mark((function t(){var r;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.$refs.passwordForm.validate();case 3:return e.loading=!0,t.next=6,d().put("/api/auth/update-password",{currentPassword:e.passwordForm.currentPassword,newPassword:e.passwordForm.newPassword});case 6:r=t.sent,r.data.success&&(e.$message.success("密码修改成功"),e.resetForm(),e.$emit("password-updated")),t.next=13;break;case 10:t.prev=10,t.t0=t["catch"](0),t.t0.response&&t.t0.response.data?e.$message.error(t.t0.response.data.message||"密码修改失败"):t.t0.response&&e.$message.error("密码修改失败，请稍后重试");case 13:return t.prev=13,e.loading=!1,t.finish(13);case 16:case"end":return t.stop()}}),t,null,[[0,10,13,16]])})))()},resetForm:function(){this.$refs.passwordForm.resetFields()}}},ce=oe;var ie=(0,h.A)(ce,se,ae,!1,null,"94470f58",null);const ue=ie.exports,le={name:"Profile",components:{ChangePasswordForm:ue},computed:(0,i.A)({},(0,u.L8)(["currentUser"])),methods:{formatDate:function(e){if(!e)return"未知";var t=new Date(e);return t.toLocaleString()},onPasswordUpdated:function(){this.$message.success("密码已成功更新")},goBack:function(){this.$router.go(-1)}}},de=le;var pe=(0,h.A)(de,re,ne,!1,null,"57c75397",null);const ve=pe.exports;r(1688);var he="/api/servers",me={servers:[],loading:!1,error:null},fe={getAllServers:function(e){return e.servers},getServerById:function(e){return function(t){return e.servers.find((function(e){return e._id===t}))}},getLoading:function(e){return e.loading},getError:function(e){return e.error}},ge={getAllServers:function(e){return(0,y.A)((0,$.A)().mark((function t(){var r,n;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return r=e.commit,r("setLoading",!0),r("setError",null),t.prev=3,t.next=6,d().get(he);case 6:return n=t.sent,r("setServers",n.data.data),t.abrupt("return",n.data);case 11:throw t.prev=11,t.t0=t["catch"](3),r("setError",t.t0.response?t.t0.response.data.message:t.t0.message),t.t0;case 15:return t.prev=15,r("setLoading",!1),t.finish(15);case 18:case"end":return t.stop()}}),t,null,[[3,11,15,18]])})))()},getServer:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().get("".concat(he,"/").concat(t));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()},createServer:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=e.dispatch,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().post(he,t);case 6:return a=r.sent,r.next=9,s("getAllServers");case 9:return r.abrupt("return",a.data);case 12:throw r.prev=12,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 16:return r.prev=16,n("setLoading",!1),r.finish(16);case 19:case"end":return r.stop()}}),r,null,[[3,12,16,19]])})))()},updateServer:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o,c;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=e.dispatch,a=t.id,o=t.data,n("setLoading",!0),n("setError",null),r.prev=4,r.next=7,d().put("".concat(he,"/").concat(a),o);case 7:return c=r.sent,r.next=10,s("getAllServers");case 10:return r.abrupt("return",c.data);case 13:throw r.prev=13,r.t0=r["catch"](4),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 17:return r.prev=17,n("setLoading",!1),r.finish(17);case 20:case"end":return r.stop()}}),r,null,[[4,13,17,20]])})))()},deleteServer:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=e.dispatch,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d()["delete"]("".concat(he,"/").concat(t));case 6:return a=r.sent,r.next=9,s("getAllServers");case 9:return r.abrupt("return",a.data);case 12:throw r.prev=12,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 16:return r.prev=16,n("setLoading",!1),r.finish(16);case 19:case"end":return r.stop()}}),r,null,[[3,12,16,19]])})))()},connectServer:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=e.dispatch,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().post("".concat(he,"/").concat(t,"/connect"));case 6:if(a=r.sent,!a.data||!a.data.serverStatus){r.next=11;break}n("updateServerStatus",{id:t,status:a.data.serverStatus,lastCheck:(new Date).toISOString()}),r.next=13;break;case 11:return r.next=13,s("getAllServers");case 13:return r.abrupt("return",a.data);case 16:throw r.prev=16,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 20:return r.prev=20,n("setLoading",!1),r.finish(20);case 23:case"end":return r.stop()}}),r,null,[[3,16,20,23]])})))()},disconnectServer:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=e.dispatch,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().post("".concat(he,"/").concat(t,"/disconnect"));case 6:if(a=r.sent,!a.data||!a.data.serverStatus){r.next=11;break}n("updateServerStatus",{id:t,status:a.data.serverStatus,lastCheck:(new Date).toISOString()}),r.next=13;break;case 11:return r.next=13,s("getAllServers");case 13:return r.abrupt("return",a.data);case 16:throw r.prev=16,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 20:return r.prev=20,n("setLoading",!1),r.finish(20);case 23:case"end":return r.stop()}}),r,null,[[3,16,20,23]])})))()},checkStatus:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setError",null),r.prev=2,r.next=5,d().get("".concat(he,"/").concat(t,"/status"));case 5:return s=r.sent,s.data&&s.data.data&&(s.data.logs&&(s.data.logs.includes("连接套接字正常")||s.data.logs.includes("SSH连接已就绪")||s.data.logs.includes("SSH连接建立成功"))&&(s.data.data.status="online",s.data.data.backendConnected=!0),s.data.data.status&&n("updateServerStatus",{id:t,status:s.data.data.status,lastCheck:(new Date).toISOString(),backendConnected:s.data.data.backendConnected||!1})),r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](2),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:case"end":return r.stop()}}),r,null,[[2,10]])})))()},executeCommand:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=t.serverId,a=t.command,n("setLoading",!0),n("setError",null),r.prev=4,r.next=7,d().post("".concat(he,"/").concat(s,"/execute"),{command:a});case 7:return o=r.sent,r.abrupt("return",o.data);case 11:throw r.prev=11,r.t0=r["catch"](4),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 15:return r.prev=15,n("setLoading",!1),r.finish(15);case 18:case"end":return r.stop()}}),r,null,[[4,11,15,18]])})))()},deployIptato:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,e.dispatch,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().post("".concat(he,"/").concat(t,"/deploy"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()},getServerLogs:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setError",null),r.prev=2,r.next=5,d().get("".concat(he,"/").concat(t,"/logs"));case 5:return s=r.sent,r.abrupt("return",s.data);case 9:throw r.prev=9,r.t0=r["catch"](2),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 13:case"end":return r.stop()}}),r,null,[[2,9]])})))()},checkScriptExists:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setError",null),r.prev=2,r.next=5,d().get("".concat(he,"/").concat(t,"/checkScript"));case 5:return s=r.sent,r.abrupt("return",s.data);case 9:throw r.prev=9,r.t0=r["catch"](2),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 13:case"end":return r.stop()}}),r,null,[[2,9]])})))()},deployIptatoWithWebSocket:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().post("".concat(he,"/").concat(t,"/deploy"),{useWebSocket:!0});case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()}},be={setServers:function(e,t){e.servers=t},setLoading:function(e,t){e.loading=t},setError:function(e,t){e.error=t},updateServerStatus:function(e,t){var r=t.id,n=t.status,s=t.lastCheck,a=t.backendConnected,o=e.servers.find((function(e){return e._id===r}));o&&(o.status=n,o.lastCheck=s,o.backendConnected=a)}};const xe={namespaced:!0,state:me,getters:fe,actions:ge,mutations:be};var ke="/api/rules",Ie={loading:!1,error:null},we={getLoading:function(e){return e.loading},getError:function(e){return e.error}},Ae={getServerCache:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().get("".concat(ke,"/").concat(t,"/cache"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:if(r.prev=10,r.t0=r["catch"](3),!r.t0.response||404!==r.t0.response.status){r.next=14;break}return r.abrupt("return",{success:!1,error:"缓存不存在"});case 14:throw n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 16:return r.prev=16,n("setLoading",!1),r.finish(16);case 19:case"end":return r.stop()}}),r,null,[[3,10,16,19]])})))()},getCacheLastUpdate:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().get("".concat(ke,"/").concat(t,"/cache/last-update"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:if(r.prev=10,r.t0=r["catch"](3),!r.t0.response||404!==r.t0.response.status){r.next=14;break}return r.abrupt("return",{success:!1,error:"缓存不存在"});case 14:throw n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 16:return r.prev=16,n("setLoading",!1),r.finish(16);case 19:case"end":return r.stop()}}),r,null,[[3,10,16,19]])})))()},clearServerCache:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d()["delete"]("".concat(ke,"/").concat(t,"/cache"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()},updateCacheItem:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o,c;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=t.serverId,a=t.key,o=t.value,n("setLoading",!0),n("setError",null),r.prev=4,r.next=7,d().put("".concat(ke,"/").concat(s,"/cache/").concat(a),{value:o});case 7:return c=r.sent,r.abrupt("return",c.data);case 11:throw r.prev=11,r.t0=r["catch"](4),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 15:return r.prev=15,n("setLoading",!1),r.finish(15);case 18:case"end":return r.stop()}}),r,null,[[4,11,15,18]])})))()},getBlockList:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().get("".concat(ke,"/").concat(t,"/blocklist"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()},blockSPAMAction:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().post("".concat(ke,"/").concat(t,"/block/spam"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()},blockCustomPortsAction:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=t.serverId,a=t.ports,n("setLoading",!0),n("setError",null),r.prev=4,r.next=7,d().post("".concat(ke,"/").concat(s,"/block/ports"),{ports:a});case 7:return o=r.sent,r.abrupt("return",o.data);case 11:throw r.prev=11,r.t0=r["catch"](4),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 15:return r.prev=15,n("setLoading",!1),r.finish(15);case 18:case"end":return r.stop()}}),r,null,[[4,11,15,18]])})))()},unblockSPAMAction:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().post("".concat(ke,"/").concat(t,"/unblock/spam"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()},unblockCustomPortsAction:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=t.serverId,a=t.ports,n("setLoading",!0),n("setError",null),r.prev=4,r.next=7,d().post("".concat(ke,"/").concat(s,"/unblock/ports"),{ports:a});case 7:return o=r.sent,r.abrupt("return",o.data);case 11:throw r.prev=11,r.t0=r["catch"](4),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 15:return r.prev=15,n("setLoading",!1),r.finish(15);case 18:case"end":return r.stop()}}),r,null,[[4,11,15,18]])})))()},getInboundPorts:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().get("".concat(ke,"/").concat(t,"/inbound/ports"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()},getInboundIPs:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().get("".concat(ke,"/").concat(t,"/inbound/ips"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()},allowInboundPortsAction:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=t.serverId,a=t.ports,n("setLoading",!0),n("setError",null),r.prev=4,r.next=7,d().post("".concat(ke,"/").concat(s,"/inbound/allow/ports"),{ports:a});case 7:return o=r.sent,r.abrupt("return",o.data);case 11:throw r.prev=11,r.t0=r["catch"](4),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 15:return r.prev=15,n("setLoading",!1),r.finish(15);case 18:case"end":return r.stop()}}),r,null,[[4,11,15,18]])})))()},disallowInboundPortsAction:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=t.serverId,a=t.ports,n("setLoading",!0),n("setError",null),r.prev=4,r.next=7,d().post("".concat(ke,"/").concat(s,"/inbound/disallow/ports"),{ports:a});case 7:return o=r.sent,r.abrupt("return",o.data);case 11:throw r.prev=11,r.t0=r["catch"](4),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 15:return r.prev=15,n("setLoading",!1),r.finish(15);case 18:case"end":return r.stop()}}),r,null,[[4,11,15,18]])})))()},allowInboundIPsAction:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=t.serverId,a=t.ips,n("setLoading",!0),n("setError",null),r.prev=4,r.next=7,d().post("".concat(ke,"/").concat(s,"/inbound/allow/ips"),{ips:a});case 7:return o=r.sent,r.abrupt("return",o.data);case 11:throw r.prev=11,r.t0=r["catch"](4),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 15:return r.prev=15,n("setLoading",!1),r.finish(15);case 18:case"end":return r.stop()}}),r,null,[[4,11,15,18]])})))()},disallowInboundIPsAction:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=t.serverId,a=t.ips,n("setLoading",!0),n("setError",null),r.prev=4,r.next=7,d().post("".concat(ke,"/").concat(s,"/inbound/disallow/ips"),{ips:a});case 7:return o=r.sent,r.abrupt("return",o.data);case 11:throw r.prev=11,r.t0=r["catch"](4),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 15:return r.prev=15,n("setLoading",!1),r.finish(15);case 18:case"end":return r.stop()}}),r,null,[[4,11,15,18]])})))()},getSSHPort:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().get("".concat(ke,"/").concat(t,"/ssh-port"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()},clearAllRulesAction:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().post("".concat(ke,"/").concat(t,"/clear-all"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()},setupDdosProtection:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().post("".concat(ke,"/").concat(t,"/ddos/protection"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()},setupCustomPortProtection:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=t.serverId,a=t.data,n("setLoading",!0),n("setError",null),r.prev=4,r.next=7,d().post("".concat(ke,"/").concat(s,"/ddos/custom-port"),a);case 7:return o=r.sent,r.abrupt("return",o.data);case 11:throw r.prev=11,r.t0=r["catch"](4),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 15:return r.prev=15,n("setLoading",!1),r.finish(15);case 18:case"end":return r.stop()}}),r,null,[[4,11,15,18]])})))()},manageIpLists:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o,c;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,s=t.serverId,a=t.data,n("setLoading",!0),n("setError",null),console.log("[Store调试] 开始manageIpLists请求: serverId=".concat(s),a),r.prev=5,o="".concat(ke,"/").concat(s,"/ddos/ip-lists"),console.log("[Store调试] 请求端点: ".concat(o)),r.next=10,d().post(o,a);case 10:return c=r.sent,console.log("[Store调试] 收到响应:",c.data),r.abrupt("return",c.data);case 15:throw r.prev=15,r.t0=r["catch"](5),console.error("[Store调试] 请求错误:",r.t0),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 20:return r.prev=20,n("setLoading",!1),r.finish(20);case 23:case"end":return r.stop()}}),r,null,[[5,15,20,23]])})))()},getDefenseStatus:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("setLoading",!0),n("setError",null),r.prev=3,r.next=6,d().get("".concat(ke,"/").concat(t,"/ddos/status"));case 6:return s=r.sent,r.abrupt("return",s.data);case 10:throw r.prev=10,r.t0=r["catch"](3),n("setError",r.t0.response?r.t0.response.data.message:r.t0.message),r.t0;case 14:return r.prev=14,n("setLoading",!1),r.finish(14);case 17:case"end":return r.stop()}}),r,null,[[3,10,14,17]])})))()}},Se={setLoading:function(e,t){e.loading=t},setError:function(e,t){e.error=t}};const Pe={namespaced:!0,state:Ie,getters:we,actions:Ae,mutations:Se};var Ce={token:localStorage.getItem("token")||null,user:null,loading:!1},$e={isAuthenticated:function(e){return!!e.token},currentUser:function(e){return e.user},isLoading:function(e){return e.loading}},ye={login:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o,c;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,n("SET_LOADING",!0),r.prev=2,r.next=5,d().post("/api/auth/login",t);case 5:return s=r.sent,a=s.data.data,o=a.token,c=a.user,localStorage.setItem("token",o),n("SET_TOKEN",o),n("SET_USER",c),d().defaults.headers.common["Authorization"]="Bearer ".concat(o),r.abrupt("return",s);case 14:throw r.prev=14,r.t0=r["catch"](2),n("SET_TOKEN",null),n("SET_USER",null),localStorage.removeItem("token"),r.t0;case 20:return r.prev=20,n("SET_LOADING",!1),r.finish(20);case 23:case"end":return r.stop()}}),r,null,[[2,14,20,23]])})))()},register:function(e,t){return(0,y.A)((0,$.A)().mark((function r(){var n,s,a,o,c;return(0,$.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,e.dispatch,n("SET_LOADING",!0),r.prev=2,r.next=5,d().post("/api/auth/register",t);case 5:return s=r.sent,a=s.data.data,o=a.token,c=a.user,localStorage.setItem("token",o),n("SET_TOKEN",o),n("SET_USER",c),d().defaults.headers.common["Authorization"]="Bearer ".concat(o),r.abrupt("return",s);case 14:throw r.prev=14,r.t0=r["catch"](2),n("SET_TOKEN",null),n("SET_USER",null),localStorage.removeItem("token"),r.t0;case 20:return r.prev=20,n("SET_LOADING",!1),r.finish(20);case 23:case"end":return r.stop()}}),r,null,[[2,14,20,23]])})))()},getCurrentUser:function(e){return(0,y.A)((0,$.A)().mark((function t(){var r,n,s;return(0,$.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(r=e.commit,n=e.state,n.token){t.next=3;break}return t.abrupt("return");case 3:return r("SET_LOADING",!0),t.prev=4,t.next=7,d().get("/api/auth/me");case 7:return s=t.sent,r("SET_USER",s.data.data.user),t.abrupt("return",s);case 12:throw t.prev=12,t.t0=t["catch"](4),t.t0.response&&401===t.t0.response.status&&(r("SET_TOKEN",null),r("SET_USER",null),localStorage.removeItem("token")),t.t0;case 16:return t.prev=16,r("SET_LOADING",!1),t.finish(16);case 19:case"end":return t.stop()}}),t,null,[[4,12,16,19]])})))()},logout:function(e){var t=e.commit;t("SET_TOKEN",null),t("SET_USER",null),localStorage.removeItem("token"),delete d().defaults.headers.common["Authorization"]}},_e={SET_TOKEN:function(e,t){e.token=t},SET_USER:function(e,t){e.user=t},SET_LOADING:function(e,t){e.loading=t}};const De={state:Ce,getters:$e,actions:ye,mutations:_e};n["default"].use(u.Ay);const Te=new u.Ay.Store({modules:{servers:xe,rules:Pe,auth:De}});n["default"].use(g.Ay);var Le=[{path:"/",name:"home",component:A,meta:{requiresAuth:!0}},{path:"/servers",name:"servers",component:H,meta:{requiresAuth:!0}},{path:"/rules/:serverId",name:"rules",component:J,props:!0,meta:{requiresAuth:!0}},{path:"/profile",name:"profile",component:ve,meta:{requiresAuth:!0}},{path:"/login",name:"login",component:te}],Oe=new g.Ay({mode:"history",base:"/",routes:Le});Oe.beforeEach((function(e,t,r){var n=e.matched.some((function(e){return e.meta.requiresAuth})),s=Te.getters.isAuthenticated;n&&!s?r("/login"):r()}));const Ee=Oe;d().defaults.baseURL={NODE_ENV:"production",BASE_URL:"/"}.VUE_APP_API_URL||"",d().interceptors.response.use((function(e){return e}),(function(e){return e.response&&401===e.response.status&&(Te.dispatch("logout"),Ee.push("/login")),Promise.reject(e)}));var Re=localStorage.getItem("token");Re&&(d().defaults.headers.common["Authorization"]="Bearer ".concat(Re)),n["default"].prototype.$http=d(),n["default"].use(a()),n["default"].config.productionTip=!1,new n["default"]({router:Ee,store:Te,render:function(e){return e(f)}}).$mount("#app")}},t={};function r(n){var s=t[n];if(void 0!==s)return s.exports;var a=t[n]={id:n,loaded:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.loaded=!0,a.exports}r.m=e,(()=>{r.amdO={}})(),(()=>{var e=[];r.O=(t,n,s,a)=>{if(!n){var o=1/0;for(l=0;l<e.length;l++){for(var[n,s,a]=e[l],c=!0,i=0;i<n.length;i++)(!1&a||o>=a)&&Object.keys(r.O).every((e=>r.O[e](n[i])))?n.splice(i--,1):(c=!1,a<o&&(o=a));if(c){e.splice(l--,1);var u=s();void 0!==u&&(t=u)}}return t}a=a||0;for(var l=e.length;l>0&&e[l-1][2]>a;l--)e[l]=e[l-1];e[l]=[n,s,a]}})(),(()=>{r.n=e=>{var t=e&&e.__esModule?()=>e["default"]:()=>e;return r.d(t,{a:t}),t}})(),(()=>{r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}})(),(()=>{r.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()})(),(()=>{r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})(),(()=>{r.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}})(),(()=>{r.nmd=e=>(e.paths=[],e.children||(e.children=[]),e)})(),(()=>{var e={524:0};r.O.j=t=>0===e[t];var t=(t,n)=>{var s,a,[o,c,i]=n,u=0;if(o.some((t=>0!==e[t]))){for(s in c)r.o(c,s)&&(r.m[s]=c[s]);if(i)var l=i(r)}for(t&&t(n);u<o.length;u++)a=o[u],r.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return r.O(l)},n=self["webpackChunkNftato_panel_client"]=self["webpackChunkNftato_panel_client"]||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var n=r.O(void 0,[504],(()=>r(58794)));n=r.O(n)})();
//# sourceMappingURL=app.9f8a5f85.js.map